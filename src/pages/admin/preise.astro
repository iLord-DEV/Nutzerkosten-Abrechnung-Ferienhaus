---
import ProtectedLayout from '../../layouts/ProtectedLayout.astro';
import { requireAdmin } from '../../utils/auth';
import { PrismaClient } from '@prisma/client';

let uebernachtungspreise = [];
let preise = [];
let tankfuellungen = [];

// Admin-Berechtigung pr√ºfen
try {
  await requireAdmin(Astro);

  const prisma = new PrismaClient();

  // Hole alle Preise mit √úbernachtungspreisen (gueltigAb gesetzt), sortiert nach G√ºltigkeitsdatum
  uebernachtungspreise = await prisma.preise.findMany({
    where: {
      gueltigAb: {
        not: null
      }
    },
    orderBy: {
      gueltigAb: 'desc'
    }
  });

  // Hole nur die echten j√§hrlichen √ñlpreise (ohne gueltigAb), sortiert nach Jahr (neueste zuerst)
  preise = await prisma.preise.findMany({
    where: {
      gueltigAb: null
    },
    orderBy: {
      jahr: 'desc'
    }
  });

  // Hole alle Tankf√ºllungen f√ºr √ñlpreis-Historie (sortiert nach Z√§hlerstand)
  tankfuellungen = await prisma.tankfuellung.findMany({
    orderBy: {
      zaehlerstand: 'desc'
    },
    select: {
      id: true,
      datum: true,
      preisProLiter: true,
      liter: true,
      zaehlerstand: true
    }
  });

  await prisma.$disconnect();
} catch (error) {
  if (error instanceof Error && error.message === 'Keine Berechtigung') {
    return Astro.redirect('/login');
  }
  console.error('Fehler beim Laden der Daten:', error);
  // Fallback: Leere Arrays verwenden
}
---

<ProtectedLayout title="Preise verwalten - Nutzerkosten">
  <div class="content-wrapper">
    <div class="page-header">
      <h1 class="page-title mb-2">
        Preise verwalten
      </h1>
      <p class="page-description">
        Hier k√∂nnen Sie die √úbernachtungspreise und √ñlpreise verwalten.
        Der letzte erstellte √úbernachtungspreis gilt ab dem angegebenen Datum f√ºr alle zuk√ºnftigen Aufenthalte.
      </p>
    </div>

    <!-- √úbernachtungspreise -->
    <div class="card-container mb-8">
      <div class="pb-4 border-b border-base-300">
        <div class="flex justify-between items-center">
          <h2 class="text-xl font-semibold text-base-content">
            Aktuell g√ºltige √úbernachtungspreise
          </h2>
          <button
            onclick="window.openCreatePriceModal()"
            class="btn btn-primary"
          >
            Neuen Preis hinzuf√ºgen
          </button>
        </div>
      </div>
      
      <div class="overflow-x-auto">
        <table class="table">
          <thead>
            <tr>
              <th>G√ºltig ab</th>
              <th>Mitglied (‚Ç¨/Nacht)</th>
              <th>Gast (‚Ç¨/Nacht)</th>
              <th>Erstellt</th>
              <th>Aktionen</th>
            </tr>
          </thead>
          <tbody id="preiseTableBody">
            <!-- Wird durch JavaScript gef√ºllt -->
          </tbody>
        </table>
      </div>
    </div>

    <!-- √ñlpreise & Verbrauchswerte -->
    <div class="card-container">
      <div class="pb-4 border-b border-base-300">
        <div class="flex justify-between items-center">
          <h2 class="text-xl font-semibold text-base-content">
            √ñlpreise & Verbrauchswerte
          </h2>
          <p class="text-sm text-base-content" style="opacity: 0.7">
            Diese werden automatisch aus Tankf√ºllungen berechnet
          </p>
        </div>
      </div>

      <div class="overflow-x-auto">
        <table class="table">
          <thead>
            <tr>
              <th>G√ºltig ab (Z√§hlerstand/Jahr)</th>
              <th>Preis pro Liter (‚Ç¨/L)</th>
              <th>Getankte Menge / Verbrauch</th>
              <th>Quelle</th>
              <th>Zusatzinfo</th>
            </tr>
          </thead>
          <tbody>
            <!-- Tankf√ºllungen -->
            {tankfuellungen.map(tf => (
              <tr class="bg-info/10">
                <td class="font-medium">Ab Z√§hlerstand {tf.zaehlerstand.toFixed(0)}h</td>
                <td class="font-semibold">‚Ç¨ {tf.preisProLiter.toFixed(2)}</td>
                <td>{tf.liter.toFixed(0)} Liter getankt</td>
                <td><span class="badge badge-info">Tankf√ºllung</span></td>
                <td>Datum: {new Date(tf.datum).toLocaleDateString('de-DE')}</td>
              </tr>
            ))}

            <!-- Berechnete Jahrespreise -->
            {preise.map(preis => (
              <tr>
                <td>Jahr {preis.jahr}</td>
                <td>‚Ç¨ {preis.oelpreisProLiter.toFixed(2)}</td>
                <td>{preis.verbrauchProStunde.toFixed(1)} L/h</td>
                <td>
                  <span class={preis.istBerechnet ? 'badge badge-success' : 'badge badge-warning'}>
                    {preis.istBerechnet ? 'Berechnet' : 'Fallback'}
                  </span>
                </td>
                <td>√úbernachtung: 5‚Ç¨/10‚Ç¨</td>
              </tr>
            ))}

            {tankfuellungen.length === 0 && preise.length === 0 && (
              <tr>
                <td colspan="5" class="text-center opacity-70">
                  Keine Preise vorhanden. Fallback-Werte gelten: 1.01‚Ç¨/L, 5.5 L/h, 5‚Ç¨/10‚Ç¨
                </td>
              </tr>
            )}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Modal f√ºr neuen Preis -->
  <dialog id="createPriceModal" class="modal">
    <div class="modal-box">
      <h3 class="text-lg font-bold mb-4">Neuen √úbernachtungspreis hinzuf√ºgen</h3>
      <form id="createPriceForm" class="space-y-4">
        <div class="form-control">
          <label for="gueltigAb" class="label">
            <span class="label-text">G√ºltig ab</span>
          </label>
          <input type="date" id="gueltigAb" name="gueltigAb" required class="input input-bordered w-full">
        </div>
        <div class="form-control">
          <label for="uebernachtungMitglied" class="label">
            <span class="label-text">Preis Mitglied (‚Ç¨/Nacht)</span>
          </label>
          <input type="number" id="uebernachtungMitglied" name="uebernachtungMitglied" step="0.01" min="0" value="5" required class="input input-bordered w-full">
        </div>
        <div class="form-control">
          <label for="uebernachtungGast" class="label">
            <span class="label-text">Preis Gast (‚Ç¨/Nacht)</span>
          </label>
          <input type="number" id="uebernachtungGast" name="uebernachtungGast" step="0.01" min="0" value="10" required class="input input-bordered w-full">
        </div>
        <div class="modal-action">
          <button type="button" onclick="window.closeCreatePriceModal()" class="btn btn-ghost">Abbrechen</button>
          <button type="submit" class="btn btn-primary">Speichern</button>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- Modal f√ºr Preis bearbeiten -->
  <dialog id="editPriceModal" class="modal">
    <div class="modal-box">
      <h3 class="text-lg font-bold mb-4">√úbernachtungspreis bearbeiten</h3>
      <form id="editPriceForm" class="space-y-4">
        <input type="hidden" id="editPriceId" name="id">
        <div class="form-control">
          <label for="editGueltigAb" class="label">
            <span class="label-text">G√ºltig ab</span>
          </label>
          <input type="date" id="editGueltigAb" name="gueltigAb" required class="input input-bordered w-full">
        </div>
        <div class="form-control">
          <label for="editUebernachtungMitglied" class="label">
            <span class="label-text">Preis Mitglied (‚Ç¨/Nacht)</span>
          </label>
          <input type="number" id="editUebernachtungMitglied" name="uebernachtungMitglied" step="0.01" min="0" required class="input input-bordered w-full">
        </div>
        <div class="form-control">
          <label for="editUebernachtungGast" class="label">
            <span class="label-text">Preis Gast (‚Ç¨/Nacht)</span>
          </label>
          <input type="number" id="editUebernachtungGast" name="uebernachtungGast" step="0.01" min="0" required class="input input-bordered w-full">
        </div>
        <div class="modal-action">
          <button type="button" onclick="window.closeEditPriceModal()" class="btn btn-ghost">Abbrechen</button>
          <button type="submit" class="btn btn-primary">Aktualisieren</button>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
</ProtectedLayout>

<script>
  // Globale Variablen
  let allPreise = [];

  // Funktionen global verf√ºgbar machen
  window.openCreatePriceModal = openCreatePriceModal;
  window.closeCreatePriceModal = closeCreatePriceModal;
  window.openEditPriceModal = openEditPriceModal;
  window.closeEditPriceModal = closeEditPriceModal;
  window.editPrice = editPrice;
  window.deletePrice = deletePrice;

  // Modal √∂ffnen/schlie√üen
  function openCreatePriceModal() {
    // Heute als Standarddatum setzen
    (document.getElementById('gueltigAb') as HTMLInputElement).value = new Date().toISOString().split('T')[0];
    (document.getElementById('createPriceModal') as HTMLDialogElement).showModal();
  }

  function closeCreatePriceModal() {
    (document.getElementById('createPriceModal') as HTMLDialogElement).close();
    (document.getElementById('createPriceForm') as HTMLFormElement).reset();
  }

  function openEditPriceModal() {
    (document.getElementById('editPriceModal') as HTMLDialogElement).showModal();
  }

  function closeEditPriceModal() {
    (document.getElementById('editPriceModal') as HTMLDialogElement).close();
  }

  // Preise laden
  async function loadPreise() {
    try {
      const response = await fetch('/api/preise?alle=true');
      if (!response.ok) {
        throw new Error(`HTTP error! status: ${response.status}`);
      }
      allPreise = await response.json();
      console.log('üìä Geladene Preise:', allPreise);
      renderPreise();
    } catch (error) {
      console.error('‚ùå Fehler beim Laden der Preise:', error);
    }
  }

  // Preise rendern
  function renderPreise() {
    const tbody = document.getElementById('preiseTableBody');
    if (!tbody) return;

    if (allPreise.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="5" class="text-center opacity-70">
            Keine Preise konfiguriert. Fallback-Werte gelten: 5‚Ç¨ (Mitglieder), 10‚Ç¨ (G√§ste)
          </td>
        </tr>
      `;
      return;
    }

    tbody.innerHTML = allPreise.map(preis => `
      <tr>
        <td>${preis.gueltigAb ? new Date(preis.gueltigAb).toLocaleDateString('de-DE') : 'J√§hrlich'}</td>
        <td>‚Ç¨ ${preis.uebernachtungMitglied.toFixed(2)}</td>
        <td>‚Ç¨ ${preis.uebernachtungGast.toFixed(2)}</td>
        <td>${preis.createdAt ? new Date(preis.createdAt).toLocaleDateString('de-DE') : 'Unbekannt'}</td>
        <td>
          <button onclick="window.editPrice(${preis.jahr})" class="btn btn-ghost btn-xs">Bearbeiten</button>
          <button onclick="window.deletePrice(${preis.jahr})" class="btn btn-ghost btn-xs text-error">L√∂schen</button>
        </td>
      </tr>
    `).join('');
  }

  // Neuen Preis erstellen
  document.getElementById('createPriceForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
      gueltigAb: formData.get('gueltigAb'),
      uebernachtungMitglied: parseFloat(formData.get('uebernachtungMitglied')),
      uebernachtungGast: parseFloat(formData.get('uebernachtungGast'))
    };

    try {
      const response = await (window as any).csrfFetch('/api/preise', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          jahr: new Date(data.gueltigAb).getFullYear(),
          oelpreisProLiter: 1.01, // Fallback
          uebernachtungMitglied: data.uebernachtungMitglied,
          uebernachtungGast: data.uebernachtungGast,
          verbrauchProStunde: 5.5, // Fallback
          istBerechnet: false,
          gueltigAb: data.gueltigAb
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Fehler beim Erstellen des Preises');
      }

      alert('‚úÖ Preis erfolgreich erstellt!');
      closeCreatePriceModal();
      loadPreise();
    } catch (error) {
      console.error('‚ùå Fehler:', error);
      alert(`‚ùå Fehler: ${error.message}`);
    }
  });

  // Preis bearbeiten
  async function editPrice(jahr) {
    const preis = allPreise.find(p => p.jahr === jahr);
    if (!preis) return;

    // Formular mit aktuellen Werten f√ºllen
    document.getElementById('editPriceId').value = preis.jahr;
    document.getElementById('editGueltigAb').value = preis.gueltigAb.split('T')[0];
    document.getElementById('editUebernachtungMitglied').value = preis.uebernachtungMitglied;
    document.getElementById('editUebernachtungGast').value = preis.uebernachtungGast;

    openEditPriceModal();
  }

  // Preis aktualisieren
  document.getElementById('editPriceForm').addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const formData = new FormData(e.target);
    const data = {
      id: parseInt(formData.get('id')),
      gueltigAb: formData.get('gueltigAb'),
      uebernachtungMitglied: parseFloat(formData.get('uebernachtungMitglied')),
      uebernachtungGast: parseFloat(formData.get('uebernachtungGast'))
    };

    try {
      const response = await (window as any).csrfFetch(`/api/preise?jahr=${new Date(data.gueltigAb).getFullYear()}`, {
        method: 'PUT',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          uebernachtungMitglied: data.uebernachtungMitglied,
          uebernachtungGast: data.uebernachtungGast,
          gueltigAb: data.gueltigAb
        })
      });

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Fehler beim Aktualisieren des Preises');
      }

      alert('‚úÖ Preis erfolgreich aktualisiert!');
      closeEditPriceModal();
      loadPreise();
    } catch (error) {
      console.error('‚ùå Fehler:', error);
      alert(`‚ùå Fehler: ${error.message}`);
    }
  });

  // Preis l√∂schen
  async function deletePrice(jahr) {
    if (!confirm('Sind Sie sicher, dass Sie diesen Preis l√∂schen m√∂chten?')) {
      return;
    }

    try {
      const preis = allPreise.find(p => p.jahr === jahr);
      if (!preis) return;
      
      const response = await (window as any).csrfFetch(`/api/preise?jahr=${preis.jahr}`, {
        method: 'DELETE'
      });

      if (response.status === 404) {
        alert('‚ÑπÔ∏è Preis wurde bereits gel√∂scht oder existiert nicht.');
        loadPreise();
        return;
      }

      if (!response.ok) {
        const errorData = await response.json();
        throw new Error(errorData.error || 'Fehler beim L√∂schen des Preises');
      }

      alert('‚úÖ Preis erfolgreich gel√∂scht!');
      loadPreise();
    } catch (error) {
      console.error('‚ùå Fehler:', error);
      alert(`‚ùå Fehler: ${error.message}`);
    }
  }

  // Seite laden
  document.addEventListener('DOMContentLoaded', () => {
    loadPreise();
  });
</script>
