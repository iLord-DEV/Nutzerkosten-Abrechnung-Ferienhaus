---
import ProtectedLayout from '../../layouts/ProtectedLayout.astro';
import { requireAdmin } from '../../utils/auth';

try {
  await requireAdmin(Astro);
} catch (error) {
  return Astro.redirect('/login');
}
---

<ProtectedLayout title="Wissensdatenbank - Nutzerkosten">
  <div class="section-container">
    <div class="page-header">
      <div class="flex items-center justify-between flex-wrap gap-4">
        <div>
          <h1 class="page-title">Wissensdatenbank</h1>
          <p class="page-description">
            Verwalte Informationen f√ºr den KI-Chatbot (Ger√§te, Anleitungen, FAQ)
          </p>
        </div>
        <div class="flex space-x-3">
          <a href="/admin/dashboard" class="btn btn-ghost">
            ‚Üê Dashboard
          </a>
          <a href="/admin/bildbibliothek" class="btn btn-outline">
            üñºÔ∏è Bildbibliothek
          </a>
          <button onclick="openUploadModal()" class="btn btn-secondary">
            üìÑ Datei hochladen
          </button>
          <button onclick="openCreateModal()" class="btn btn-primary">
            ‚ûï Neuer Eintrag
          </button>
        </div>
      </div>
    </div>

    <!-- Filter -->
    <div class="card-container mb-6">
      <div class="flex items-center gap-4 flex-wrap">
        <div class="form-control">
          <label class="label">
            <span class="label-text">Kategorie</span>
          </label>
          <select id="category-filter" class="select select-bordered" onchange="filterByCategory()">
            <option value="">Alle Kategorien</option>
          </select>
        </div>
        <div class="form-control">
          <label class="label cursor-pointer gap-3">
            <input type="checkbox" id="active-filter" class="checkbox checkbox-primary checkbox-sm" checked onchange="loadEntries()" />
            <span class="label-text">Nur aktive</span>
          </label>
        </div>
        <div class="ml-auto text-sm text-base-content/60" id="entry-count">
          0 Eintr√§ge
        </div>
      </div>
    </div>

    <!-- Eintr√§ge Liste -->
    <div class="space-y-4" id="entries-list">
      <div class="text-center py-8 text-base-content/60">Lade Eintr√§ge...</div>
    </div>
  </div>

  <!-- Create/Edit Modal -->
  <dialog id="entry-modal" class="modal">
    <div class="modal-box max-w-2xl">
      <h3 class="font-bold text-lg mb-4" id="modal-title">Neuer Eintrag</h3>
      <form id="entry-form" class="space-y-4">
        <input type="hidden" id="entry-id" />

        <div class="grid grid-cols-2 gap-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text">Kategorie *</span>
            </label>
            <input type="text" id="entry-category" list="category-suggestions"
              class="input input-bordered" required placeholder="z.B. Heizung, WLAN, K√ºche" />
            <datalist id="category-suggestions"></datalist>
          </div>
          <div class="form-control">
            <label class="label">
              <span class="label-text">Titel *</span>
            </label>
            <input type="text" id="entry-title" class="input input-bordered" required
              placeholder="z.B. Bedienung der Heizung" />
          </div>
        </div>

        <div class="form-control">
          <label class="label">
            <span class="label-text">Inhalt *</span>
          </label>
          <textarea id="entry-content" class="textarea textarea-bordered h-48" required
            placeholder="Beschreibung, Anleitung oder Information..."></textarea>
        </div>

        <div class="form-control">
          <label class="label">
            <span class="label-text">Suchbegriffe (optional)</span>
          </label>
          <input type="text" id="entry-keywords" class="input input-bordered"
            placeholder="Komma-getrennt: Thermostat, Temperatur, Warm" />
        </div>

        <!-- Bilder-Sektion (nur bei Bearbeitung sichtbar) -->
        <div id="images-section" class="hidden">
          <label class="label">
            <span class="label-text">Bilder</span>
          </label>
          <div id="images-gallery" class="flex flex-wrap gap-3 mb-3">
            <!-- Bilder werden hier dynamisch eingef√ºgt -->
          </div>
          <div class="flex gap-2">
            <label class="btn btn-outline btn-sm cursor-pointer">
              <span>+ Bild hinzuf√ºgen</span>
              <input type="file" id="image-upload-input" accept="image/jpeg,image/png,image/gif,image/webp" multiple class="hidden" />
            </label>
            <span class="text-xs text-base-content/50 self-center">JPEG, PNG, GIF, WebP (max. 5MB)</span>
          </div>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text">Priorit√§t</span>
            </label>
            <select id="entry-priority" class="select select-bordered w-full">
              <option value="0">Normal</option>
              <option value="1">üìå Wichtig</option>
              <option value="2">‚ö†Ô∏è Sehr wichtig (hat Vorrang)</option>
            </select>
            <label class="label">
              <span class="label-text-alt text-base-content/60">H√∂here Priorit√§t = wird vom Chatbot bevorzugt</span>
            </label>
          </div>
          <div class="form-control">
            <label class="label">
              <span class="label-text">Status</span>
            </label>
            <div class="flex items-center gap-3 h-12 px-3 bg-base-200 rounded-lg">
              <input type="checkbox" id="entry-active" class="checkbox checkbox-primary" checked />
              <span class="label-text">Aktiv (f√ºr Chatbot sichtbar)</span>
            </div>
            <span class="text-sm text-base-content/60 mt-2" id="entry-source"></span>
          </div>
        </div>

        <div class="modal-action pt-4 border-t border-base-300">
          <button type="button" class="btn btn-ghost" onclick="closeEntryModal()">Abbrechen</button>
          <button type="submit" class="btn btn-primary">Speichern</button>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- Upload Modal -->
  <dialog id="upload-modal" class="modal">
    <div class="modal-box max-w-2xl">
      <h3 class="font-bold text-lg mb-4">Datei hochladen</h3>

      <div id="upload-dropzone"
        class="border-2 border-dashed border-base-300 rounded-lg p-8 text-center cursor-pointer hover:border-primary transition-colors">
        <div class="text-4xl mb-2">üìÑ</div>
        <p class="text-base-content/70">PDF, Markdown oder Text-Datei hier ablegen</p>
        <p class="text-sm text-base-content/50 mt-1">oder klicken zum Ausw√§hlen</p>
        <input type="file" id="file-input" accept=".pdf,.md,.markdown,.txt" class="hidden" />
      </div>

      <div id="upload-preview" class="hidden mt-4">
        <div class="alert alert-info mb-4">
          <span id="upload-filename"></span>
          <span id="upload-info" class="text-sm"></span>
        </div>

        <div class="form-control mb-4">
          <label class="label">
            <span class="label-text">Vorschau des extrahierten Texts</span>
          </label>
          <textarea id="upload-text-preview" class="textarea textarea-bordered h-32" readonly></textarea>
        </div>

        <div class="grid grid-cols-2 gap-4">
          <div class="form-control">
            <label class="label">
              <span class="label-text">Kategorie *</span>
            </label>
            <input type="text" id="upload-category" list="category-suggestions"
              class="input input-bordered" required />
          </div>
          <div class="form-control">
            <label class="label">
              <span class="label-text">Titel *</span>
            </label>
            <input type="text" id="upload-title" class="input input-bordered" required />
          </div>
        </div>
      </div>

      <div class="modal-action pt-4 border-t border-base-300">
        <button type="button" class="btn btn-ghost" onclick="closeUploadModal()">Abbrechen</button>
        <button type="button" id="upload-save-btn" class="btn btn-primary hidden" onclick="saveUpload()">
          Speichern
        </button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- Delete Confirmation Modal -->
  <dialog id="delete-modal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg">Eintrag l√∂schen?</h3>
      <p class="py-4">M√∂chtest du den Eintrag "<span id="delete-title"></span>" wirklich l√∂schen?</p>
      <input type="hidden" id="delete-id" />
      <div class="modal-action pt-4 border-t border-base-300">
        <button class="btn btn-ghost" onclick="closeDeleteModal()">Abbrechen</button>
        <button class="btn btn-error" onclick="confirmDelete()">L√∂schen</button>
      </div>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>
</ProtectedLayout>

<script>
  let entries: any[] = [];
  let categories: string[] = [];
  let uploadedText: string = '';
  let currentEntryImages: any[] = [];
  let currentEntryId: number | null = null;

  document.addEventListener('DOMContentLoaded', () => {
    loadCategories();
    loadEntries();
    setupDropzone();
    setupForm();
    setupImageUpload();
  });

  async function loadCategories() {
    try {
      const response = await fetch('/api/admin/knowledge-base/categories');
      if (response.ok) {
        categories = await response.json();
        updateCategoryFilter();
        updateCategorySuggestions();
      }
    } catch (error) {
      console.error('Fehler beim Laden der Kategorien:', error);
    }
  }

  function updateCategoryFilter() {
    const select = document.getElementById('category-filter') as HTMLSelectElement;
    select.innerHTML = '<option value="">Alle Kategorien</option>';
    categories.forEach(cat => {
      select.innerHTML += `<option value="${cat}">${cat}</option>`;
    });
  }

  function updateCategorySuggestions() {
    const datalist = document.getElementById('category-suggestions') as HTMLDataListElement;
    datalist.innerHTML = categories.map(cat => `<option value="${cat}">`).join('');
  }

  async function loadEntries() {
    const categoryFilter = (document.getElementById('category-filter') as HTMLSelectElement).value;
    const activeOnly = (document.getElementById('active-filter') as HTMLInputElement).checked;

    const params = new URLSearchParams();
    if (categoryFilter) params.append('category', categoryFilter);
    if (activeOnly) params.append('activeOnly', 'true');

    try {
      const response = await fetch(`/api/admin/knowledge-base?${params}`);
      if (response.ok) {
        entries = await response.json();
        renderEntries();
      }
    } catch (error) {
      console.error('Fehler beim Laden der Eintr√§ge:', error);
    }
  }

  function filterByCategory() {
    loadEntries();
  }

  function renderEntries() {
    const list = document.getElementById('entries-list')!;
    const countEl = document.getElementById('entry-count')!;

    countEl.textContent = `${entries.length} Eintr√§ge`;

    if (entries.length === 0) {
      list.innerHTML = `
        <div class="text-center py-8 text-base-content/60">
          Keine Eintr√§ge gefunden. Erstelle einen neuen Eintrag oder lade eine Datei hoch.
        </div>
      `;
      return;
    }

    // Nach Kategorie gruppieren
    const grouped: Record<string, any[]> = {};
    entries.forEach(entry => {
      if (!grouped[entry.category]) {
        grouped[entry.category] = [];
      }
      grouped[entry.category].push(entry);
    });

    list.innerHTML = Object.entries(grouped).map(([category, items]) => `
      <div class="card-container">
        <h3 class="font-semibold text-lg mb-3 flex items-center gap-2">
          <span class="badge badge-primary">${category}</span>
          <span class="text-sm text-base-content/60">${items.length} Eintr√§ge</span>
        </h3>
        <div class="space-y-2">
          ${items.map(entry => `
            <div class="flex items-center justify-between p-3 bg-base-200 rounded-lg ${!entry.isActive ? 'opacity-50' : ''} ${entry.priority >= 2 ? 'border-l-4 border-warning' : entry.priority === 1 ? 'border-l-4 border-info' : ''}">
              <div class="flex-1 min-w-0">
                <div class="flex items-center gap-2">
                  ${entry.priority >= 2 ? '<span class="text-warning">‚ö†Ô∏è</span>' : entry.priority === 1 ? '<span class="text-info">üìå</span>' : ''}
                  <span class="font-medium truncate">${entry.title}</span>
                  ${entry.sourceType !== 'manual' ? `
                    <span class="badge badge-sm badge-ghost">${entry.sourceType === 'upload' ? 'üìÑ' : 'üåê'}</span>
                  ` : ''}
                  ${!entry.isActive ? '<span class="badge badge-sm badge-warning">Inaktiv</span>' : ''}
                </div>
                <p class="text-sm text-base-content/60 truncate">${entry.content.substring(0, 100)}...</p>
              </div>
              <div class="flex items-center gap-2 ml-4">
                <button class="btn btn-ghost btn-sm" onclick="editEntry(${entry.id})">
                  ‚úèÔ∏è
                </button>
                <button class="btn btn-ghost btn-sm text-error" onclick="deleteEntry(${entry.id}, '${entry.title.replace(/'/g, "\\'")}')">
                  üóëÔ∏è
                </button>
              </div>
            </div>
          `).join('')}
        </div>
      </div>
    `).join('');
  }

  function openCreateModal() {
    (document.getElementById('modal-title') as HTMLElement).textContent = 'Neuer Eintrag';
    (document.getElementById('entry-id') as HTMLInputElement).value = '';
    (document.getElementById('entry-category') as HTMLInputElement).value = '';
    (document.getElementById('entry-title') as HTMLInputElement).value = '';
    (document.getElementById('entry-content') as HTMLTextAreaElement).value = '';
    (document.getElementById('entry-keywords') as HTMLInputElement).value = '';
    (document.getElementById('entry-priority') as HTMLSelectElement).value = '0';
    (document.getElementById('entry-active') as HTMLInputElement).checked = true;
    (document.getElementById('entry-source') as HTMLElement).textContent = '';
    // Bilder-Sektion ausblenden f√ºr neue Eintr√§ge
    (document.getElementById('images-section') as HTMLElement).classList.add('hidden');
    currentEntryId = null;
    currentEntryImages = [];
    (document.getElementById('entry-modal') as HTMLDialogElement).showModal();
  }

  async function editEntry(id: number) {
    // Vollst√§ndigen Eintrag vom Server laden (inkl. Bilder)
    try {
      const response = await fetch(`/api/admin/knowledge-base/${id}`);
      if (!response.ok) {
        alert('Fehler beim Laden des Eintrags');
        return;
      }
      const entry = await response.json();

      (document.getElementById('modal-title') as HTMLElement).textContent = 'Eintrag bearbeiten';
      (document.getElementById('entry-id') as HTMLInputElement).value = String(id);
      (document.getElementById('entry-category') as HTMLInputElement).value = entry.category;
      (document.getElementById('entry-title') as HTMLInputElement).value = entry.title;
      (document.getElementById('entry-content') as HTMLTextAreaElement).value = entry.content;
      (document.getElementById('entry-keywords') as HTMLInputElement).value = entry.keywords || '';
      (document.getElementById('entry-priority') as HTMLSelectElement).value = String(entry.priority || 0);
      (document.getElementById('entry-active') as HTMLInputElement).checked = entry.isActive;

      let sourceInfo = '';
      if (entry.sourceType === 'upload' && entry.fileName) {
        sourceInfo = `üìÑ Hochgeladen: ${entry.fileName}`;
      } else if (entry.sourceType === 'web' && entry.sourceUrl) {
        sourceInfo = `üåê Web: ${entry.sourceUrl}`;
      }
      (document.getElementById('entry-source') as HTMLElement).textContent = sourceInfo;

      // Bilder-Sektion anzeigen und laden
      currentEntryId = id;
      currentEntryImages = entry.images || [];
      (document.getElementById('images-section') as HTMLElement).classList.remove('hidden');
      renderImagesGallery();

      (document.getElementById('entry-modal') as HTMLDialogElement).showModal();
    } catch (error) {
      console.error('Fehler:', error);
      alert('Fehler beim Laden des Eintrags');
    }
  }

  function closeEntryModal() {
    (document.getElementById('entry-modal') as HTMLDialogElement).close();
  }

  function setupForm() {
    document.getElementById('entry-form')?.addEventListener('submit', async (e) => {
      e.preventDefault();

      const id = (document.getElementById('entry-id') as HTMLInputElement).value;
      const data = {
        category: (document.getElementById('entry-category') as HTMLInputElement).value,
        title: (document.getElementById('entry-title') as HTMLInputElement).value,
        content: (document.getElementById('entry-content') as HTMLTextAreaElement).value,
        keywords: (document.getElementById('entry-keywords') as HTMLInputElement).value || null,
        priority: parseInt((document.getElementById('entry-priority') as HTMLSelectElement).value) || 0,
        isActive: (document.getElementById('entry-active') as HTMLInputElement).checked,
      };

      try {
        const url = id ? `/api/admin/knowledge-base/${id}` : '/api/admin/knowledge-base';
        const method = id ? 'PUT' : 'POST';

        const response = await fetch(url, {
          method,
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data),
        });

        if (response.ok) {
          closeEntryModal();
          loadCategories();
          loadEntries();
        } else {
          const error = await response.json();
          alert(error.error || 'Fehler beim Speichern');
        }
      } catch (error) {
        console.error('Fehler:', error);
        alert('Fehler beim Speichern');
      }
    });
  }

  function deleteEntry(id: number, title: string) {
    (document.getElementById('delete-id') as HTMLInputElement).value = String(id);
    (document.getElementById('delete-title') as HTMLElement).textContent = title;
    (document.getElementById('delete-modal') as HTMLDialogElement).showModal();
  }

  function closeDeleteModal() {
    (document.getElementById('delete-modal') as HTMLDialogElement).close();
  }

  async function confirmDelete() {
    const id = (document.getElementById('delete-id') as HTMLInputElement).value;

    try {
      const response = await fetch(`/api/admin/knowledge-base/${id}`, {
        method: 'DELETE',
      });

      if (response.ok) {
        closeDeleteModal();
        loadCategories();
        loadEntries();
      } else {
        alert('Fehler beim L√∂schen');
      }
    } catch (error) {
      console.error('Fehler:', error);
      alert('Fehler beim L√∂schen');
    }
  }

  // Upload Functions
  function openUploadModal() {
    resetUploadModal();
    (document.getElementById('upload-modal') as HTMLDialogElement).showModal();
  }

  function closeUploadModal() {
    (document.getElementById('upload-modal') as HTMLDialogElement).close();
    resetUploadModal();
  }

  function resetUploadModal() {
    (document.getElementById('upload-preview') as HTMLElement).classList.add('hidden');
    (document.getElementById('upload-save-btn') as HTMLElement).classList.add('hidden');
    (document.getElementById('file-input') as HTMLInputElement).value = '';
    uploadedText = '';
  }

  function setupDropzone() {
    const dropzone = document.getElementById('upload-dropzone')!;
    const fileInput = document.getElementById('file-input') as HTMLInputElement;

    dropzone.addEventListener('click', () => fileInput.click());

    dropzone.addEventListener('dragover', (e) => {
      e.preventDefault();
      dropzone.classList.add('border-primary', 'bg-primary/5');
    });

    dropzone.addEventListener('dragleave', () => {
      dropzone.classList.remove('border-primary', 'bg-primary/5');
    });

    dropzone.addEventListener('drop', (e) => {
      e.preventDefault();
      dropzone.classList.remove('border-primary', 'bg-primary/5');
      const files = (e as DragEvent).dataTransfer?.files;
      if (files?.length) {
        handleFile(files[0]);
      }
    });

    fileInput.addEventListener('change', () => {
      if (fileInput.files?.length) {
        handleFile(fileInput.files[0]);
      }
    });
  }

  async function handleFile(file: File) {
    const formData = new FormData();
    formData.append('file', file);

    try {
      const response = await fetch('/api/admin/knowledge-base/upload', {
        method: 'POST',
        body: formData,
      });

      if (response.ok) {
        const result = await response.json();

        (document.getElementById('upload-filename') as HTMLElement).textContent = result.fileName;
        (document.getElementById('upload-info') as HTMLElement).textContent =
          `${result.pageCount} Seite(n), ${result.textLength} Zeichen`;
        (document.getElementById('upload-text-preview') as HTMLTextAreaElement).value = result.preview;
        (document.getElementById('upload-title') as HTMLInputElement).value =
          result.info?.title || file.name.replace(/\.[^/.]+$/, '');

        uploadedText = result.fullText;

        (document.getElementById('upload-preview') as HTMLElement).classList.remove('hidden');
        (document.getElementById('upload-save-btn') as HTMLElement).classList.remove('hidden');
      } else {
        const error = await response.json();
        alert(error.error || 'Fehler beim Verarbeiten der Datei');
      }
    } catch (error) {
      console.error('Fehler:', error);
      alert('Fehler beim Hochladen');
    }
  }

  async function saveUpload() {
    const category = (document.getElementById('upload-category') as HTMLInputElement).value;
    const title = (document.getElementById('upload-title') as HTMLInputElement).value;

    if (!category || !title) {
      alert('Bitte Kategorie und Titel angeben');
      return;
    }

    try {
      const response = await fetch('/api/admin/knowledge-base', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          category,
          title,
          content: uploadedText,
          sourceType: 'upload',
          fileName: (document.getElementById('upload-filename') as HTMLElement).textContent,
        }),
      });

      if (response.ok) {
        closeUploadModal();
        loadCategories();
        loadEntries();
      } else {
        const error = await response.json();
        alert(error.error || 'Fehler beim Speichern');
      }
    } catch (error) {
      console.error('Fehler:', error);
      alert('Fehler beim Speichern');
    }
  }

  // === Bild-Funktionen ===
  function setupImageUpload() {
    const imageInput = document.getElementById('image-upload-input') as HTMLInputElement;
    imageInput?.addEventListener('change', async () => {
      if (!currentEntryId || !imageInput.files?.length) return;

      const formData = new FormData();
      for (const file of imageInput.files) {
        formData.append('images', file);
      }

      try {
        const response = await fetch(`/api/admin/knowledge-base/${currentEntryId}/images`, {
          method: 'POST',
          body: formData,
        });

        if (response.ok) {
          const newImages = await response.json();
          currentEntryImages = [...currentEntryImages, ...newImages];
          renderImagesGallery();
        } else {
          const error = await response.json();
          alert(error.error || 'Fehler beim Hochladen');
        }
      } catch (error) {
        console.error('Fehler:', error);
        alert('Fehler beim Hochladen');
      }

      imageInput.value = '';
    });
  }

  function renderImagesGallery() {
    const gallery = document.getElementById('images-gallery')!;

    if (currentEntryImages.length === 0) {
      gallery.innerHTML = '<div class="text-sm text-base-content/50">Keine Bilder vorhanden</div>';
      return;
    }

    gallery.innerHTML = currentEntryImages.map((img, index) => `
      <div class="relative group" data-image-id="${img.id}">
        <img
          src="/uploads/knowledge/${img.fileName}"
          alt="${img.alt || img.originalName}"
          class="w-24 h-24 object-cover rounded-lg border border-base-300"
        />
        <button
          type="button"
          onclick="deleteImage(${img.id})"
          class="absolute -top-2 -right-2 btn btn-circle btn-xs btn-error opacity-0 group-hover:opacity-100 transition-opacity"
        >
          ‚úï
        </button>
        <div class="absolute bottom-0 left-0 right-0 bg-black/50 text-white text-xs p-1 rounded-b-lg truncate">
          ${img.alt || img.originalName}
        </div>
      </div>
    `).join('');
  }

  async function deleteImage(imageId: number) {
    if (!currentEntryId) return;
    if (!confirm('Bild wirklich l√∂schen?')) return;

    try {
      const response = await fetch(`/api/admin/knowledge-base/${currentEntryId}/images?imageId=${imageId}`, {
        method: 'DELETE',
      });

      if (response.ok) {
        currentEntryImages = currentEntryImages.filter(img => img.id !== imageId);
        renderImagesGallery();
      } else {
        alert('Fehler beim L√∂schen');
      }
    } catch (error) {
      console.error('Fehler:', error);
      alert('Fehler beim L√∂schen');
    }
  }

  // Global functions for onclick handlers
  (window as any).openCreateModal = openCreateModal;
  (window as any).openUploadModal = openUploadModal;
  (window as any).closeEntryModal = closeEntryModal;
  (window as any).closeUploadModal = closeUploadModal;
  (window as any).closeDeleteModal = closeDeleteModal;
  (window as any).editEntry = editEntry;
  (window as any).deleteEntry = deleteEntry;
  (window as any).confirmDelete = confirmDelete;
  (window as any).saveUpload = saveUpload;
  (window as any).filterByCategory = filterByCategory;
  (window as any).loadEntries = loadEntries;
  (window as any).deleteImage = deleteImage;
</script>
