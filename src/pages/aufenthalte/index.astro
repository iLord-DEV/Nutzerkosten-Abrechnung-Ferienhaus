---
import ProtectedLayout from '../../layouts/ProtectedLayout.astro';
import Card from '../../components/ui/Card.astro';

// Zugriffskontrolle
const sessionCookie = Astro.cookies.get('session');
if (!sessionCookie) {
  return Astro.redirect('/login');
}

const session = JSON.parse(sessionCookie.value);
---

<ProtectedLayout title="Aufenthalte - Nutzerkosten">
  <div class="container mx-auto px-4 py-6 max-w-7xl">
    <!-- Header -->
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between mb-8 gap-4">
      <div>
        <h1 class="text-3xl font-bold mb-2">
          {session.role === 'ADMIN' ? 'Alle Aufenthalte' : 'Meine Aufenthalte'}
        </h1>
        <p class="text-base-content/70">
          {session.role === 'ADMIN'
            ? '√úbersicht aller Aufenthalte und √úberlappungsberechnung.'
            : '√úbersicht deiner Aufenthalte und Kostenberechnung.'}
        </p>
        <!-- Bezahlt-Status -->
        <div id="user-bezahlt-status" class="mt-2" style="display: none;">
          <!-- Bezahlt: Gr√ºner Badge -->
          <span id="bezahlt-badge" class="badge badge-success gap-2 hidden">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span id="bezahlt-text"></span>
          </span>
          <!-- Unbezahlt: Roter Button -->
          <button id="bezahlen-btn" class="btn btn-error hidden border-4 border-error px-6 py-3" onclick="bezahlen_modal.showModal()">
            <span id="bezahlen-btn-text">Jahr bezahlen</span>
          </button>
        </div>
      </div>
      <div>
        <a href="/aufenthalte/neu" class="btn btn-primary text-primary-content gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
          Neuer Aufenthalt
        </a>
      </div>
    </div>

    <!-- Filter und Suche -->
    <Card title="Filter" className="mb-6">
      <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
        <div class="form-control w-full">
          <label class="label" for="jahr">
            <span class="label-text">Jahr</span>
          </label>
          <select id="jahr" class="select select-bordered w-full">
            <!-- Wird dynamisch geladen -->
          </select>
        </div>
        <div class="form-control w-full">
          <label class="label" for="status">
            <span class="label-text">Status</span>
          </label>
          <select id="status" class="select select-bordered w-full">
            <option value="">Alle</option>
            <option value="aktiv">Aktiv</option>
            <option value="abgeschlossen">Abgeschlossen</option>
          </select>
        </div>
        {session.role === 'ADMIN' && (
          <div class="form-control w-full">
            <label class="label" for="benutzer">
              <span class="label-text flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                </svg>
                Benutzer
              </span>
            </label>
            <select id="benutzer" class="select select-bordered w-full">
              <option value="">Alle Benutzer</option>
              <!-- Wird dynamisch geladen -->
            </select>
          </div>
        )}
      </div>
    </Card>



    <!-- Aufenthalte-Tabelle -->
    <Card className="w-full overflow-x-auto">
      <div class="w-full">
        <table class="table table-zebra w-full">
          <thead>
            <tr>
              {session.role === 'ADMIN' && <th>Benutzer</th>}
              <th>Zeitraum</th>
              <th>Z√§hlerstand</th>
              <th>Gesamtkosten</th>
              <th class="w-8"></th>
            </tr>
          </thead>
          <tbody id="aufenthalte-tbody">
            <!-- Wird dynamisch geladen -->
          </tbody>
        </table>
      </div>

      <!-- Lade-Animation -->
      <div id="loading" class="text-center py-12">
        <span class="loading loading-spinner loading-lg text-primary"></span>
        <p class="mt-4 text-base-content/70">Lade Aufenthalte...</p>
      </div>

      <!-- Keine Daten -->
      <div id="no-data" class="hidden text-center py-12">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mx-auto mb-4 text-base-content/30">
          <path stroke-linecap="round" stroke-linejoin="round" d="M20.25 7.5l-.625 10.632a2.25 2.25 0 01-2.247 2.118H6.622a2.25 2.25 0 01-2.247-2.118L3.75 7.5M10 11.25h4M3.375 7.5h17.25c.621 0 1.125-.504 1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125z" />
        </svg>
        <p class="text-lg font-medium text-base-content/70">Keine Aufenthalte gefunden</p>
        <p id="no-data-hint" class="mt-1 text-base-content/50">Erstellen Sie Ihren ersten Aufenthalt.</p>
      </div>
    </Card>

    <!-- Admin: Bezahlt-Status f√ºr abgeschlossene Jahre -->
    {session.role === 'ADMIN' && (
      <Card title="Bezahlt-Status verwalten" className="mt-6" id="admin-bezahlt-card" style="display: none;">
        <p class="text-sm text-base-content/70 mb-4">
          Markiere Benutzer als bezahlt f√ºr das abgeschlossene Jahr <span id="bezahlt-jahr-display" class="font-semibold"></span>
        </p>
        <div class="overflow-x-auto">
          <table class="table table-zebra w-full">
            <thead>
              <tr>
                <th>Benutzer</th>
                <th>E-Mail</th>
                <th class="text-center">Bezahlt</th>
              </tr>
            </thead>
            <tbody id="bezahlt-tbody">
              <!-- Wird dynamisch gef√ºllt -->
            </tbody>
          </table>
        </div>
      </Card>
    )}

    <!-- Toast-Benachrichtigung -->
    <div id="toast" class="toast toast-top toast-end hidden">
      <div class="alert" id="toast-alert">
        <div class="flex items-center gap-2">
          <div id="toast-icon">
            <!-- Icon wird dynamisch gesetzt -->
          </div>
          <span id="toast-message"></span>
        </div>
        <button id="toast-close" class="btn btn-sm btn-ghost btn-circle">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
        </button>
      </div>
    </div>

    <!-- Best√§tigungs-Modal -->
    <dialog id="confirm-modal" class="modal">
      <div class="modal-box">
        <div class="flex items-start gap-4 mb-4">
          <div class="flex-shrink-0">
            <div class="bg-error/20 rounded-full p-3">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6 text-error">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 9v3.75m-9.303 3.376c-.866 1.5.217 3.374 1.948 3.374h14.71c1.73 0 2.813-1.874 1.948-3.374L13.949 3.378c-.866-1.5-3.032-1.5-3.898 0L2.697 16.126zM12 15.75h.007v.008H12v-.008z" />
              </svg>
            </div>
          </div>
          <div class="flex-1">
            <h3 class="font-bold text-lg mb-2">Aufenthalt l√∂schen</h3>
            <p class="text-base-content/70">
              M√∂chten Sie diesen Aufenthalt wirklich l√∂schen? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden.
            </p>
          </div>
        </div>
        <div class="modal-action">
          <button id="cancel-delete" class="btn btn-ghost">Abbrechen</button>
          <button id="confirm-delete" class="btn btn-error">L√∂schen</button>
        </div>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>

    <!-- Bezahlen Modal -->
    <dialog id="bezahlen_modal" class="modal">
      <div class="modal-box">
        <h3 class="font-bold text-lg mb-4">Jahresabschluss bezahlen</h3>

        <div class="space-y-4">
          <div>
            <p class="text-sm font-semibold mb-1">Betrag</p>
            <p class="text-2xl font-bold text-primary" id="modal-kosten">-</p>
          </div>

          <div class="divider"></div>

          <div>
            <p class="text-sm font-semibold mb-2">Bankverbindung</p>
            <div class="bg-base-200 p-4 rounded-lg space-y-2">
              <div class="flex justify-between items-center">
                <span class="text-sm opacity-70">Bank:</span>
                <span class="font-medium">Commerzbank</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm opacity-70">IBAN:</span>
                <span class="font-mono font-medium">DE97 2308 0040 0312 0600 00</span>
              </div>
              <div class="flex justify-between items-center">
                <span class="text-sm opacity-70">BIC:</span>
                <span class="font-mono font-medium">DRESDEFF230</span>
              </div>
            </div>
          </div>

          <div>
            <p class="text-sm font-semibold mb-2">Verwendungszweck</p>
            <div class="bg-base-200 p-4 rounded-lg">
              <p class="font-mono" id="modal-betreff">Jahresabschluss 2024</p>
            </div>
          </div>

          <div class="divider">oder</div>

          <!-- QR-Code f√ºr Banking-App -->
          <div class="text-center">
            <p class="text-sm font-semibold mb-3">Mit Banking-App scannen</p>
            <div class="flex justify-center">
              <div id="qr-code-container" class="bg-white p-4 rounded-lg inline-block">
                <div id="qr-code-loading" class="flex items-center justify-center w-[300px] h-[300px]">
                  <span class="loading loading-spinner loading-lg"></span>
                </div>
                <img id="qr-code-image" src="" alt="QR-Code" class="hidden w-[300px] h-[300px]" />
              </div>
            </div>
            <p class="text-xs opacity-70 mt-2">Alle Daten werden automatisch √ºbernommen</p>
          </div>
        </div>

        <div class="modal-action">
          <form method="dialog">
            <button class="btn">Schlie√üen</button>
          </form>
        </div>
      </div>
      <form method="dialog" class="modal-backdrop">
        <button>close</button>
      </form>
    </dialog>

    <!-- Session-Info f√ºr JavaScript -->
    <script id="session-data" type="application/json" set:html={JSON.stringify({ isAdmin: session.role === 'ADMIN' })} />
  </div>
</ProtectedLayout>

<script>
  import { berechneOelkostenNachZaehlerstand } from '../../utils/kostenberechnung';
  import { isJahrAbgeschlossen, canEditJahr, formatJahrMitStatus } from '../../utils/jahresabschluss';
  import { generateGiroCodeQR } from '../../utils/giroCode';

  let isAdminUser = false;

  let currentAufenthalte: Array<{
    id: number;
    userId: number;
    ankunft: string;
    abreise: string;
    zaehlerAnkunft: number;
    zaehlerAbreise: number;
    anzahlMitglieder: number;
    anzahlGaeste: number;
    jahr: number;
    user: { name: string; email: string; role: string };
  }> = [];

  let currentPreise: {
    oelpreisProLiter?: number;
    uebernachtungMitglied?: number;
    uebernachtungGast?: number;
    verbrauchProStunde?: number;
  } = {};

  let alleAufenthalte: any[] = [];

  // Toast-Benachrichtigung anzeigen
  function showToast(message: string, type: 'success' | 'error' | 'info' = 'info') {
    const toast = document.getElementById('toast');
    const toastAlert = document.getElementById('toast-alert');
    const toastMessage = document.getElementById('toast-message');
    const toastIcon = document.getElementById('toast-icon');

    if (!toast || !toastAlert || !toastMessage || !toastIcon) return;

    // Nachricht setzen
    toastMessage.textContent = message;

    // Icon und CSS-Klassen je nach Typ setzen
    let iconSvg = '';
    let alertClass = 'alert';

    switch (type) {
      case 'success':
        alertClass = 'alert alert-success';
        iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
        break;
      case 'error':
        alertClass = 'alert alert-error';
        iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
        break;
      case 'info':
      default:
        alertClass = 'alert alert-info';
        iconSvg = `<svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z" /></svg>`;
        break;
    }

    toastIcon.innerHTML = iconSvg;
    toastAlert.className = alertClass;

    // Toast anzeigen
    toast.classList.remove('hidden');

    // Automatisch nach 5 Sekunden ausblenden
    setTimeout(() => {
      hideToast();
    }, 5000);
  }

  // Toast-Benachrichtigung ausblenden
  function hideToast() {
    const toast = document.getElementById('toast');
    if (toast) {
      toast.classList.add('hidden');
    }
  }

  // Best√§tigungs-Modal anzeigen
  function showConfirmModal(aufenthaltId: number) {
    const modal = document.getElementById('confirm-modal') as HTMLDialogElement;
    if (modal) {
      modal.showModal();

      // Event-Listener f√ºr Best√§tigung
      const confirmBtn = document.getElementById('confirm-delete');
      const cancelBtn = document.getElementById('cancel-delete');

      if (confirmBtn) {
        confirmBtn.onclick = () => {
          hideConfirmModal();
          performDelete(aufenthaltId);
        };
      }

      if (cancelBtn) {
        cancelBtn.onclick = () => {
          hideConfirmModal();
        };
      }
    }
  }

  // Best√§tigungs-Modal ausblenden
  function hideConfirmModal() {
    const modal = document.getElementById('confirm-modal') as HTMLDialogElement;
    if (modal) {
      modal.close();
    }
  }
  
  // Tats√§chliches L√∂schen durchf√ºhren
  async function performDelete(id: number) {
    // console.log('üóëÔ∏è F√ºhre L√∂schung durch f√ºr ID:', id);

    try {
      const response = await fetch(`/api/aufenthalte/${id}`, {
        method: 'DELETE',
      });

      // console.log('üì° DELETE Response Status:', response.status);

      if (response.ok) {
        // console.log('‚úÖ L√∂schen erfolgreich, leere Caches...');
        clearAllCaches();
        showToast('Aufenthalt erfolgreich gel√∂scht!', 'success');
        loadAufenthalte();
      } else {
        const errorData = await response.json().catch(() => ({ error: 'Unbekannter Fehler' }));
        console.error('‚ùå L√∂schen fehlgeschlagen:', errorData);
        showToast('Fehler beim L√∂schen: ' + (errorData.error || 'Unbekannter Fehler'), 'error');
      }
    } catch (error) {
      console.error('‚ùå Netzwerk-Fehler beim L√∂schen:', error);
      showToast('Netzwerk-Fehler beim L√∂schen', 'error');
    }
  }
  
  // Direkte L√∂schung f√ºr den Button
  async function deleteAufenthaltDirectly(id: number) {
    // console.log('üóëÔ∏è Direkte L√∂schung f√ºr ID:', id);

    try {
      const response = await fetch(`/api/aufenthalte/${id}`, {
        method: 'DELETE',
      });

      // console.log('üì° DELETE Response Status:', response.status);

      if (response.ok) {
        // console.log('‚úÖ L√∂schen erfolgreich, leere Caches...');
        clearAllCaches();
        showToast('Aufenthalt erfolgreich gel√∂scht!', 'success');
        loadAufenthalte();
      } else {
        const errorData = await response.json().catch(() => ({ error: 'Unbekannter Fehler' }));
        console.error('‚ùå L√∂schen fehlgeschlagen:', errorData);
        showToast('Fehler beim L√∂schen: ' + (errorData.error || 'Unbekannter Fehler'), 'error');
      }
    } catch (error) {
      console.error('‚ùå Netzwerk-Fehler beim L√∂schen:', error);
      showToast('Netzwerk-Fehler beim L√∂schen', 'error');
    }
  }

      // Alle Caches leeren
  function clearAllCaches() {
    // JavaScript-Variablen zur√ºcksetzen
    currentAufenthalte = [];
    alleAufenthalte = [];
    currentPreise = {};

    // localStorage leeren (falls vorhanden) - ABER USER-SETTINGS BEHALTEN!
    if (typeof localStorage !== 'undefined') {
      const savedTheme = localStorage.getItem('theme');
      const savedFontSize = localStorage.getItem('fontSize');
      localStorage.clear();
      if (savedTheme) localStorage.setItem('theme', savedTheme);
      if (savedFontSize) localStorage.setItem('fontSize', savedFontSize);
    }

    // SessionStorage leeren (falls vorhanden)
    if (typeof sessionStorage !== 'undefined') {
      sessionStorage.clear();
    }
    
    // Browser-Cache f√ºr diese Domain leeren
    if ('caches' in window) {
      caches.keys().then(names => {
        names.forEach(name => {
          caches.delete(name);
        });
      });
    }

    // console.log('üßπ Alle Caches wurden geleert');
  }

  // √úberlappungsaufenthalte laden
  async function loadUeberlappungsAufenthalte(jahr: string) {
    try {
      const response = await fetch('/api/aufenthalte/ueberlappungen', {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          eigeneAufenthalte: currentAufenthalte,
          jahr: jahr
        })
      });
      
      if (response.ok) {
        alleAufenthalte = await response.json();
        // console.log('üìä Alle Aufenthalte geladen:', alleAufenthalte.length);
        // console.log('üîç Alle Aufenthalte Details:', alleAufenthalte);
      }
    } catch (error) {
      console.error('‚ùå Fehler beim Laden der √úberlappungsaufenthalte:', error);
    }
  }
  
        // √úberlappungsinfo f√ºr einen Aufenthalt ermitteln
  function getUeberlappungsInfo(aufenthalt: any, alleAufenthalte: any[]) {
    // console.log(`üîç Pr√ºfe √úberlappungen f√ºr ${aufenthalt.user.name} (${aufenthalt.zaehlerAnkunft}-${aufenthalt.zaehlerAbreise})`);
    // console.log(`üìã Verf√ºgbare Aufenthalte:`, alleAufenthalte.length);
    
    const result = alleAufenthalte.filter((overlap: any) => {
      // Wichtig: Aufenthalt kann nicht mit sich selbst √ºberlappen
      if (aufenthalt.id === overlap.id) {
        return false;
      }
      
      // √úberlappung pr√ºfen: NUR Z√§hlerst√§nde √ºberschneiden sich
      // (Zeitliche Validierung erfolgt bereits bei der Erstellung im Frontend)
      const a1Start = aufenthalt.zaehlerAnkunft;
      const a1Ende = aufenthalt.zaehlerAbreise;
      const a2Start = overlap.zaehlerAnkunft;
      const a2Ende = overlap.zaehlerAbreise;

      // Echte √úberlappung liegt vor wenn: a1Ende > a2Start UND a1Start < a2Ende
      const hatUeberlappung = a1Ende > a2Start && a1Start < a2Ende;

      if (!hatUeberlappung) {
        // console.log(`  vs ${overlap.user.name} (${a2Start}-${a2Ende}): Keine √úberlappung`);
        return false;
      }

      // √úberlappungsbereich berechnen
      const overlapStart = Math.max(a1Start, a2Start);
      const overlapEnd = Math.min(a1Ende, a2Ende);
      const overlapHours = overlapEnd - overlapStart;

      // console.log(`  vs ${overlap.user.name} (${a2Start}-${a2Ende}): Overlap ${overlapStart}-${overlapEnd} = ${overlapHours.toFixed(1)}h`);

      // Nur echte √úberlappungen mit mindestens 1 Stunde
      return overlapHours >= 1;
    });

    // console.log(`‚úÖ Gefundene √úberlappungen f√ºr ${aufenthalt.user.name}:`, result.length);
    return result;
  }

  // Aufenthalte aus der API laden
  async function loadAufenthalte() {
    try {
      showLoading(true);
      const jahrSelect = document.getElementById('jahr') as HTMLSelectElement;
      const statusSelect = document.getElementById('status') as HTMLSelectElement;
      const benutzerSelect = document.getElementById('benutzer') as HTMLSelectElement;
      const currentYear = new Date().getFullYear().toString();
      const jahr = jahrSelect ? jahrSelect.value : currentYear;
      const status = statusSelect ? statusSelect.value : '';
      const benutzerId = benutzerSelect ? benutzerSelect.value : '';

      // console.log('üîç Lade Aufenthalte f√ºr Jahr:', jahr, 'Status:', status, 'Benutzer:', benutzerId);

      let url = `/api/aufenthalte?jahr=${jahr}`;
      if (benutzerId) {
        url += `&userId=${benutzerId}`;
      }

      const response = await fetch(url);
      // console.log('üì° API Response Status:', response.status);

      if (response.ok) {
        let aufenthalte = await response.json();
        // console.log('üìä Aufenthalte geladen:', aufenthalte.length);

        // Status-Filter anwenden (clientseitig)
        if (status === 'aktiv') {
          // Nur editierbare Jahre (f√ºr normale User)
          aufenthalte = aufenthalte.filter((a: typeof currentAufenthalte[0]) =>
            canEditJahr(a.jahr, isAdminUser)
          );
          // console.log('üü¢ Aktive (editierbare) Aufenthalte:', aufenthalte.length);
        } else if (status === 'abgeschlossen') {
          // Nur abgeschlossene Jahre (f√ºr normale User)
          aufenthalte = aufenthalte.filter((a: typeof currentAufenthalte[0]) =>
            !canEditJahr(a.jahr, isAdminUser)
          );
          // console.log('‚úÖ Abgeschlossene Aufenthalte:', aufenthalte.length);
        }

        currentAufenthalte = aufenthalte;
        // console.log('üìã Erste 2 Aufenthalte:', currentAufenthalte.slice(0, 2));

        // √úberlappungsaufenthalte laden
        await loadUeberlappungsAufenthalte(jahr);

        renderAufenthalte(currentAufenthalte);
      } else {
        console.error('‚ùå Fehler beim Laden der Aufenthalte');
        showNoData();
      }
    } catch (error) {
      console.error('‚ùå Fehler beim Laden der Aufenthalte:', error);
      showNoData();
    } finally {
      showLoading(false);
    }
  }

  // Verf√ºgbare Jahre laden
  async function loadAvailableYears() {
    try {
      const response = await fetch('/api/aufenthalte/years');
      if (response.ok) {
        const years = await response.json();
        const jahrSelect = document.getElementById('jahr') as HTMLSelectElement;
        const currentYear = new Date().getFullYear();

        if (jahrSelect) {
          jahrSelect.innerHTML = '';
          years.forEach((year: number) => {
            const option = document.createElement('option');
            option.value = year.toString();
            // Abgeschlossene Jahre mit ‚úì markieren
            option.textContent = formatJahrMitStatus(year);
            if (year === currentYear) {
              option.selected = true; // Aktuelles Jahr als Standard
            }
            jahrSelect.appendChild(option);
          });
        }
      }
    } catch (error) {
      console.error('Fehler beim Laden der verf√ºgbaren Jahre:', error);
      // Fallback: Standard-Jahre (aktuelles Jahr)
      const jahrSelect = document.getElementById('jahr') as HTMLSelectElement;
      const currentYear = new Date().getFullYear();
      if (jahrSelect) {
        jahrSelect.innerHTML = `<option value="${currentYear}">${formatJahrMitStatus(currentYear)}</option>`;
      }
    }
  }

  // Benutzer laden (nur f√ºr Admins)
  async function loadBenutzer() {
    try {
      const benutzerSelect = document.getElementById('benutzer') as HTMLSelectElement;
      if (!benutzerSelect) return;
      
      const response = await fetch('/api/users');
      if (response.ok) {
        const benutzer = await response.json();
        benutzerSelect.innerHTML = '<option value="">Alle Benutzer</option>';
        
        benutzer.forEach((user: { id: number; name: string; email: string }) => {
          const option = document.createElement('option');
          option.value = user.id.toString();
          option.textContent = `${user.name} (${user.email})`;
          benutzerSelect.appendChild(option);
        });
      }
    } catch (error) {
      console.error('Fehler beim Laden der Benutzer:', error);
    }
  }

  // Preise laden
  async function loadPreise(jahr: string) {
    try {
      const response = await fetch(`/api/preise?jahr=${jahr}`);
      if (response.ok) {
        currentPreise = await response.json();
      }
    } catch (error) {
      console.error('Fehler beim Laden der Preise:', error);
    }
  }

  // Tankf√ºllungen laden
  let alleTankfuellungen: Array<{
    id: number;
    datum: string;
    zaehlerstand: number;
    liter: number;
    preisProLiter: number;
  }> = [];

  async function loadTankfuellungen() {
    try {
      const response = await fetch('/api/preise/verlauf');
      if (response.ok) {
        const data = await response.json();
        // Nach Z√§hlerstand sortieren (aufsteigend)
        alleTankfuellungen = data.sort((a: any, b: any) => a.zaehlerstand - b.zaehlerstand);
        // console.log('‚õΩ Preisverlauf geladen:', alleTankfuellungen.length);
      }
    } catch (error) {
      console.error('Fehler beim Laden des Preisverlaufs:', error);
    }
  }

  // √ñlpreis f√ºr ein spezifisches Datum laden (VERALTET - wird ersetzt)
  async function getOelpreisFuerDatum(datum: Date): Promise<number> {
    try {
      const datumString = datum.toISOString().split('T')[0]; // YYYY-MM-DD Format
      const response = await fetch(`/api/preise?jahr=${datum.getFullYear()}&datum=${datumString}`);
      if (response.ok) {
        const preise = await response.json();
        return preise.oelpreisProLiter || 1.01; // Fallback auf 1.01‚Ç¨
      }
    } catch (error) {
      console.error('Fehler beim Laden des √ñlpreises f√ºr Datum:', error);
    }
    return 1.01; // Fallback bei Fehlern
  }

  // Toggle-Funktion f√ºr Details
  function toggleDetails(aufenthaltId: number) {
    const detailsRow = document.getElementById(`details-${aufenthaltId}`);
    const chevron = document.getElementById(`chevron-${aufenthaltId}`);

    if (detailsRow && chevron) {
      detailsRow.classList.toggle('hidden');
      chevron.classList.toggle('rotate-180');
    }
  }

  // Session-Info aus dem eingebetteten JSON-Script lesen
  const sessionData = document.getElementById('session-data');
  // isAdminUser wird im DOMContentLoaded gesetzt

  // Aufenthalte rendern (neue kompakte Version)
  function renderAufenthalte(aufenthalte: typeof currentAufenthalte) {
    // console.log('üé® renderAufenthalte aufgerufen mit', aufenthalte.length, 'Aufenthalten');
    const tbody = document.getElementById('aufenthalte-tbody');
    const noData = document.getElementById('no-data');

    if (!tbody) {
      console.error('‚ùå tbody Element nicht gefunden');
      return;
    }

    if (aufenthalte.length === 0) {
      // console.log('üì≠ Keine Aufenthalte vorhanden');
      tbody.innerHTML = '';
      showNoData();
      return;
    }

    // Keine-Daten-Anzeige verstecken wenn Daten vorhanden sind
    if (noData) {
      noData.classList.add('hidden');
    }

    tbody.innerHTML = '';

    // Summen berechnen
    let gesamtKosten = 0;

    aufenthalte.forEach((aufenthalt: typeof currentAufenthalte[0]) => {
      const ankunft = new Date(aufenthalt.ankunft).toLocaleDateString('de-DE');
      const abreise = new Date(aufenthalt.abreise).toLocaleDateString('de-DE');
      const zaehlerStart = aufenthalt.zaehlerAnkunft;
      const zaehlerEnde = aufenthalt.zaehlerAbreise;
      const verbrauchteStunden = zaehlerEnde - zaehlerStart;

      // Tage berechnen
      const tage = Math.ceil((new Date(aufenthalt.abreise).getTime() - new Date(aufenthalt.ankunft).getTime()) / (1000 * 60 * 60 * 24));

      // Kosten berechnen
      const oelKosten = berechneOelkostenNachZaehlerstand(zaehlerStart, zaehlerEnde, alleTankfuellungen);
      const naechteBerechnen = (aufenthalt as any).naechteBerechnen ?? !aufenthalt.user.beguenstigt;
      const uebernachtungKosten = naechteBerechnen ? (
        ((aufenthalt as any).uebernachtungenMitglieder || 0) * (currentPreise.uebernachtungMitglied || 5) +
        ((aufenthalt as any).uebernachtungenGaeste || 0) * (currentPreise.uebernachtungGast || 10)
      ) : 0;
      const aufenthaltKosten = oelKosten + uebernachtungKosten;
      gesamtKosten += aufenthaltKosten;

      // Hauptzeile (kompakt)
      const row = document.createElement('tr');
      row.className = 'hover cursor-pointer';
      row.onclick = () => toggleDetails(aufenthalt.id);

      row.innerHTML = `
        ${isAdminUser ? `
          <td>
            <div class="flex items-center gap-3">
              <div class="avatar placeholder">
                <div class="bg-primary text-primary-content rounded-full w-10 h-10 flex items-center justify-center">
                  <span class="text-sm">${aufenthalt.user.name.charAt(0)}</span>
                </div>
              </div>
              <div>
                <div class="font-medium">${aufenthalt.user.name}</div>
                <div class="text-sm text-base-content/70">${aufenthalt.user.email}</div>
              </div>
            </div>
          </td>
        ` : ''}
        <td>
          <div class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 text-base-content/70">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
            </svg>
            <span>${ankunft} ‚Üí ${abreise}</span>
          </div>
        </td>
        <td>
          <div class="font-mono text-sm">
            ${zaehlerStart}h ‚Üí ${zaehlerEnde}h
            <div class="text-xs text-base-content/70">${verbrauchteStunden}h verbraucht</div>
          </div>
        </td>
        <td>
          <div class="text-lg font-bold text-primary" id="total-costs-${aufenthalt.id}">
            ‚Ç¨${aufenthaltKosten.toFixed(2)}
          </div>
        </td>
        <td class="text-center">
          <svg id="chevron-${aufenthalt.id}" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 transition-transform inline-block text-base-content/70">
            <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 8.25l-7.5 7.5-7.5-7.5" />
          </svg>
        </td>
      `;

      tbody.appendChild(row);

      // Details-Zeile (aufklappbar)
      const detailsRow = document.createElement('tr');
      detailsRow.id = `details-${aufenthalt.id}`;
      detailsRow.className = 'hidden';

      detailsRow.innerHTML = `
        <td colspan="${isAdminUser ? '5' : '4'}" class="bg-base-200/50">
          <div class="p-6 space-y-4 max-w-4xl">
            <!-- Kostenaufschl√ºsselung -->
            <div class="card bg-base-100 shadow-sm">
              <div class="card-body p-4">
                <h3 class="text-sm font-semibold flex items-center gap-2 mb-3">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z" />
                  </svg>
                  Kostenaufschl√ºsselung
                </h3>

                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-3 gap-3">
                  <!-- Anwesenheit -->
                  <div class="bg-base-200 rounded-lg p-3">
                    <div class="text-xs text-base-content/70 mb-1">Anwesenheitstage</div>
                    <div class="text-xl font-bold text-primary">${tage} Tage</div>
                    <div class="text-xs text-base-content/60 mt-2">
                      ${ankunft} ‚Üí ${abreise}
                    </div>
                  </div>

                  <!-- Verbrauch -->
                  <div class="bg-base-200 rounded-lg p-3">
                    <div class="text-xs text-base-content/70 mb-1">Verbrauchte Stunden</div>
                    <div class="text-xl font-bold text-primary">${verbrauchteStunden}h</div>
                    <div class="text-xs text-base-content/60 mt-2">
                      ${(verbrauchteStunden / tage).toFixed(1)}h pro Tag
                    </div>
                  </div>

                  <!-- Kosten pro Tag -->
                  <div class="bg-base-200 rounded-lg p-3">
                    <div class="text-xs text-base-content/70 mb-1">Kosten pro Tag</div>
                    <div class="text-xl font-bold text-primary">‚Ç¨${(aufenthaltKosten / tage).toFixed(2)}</div>
                    <div class="text-xs text-base-content/60 mt-2">
                      Gesamt: ‚Ç¨${aufenthaltKosten.toFixed(2)}
                    </div>
                  </div>

                  <!-- √ñlkosten -->
                  <div class="bg-base-200 rounded-lg p-3">
                    <div class="text-xs text-base-content/70 mb-1">√ñlkosten</div>
                    <div class="text-xl font-bold">‚Ç¨${oelKosten.toFixed(2)}</div>
                    <div id="calc-details-${aufenthalt.id}" class="text-xs text-base-content/60 mt-2">
                      <!-- Wird dynamisch gef√ºllt -->
                    </div>
                  </div>

                  <!-- √úbernachtungen -->
                  <div class="bg-base-200 rounded-lg p-3">
                    <div class="text-xs text-base-content/70 mb-1">√úbernachtungen</div>
                    <div class="text-xl font-bold">
                      ${(aufenthalt as any).uebernachtungenMitglieder || 0} + ${(aufenthalt as any).uebernachtungenGaeste || 0}
                    </div>
                    <div class="text-xs text-base-content/60 mt-1">Mitglieder + G√§ste</div>
                  </div>

                  <!-- √úbernachtungskosten -->
                  <div class="bg-base-200 rounded-lg p-3">
                    <div class="text-xs text-base-content/70 mb-1 flex items-center gap-2">
                      √úbernachtungskosten
                      ${!naechteBerechnen ? '<span class="badge badge-warning badge-xs">nicht berechnet</span>' : ''}
                    </div>
                    <div class="text-xl font-bold">‚Ç¨${uebernachtungKosten.toFixed(2)}</div>
                    <div class="text-xs text-base-content/60 mt-2 space-y-1">
                      <div>Mitglieder: ‚Ç¨${currentPreise.uebernachtungMitglied || 5}/Nacht</div>
                      <div>G√§ste: ‚Ç¨${currentPreise.uebernachtungGast || 10}/Nacht</div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- √úberlappungen & Einsparungen -->
            <div id="overlap-card-${aufenthalt.id}" class="card bg-base-100 shadow-sm">
              <div class="card-body p-4">
                <h4 class="text-sm font-semibold mb-3">√úberlappungen & Einsparungen</h4>
                <div id="overlap-details-${aufenthalt.id}" class="space-y-2 mb-3">
                  <div class="flex items-center gap-2 text-sm">
                    <span class="loading loading-spinner loading-sm"></span>
                    <span>Wird geladen...</span>
                  </div>
                </div>
                <div class="divider my-2"></div>
                <div class="flex justify-between items-center text-sm">
                  <span class="font-semibold">Einsparung:</span>
                  <span id="savings-value-${aufenthalt.id}" class="text-success font-bold">‚Ç¨0.00</span>
                </div>
                <div class="flex justify-between items-center text-base mt-2">
                  <span class="font-bold">Endsumme:</span>
                  <span id="final-total-${aufenthalt.id}" class="text-primary font-bold text-lg">‚Ç¨${aufenthaltKosten.toFixed(2)}</span>
                </div>
              </div>
            </div>

            <!-- Aktionen (klein und unten) -->
            <div class="flex gap-2 justify-end pt-2 border-t border-base-300" id="actions-${aufenthalt.id}">
              <a href="/aufenthalte/${aufenthalt.id}/edit" class="btn btn-sm btn-outline gap-1">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                </svg>
                Bearbeiten
              </a>
              <button onclick="event.stopPropagation(); (function(aufenthaltId) {
                  const modal = document.getElementById('confirm-modal');
                  if (modal) {
                    modal.showModal();
                    const confirmBtn = document.getElementById('confirm-delete');
                    const cancelBtn = document.getElementById('cancel-delete');
                    if (confirmBtn) {
                      confirmBtn.onclick = async () => {
                        modal.close();
                        try {
                          const response = await fetch('/api/aufenthalte/' + aufenthaltId, { method: 'DELETE' });
                          if (response.ok) {
                            if (typeof clearAllCaches === 'function') clearAllCaches();
                            if (typeof showToast === 'function') showToast('Aufenthalt erfolgreich gel√∂scht!', 'success');
                            if (typeof loadAufenthalte === 'function') loadAufenthalte(); else window.location.reload();
                          } else {
                            const errorData = await response.json().catch(() => ({ error: 'Unbekannter Fehler' }));
                            if (typeof showToast === 'function') showToast('Fehler: ' + (errorData.error || 'Unbekannter Fehler'), 'error');
                          }
                        } catch (error) {
                          if (typeof showToast === 'function') showToast('Netzwerk-Fehler beim L√∂schen', 'error');
                        }
                      };
                    }
                    if (cancelBtn) cancelBtn.onclick = () => modal.close();
                  }
                })(${aufenthalt.id})" class="btn btn-sm btn-outline btn-error gap-1">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.74 9l-.346 9m-4.788 0L9.26 9m9.968-3.21c.342.052.682.107 1.022.166m-1.022-.165L18.16 19.673a2.25 2.25 0 01-2.244 2.077H8.084a2.25 2.25 0 01-2.244-2.077L4.772 5.79m14.456 0a48.108 48.108 0 00-3.478-.397m-12 .562c.34-.059.68-.114 1.022-.165m0 0a48.11 48.11 0 013.478-.397m7.5 0v-.916c0-1.18-.91-2.164-2.09-2.201a51.964 51.964 0 00-3.32 0c-1.18.037-2.09 1.022-2.09 2.201v.916m7.5 0a48.667 48.667 0 00-7.5 0" />
                  </svg>
                  L√∂schen
                </button>
            </div>
          </div>
        </td>
      `;

      tbody.appendChild(detailsRow);

      // Berechnungsdetails hinzuf√ºgen (NACH dem Anh√§ngen ans DOM)
      loadCalculationDetails(aufenthalt);

      // Aktions-Buttons verstecken wenn Jahr abgeschlossen und User kein Admin
      if (!canEditJahr(aufenthalt.jahr, isAdminUser)) {
        const actionsDiv = document.getElementById(`actions-${aufenthalt.id}`);
        if (actionsDiv) {
          actionsDiv.style.display = 'none';
        }
      }
    });

    // Summenzeile
    const summenRow = document.createElement('tr');
    summenRow.className = 'font-bold bg-base-300';
    summenRow.innerHTML = `
      ${isAdminUser ? '<td></td>' : ''}
      <td colspan="2" class="text-right">
        <div class="flex items-center justify-end gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
          </svg>
          GESAMT
        </div>
      </td>
      <td class="text-xl text-primary">‚Ç¨${gesamtKosten.toFixed(2)}</td>
      <td></td>
    `;
    tbody.appendChild(summenRow);

    // √úberlappungsinfo f√ºr jeden Aufenthalt laden
    aufenthalte.forEach((aufenthalt: typeof currentAufenthalte[0]) => {
      loadOverlapInfo(aufenthalt);
    });
  }

  // Urspr√ºngliche Kosten berechnen (vor Einsparungen)
  function calculateOriginalCosts(aufenthalt: any): number {
    const zaehlerStart = aufenthalt.zaehlerAnkunft;
    const zaehlerEnde = aufenthalt.zaehlerAbreise;

    // Validierung: Z√§hlerende muss gr√∂√üer als Z√§hlerstart sein
    if (zaehlerEnde <= zaehlerStart) {
      console.warn(`‚ö†Ô∏è Ung√ºltige Z√§hlerst√§nde f√ºr Aufenthalt ${aufenthalt.id}: Start=${zaehlerStart}, Ende=${zaehlerEnde}`);
      return 0; // Keine Kosten bei ung√ºltigen Z√§hlerst√§nden
    }

    // √ñlkosten - Z√§hlerstand-basierte Berechnung mit Tankf√ºllungen
    const oelKosten = berechneOelkostenNachZaehlerstand(zaehlerStart, zaehlerEnde, alleTankfuellungen);

    // √úbernachtungskosten nur berechnen wenn naechteBerechnen true ist
    // null = User-Status entscheidet (beg√ºnstigt=false, normal=true)
    const naechteBerechnen = (aufenthalt as any).naechteBerechnen ?? !aufenthalt.user.beguenstigt;
    const uebernachtungKosten = naechteBerechnen ? (
      ((aufenthalt as any).uebernachtungenMitglieder || 0) * (currentPreise.uebernachtungMitglied || 5) +
      ((aufenthalt as any).uebernachtungenGaeste || 0) * (currentPreise.uebernachtungGast || 10)
    ) : 0;

    return oelKosten + uebernachtungKosten;
  }

  // Einsparungen durch √úberlappungen berechnen
  function calculateSavings(aufenthalt: any, overlaps: any[]): number {
    if (overlaps.length === 0) return 0;
    
    let totalSavings = 0;
    
    overlaps.forEach((overlap: any) => {
      // Wichtig: Aufenthalt kann nicht mit sich selbst √ºberlappen
      if (aufenthalt.id === overlap.id) {
        return;
      }
      
      // √úberlappungsbereich berechnen
      const overlapStart = Math.max(aufenthalt.zaehlerAnkunft, overlap.zaehlerAnkunft);
      const overlapEnd = Math.min(aufenthalt.zaehlerAbreise, overlap.zaehlerAbreise);
      
      // Validierung: √úberlappung muss mindestens 1 Stunde haben
      if (overlapEnd <= overlapStart) {
        console.warn(`‚ö†Ô∏è Keine echte √úberlappung: Start=${overlapStart}, Ende=${overlapEnd}`);
        return; // Keine Einsparung bei ung√ºltiger √úberlappung
      }
      
      const overlapHours = overlapEnd - overlapStart;
      
      // Nur Einsparungen bei echten √úberlappungen (mindestens 1 Stunde)
      if (overlapHours >= 1) {
        // √ñlkosten-Einsparung: √úberlappungsstunden werden aufgeteilt
        // Z√§hlerstand-basierte Berechnung f√ºr das √úberlappungs-Segment
        const oelKostenSegment = berechneOelkostenNachZaehlerstand(overlapStart, overlapEnd, alleTankfuellungen);
        // Bei 2 Personen teilen sich beide die Kosten der √úberlappungsstunden
        // Jede Person spart 50% der Kosten der √úberlappungsstunden
        const oelSavings = oelKostenSegment * 0.5;

        // √úbernachtungskosten-Einsparung: Gemeinsame Nutzung der Infrastruktur
        // Kleine Einsparung pro √úberlappungsstunde
        const uebernachtungSavings = overlapHours / 24 * 5;

        totalSavings += oelSavings + uebernachtungSavings;

        // console.log(`üí∞ Einsparung f√ºr ${aufenthalt.user.name} mit ${overlap.user.name}: ${overlapHours.toFixed(1)}h = ‚Ç¨${(oelSavings + uebernachtungSavings).toFixed(2)}`);
      }
    });
    
    return totalSavings;
  }

  // Berechnungsdetails laden (Verbrauch L/h, Preis/L)
  function loadCalculationDetails(aufenthalt: typeof currentAufenthalte[0]) {
    const calcDetailsDiv = document.getElementById(`calc-details-${aufenthalt.id}`);
    if (!calcDetailsDiv) return;

    const zaehlerStart = aufenthalt.zaehlerAnkunft;
    const zaehlerEnde = aufenthalt.zaehlerAbreise;

    // Durchschnittswerte berechnen
    const relevanteFuellungen = alleTankfuellungen.filter(tf =>
      tf.zaehlerstand >= zaehlerStart && tf.zaehlerstand <= zaehlerEnde
    );

    if (relevanteFuellungen.length > 0) {
      // Durchschnittspreis und Verbrauch aus relevanten Tankf√ºllungen
      const avgPrice = relevanteFuellungen.reduce((sum, tf) => sum + tf.preisProLiter, 0) / relevanteFuellungen.length;

      // Verbrauch berechnen (wenn mindestens 2 Tankf√ºllungen vorhanden)
      if (alleTankfuellungen.length >= 2) {
        const sortedFuellungen = [...alleTankfuellungen].sort((a, b) => a.zaehlerstand - b.zaehlerstand);
        let totalVerbrauch = 0;
        let totalStunden = 0;

        for (let i = 1; i < sortedFuellungen.length; i++) {
          totalVerbrauch += sortedFuellungen[i].liter;
          totalStunden += sortedFuellungen[i].zaehlerstand - sortedFuellungen[i-1].zaehlerstand;
        }

        const avgVerbrauch = totalStunden > 0 ? totalVerbrauch / totalStunden : 5.5;

        calcDetailsDiv.innerHTML = `
          <div class="space-y-1">
            <div>Verbrauch: <span class="font-semibold">${avgVerbrauch.toFixed(2)} L/h</span></div>
            <div>Preis: <span class="font-semibold">‚Ç¨${avgPrice.toFixed(2)}/L</span></div>
          </div>
        `;
      } else {
        calcDetailsDiv.innerHTML = `
          <div>Preis: <span class="font-semibold">‚Ç¨${avgPrice.toFixed(2)}/L</span></div>
          <div class="text-xs">(Verbrauch: Standardwert 5.5 L/h)</div>
        `;
      }
    } else {
      // Fallback auf Standardwerte
      calcDetailsDiv.innerHTML = `
        <div class="text-xs">
          <div>Verbrauch: 5.5 L/h (Standard)</div>
          <div>Preis: ‚Ç¨1.01/L (Standard)</div>
        </div>
      `;
    }
  }

  // √úberlappungsinfo f√ºr einzelnen Aufenthalt laden
  function loadOverlapInfo(aufenthalt: typeof currentAufenthalte[0]) {
    try {
      const overlaps = getUeberlappungsInfo(aufenthalt, alleAufenthalte);
      const overlapCard = document.getElementById(`overlap-card-${aufenthalt.id}`);
      const overlapDetailsDiv = document.getElementById(`overlap-details-${aufenthalt.id}`);
      const savingsValueDiv = document.getElementById(`savings-value-${aufenthalt.id}`);
      const finalTotalDiv = document.getElementById(`final-total-${aufenthalt.id}`);

      // Einsparungen berechnen
      const savings = calculateSavings(aufenthalt, overlaps);
      const originalCosts = calculateOriginalCosts(aufenthalt);
      const totalCosts = originalCosts - savings;

      if (overlaps.length === 0) {
        // Keine √úberlappungen: Card verstecken
        if (overlapCard) {
          overlapCard.style.display = 'none';
        }
      } else {
        // √úberlappungen vorhanden: Card anzeigen und Details f√ºllen
        if (overlapCard) {
          overlapCard.style.display = 'block';
        }

        if (overlapDetailsDiv) {
          const overlapItems = overlaps.map((overlap: any) => {
            const startZaehler = Math.max(aufenthalt.zaehlerAnkunft, overlap.zaehlerAnkunft);
            const endZaehler = Math.min(aufenthalt.zaehlerAbreise, overlap.zaehlerAbreise);
            const overlapHours = endZaehler - startZaehler;

            if (overlapHours >= 1) {
              return `
                <div class="flex items-start gap-2 p-2 bg-warning/10 rounded">
                  <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 text-warning flex-shrink-0 mt-0.5" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20H7m10 0v-2c0-.656-.126-1.283-.356-1.857M7 20H2v-2a3 3 0 015.356-1.857M7 20v-2c0-.656.126-1.283.356-1.857m0 0a5.002 5.002 0 019.288 0M15 7a3 3 0 11-6 0 3 3 0 016 0zm6 3a2 2 0 11-4 0 2 2 0 014 0zM7 10a2 2 0 11-4 0 2 2 0 014 0z" />
                  </svg>
                  <div class="flex-1">
                    <div class="font-semibold">${overlap.user.name}</div>
                    <div class="text-sm text-base-content/70">
                      ${startZaehler}h - ${endZaehler}h (${overlapHours}h gemeinsam)
                    </div>
                  </div>
                </div>
              `;
            }
            return '';
          }).filter((html: string) => html).join('');

          overlapDetailsDiv.innerHTML = overlapItems || '<p class="text-sm text-base-content/70">Keine √úberlappungen</p>';
        }

        if (savingsValueDiv) {
          savingsValueDiv.textContent = `‚Ç¨${savings.toFixed(2)}`;
        }
      }

      // Endsumme aktualisieren (immer, auch wenn keine √úberlappungen)
      if (finalTotalDiv) {
        finalTotalDiv.textContent = `‚Ç¨${totalCosts.toFixed(2)}`;
      }

      // Hauptkosten-Display aktualisieren
      const totalCostsDisplay = document.getElementById(`total-costs-${aufenthalt.id}`);
      if (totalCostsDisplay) {
        totalCostsDisplay.textContent = `‚Ç¨${totalCosts.toFixed(2)}`;
      }
    } catch (error) {
      console.error('‚ùå Fehler beim Laden der √úberlappungsinfo:', error);
    }
  }







  // Aufenthalt l√∂schen
  async function deleteAufenthalt(id: number) {
    const modal = document.getElementById('confirm-modal') as HTMLDialogElement;
    if (modal) {
      modal.showModal();

      const confirmBtn = document.getElementById('confirm-delete');
      const cancelBtn = document.getElementById('cancel-delete');

      if (confirmBtn) {
        confirmBtn.onclick = () => {
          modal.close();
          performDelete(id);
        };
      }

      if (cancelBtn) {
        cancelBtn.onclick = () => {
          modal.close();
        };
      }
    } else {
      // Fallback falls Modal nicht gefunden wird
      if (!confirm('M√∂chten Sie diesen Aufenthalt wirklich l√∂schen?')) {
        return;
      }
      performDelete(id);
    }
  }

  // Lade-Animation anzeigen/verstecken
  function showLoading(show: boolean) {
    const loading = document.getElementById('loading');
    const noData = document.getElementById('no-data');

    if (loading) {
      loading.classList.toggle('hidden', !show);
    }

    // Keine-Daten-Anzeige verstecken w√§hrend geladen wird
    if (show && noData) {
      noData.classList.add('hidden');
    }
  }

  // Keine Daten anzeigen
  function showNoData() {
    const noData = document.getElementById('no-data');
    const loading = document.getElementById('loading');
    const noDataHint = document.getElementById('no-data-hint');

    // Lade-Animation verstecken
    if (loading) {
      loading.classList.add('hidden');
    }

    // Dynamischen Hinweistext basierend auf den Filtern erstellen
    if (noDataHint) {
      const jahrSelect = document.getElementById('jahr') as HTMLSelectElement;
      const benutzerSelect = document.getElementById('benutzer') as HTMLSelectElement;
      const jahr = jahrSelect ? jahrSelect.value : '';
      const benutzerName = benutzerSelect ? benutzerSelect.options[benutzerSelect.selectedIndex]?.text : '';

      let hintText = 'Erstellen Sie Ihren ersten Aufenthalt.';

      if (benutzerSelect && benutzerSelect.value) {
        // Ein bestimmter Benutzer ist ausgew√§hlt
        hintText = `${benutzerName} hat im Jahr ${jahr} keine Aufenthalte.`;
      } else if (jahr) {
        // Nur Jahr-Filter aktiv
        hintText = `F√ºr das Jahr ${jahr} wurden keine Aufenthalte gefunden.`;
      }

      noDataHint.textContent = hintText;
    }

    // Keine-Daten-Meldung anzeigen
    if (noData) {
      noData.classList.remove('hidden');
    }
  }

  // Modal-Daten f√ºr Bezahlung aktualisieren (inkl. QR-Code)
  async function updateModalData(jahr: number) {
    const modalKostenEl = document.getElementById('modal-kosten');
    const modalBetreffEl = document.getElementById('modal-betreff');
    const qrCodeImage = document.getElementById('qr-code-image') as HTMLImageElement;
    const qrCodeLoading = document.getElementById('qr-code-loading');

    if (!modalKostenEl || !modalBetreffEl) return;

    // Gesamtkosten aus aktuellen Aufenthalten berechnen
    let gesamtKosten = 0;

    currentAufenthalte.forEach((aufenthalt) => {
      // √ñlkosten berechnen
      const oelKosten = berechneOelkostenNachZaehlerstand(
        aufenthalt.zaehlerAnkunft,
        aufenthalt.zaehlerAbreise,
        alleTankfuellungen
      );

      // √úbernachtungskosten berechnen (nur wenn naechteBerechnen nicht explizit false ist)
      const sollBerechnen = (aufenthalt as any).naechteBerechnen !== false;
      const uebernachtungKosten = sollBerechnen ? (
        ((aufenthalt as any).uebernachtungenMitglieder || 0) * (currentPreise.uebernachtungMitglied || 5) +
        ((aufenthalt as any).uebernachtungenGaeste || 0) * (currentPreise.uebernachtungGast || 10)
      ) : 0;

      gesamtKosten += oelKosten + uebernachtungKosten;
    });

    // Modal aktualisieren
    modalKostenEl.textContent = `‚Ç¨ ${gesamtKosten.toFixed(2)}`;
    modalBetreffEl.textContent = `Jahresabschluss ${jahr}`;

    // QR-Code generieren
    if (qrCodeImage && qrCodeLoading) {
      try {
        // Loading-Spinner anzeigen
        qrCodeLoading.classList.remove('hidden');
        qrCodeImage.classList.add('hidden');

        // GiroCode QR-Code generieren
        const qrCodeDataURL = await generateGiroCodeQR({
          iban: 'DE97230800400312060000',
          bic: 'DRESDEFF230',
          name: 'Fasmilien-Stiftung W√ºstenstein',
          amount: gesamtKosten,
          reference: `Jahresabschluss ${jahr}`
        });

        // QR-Code anzeigen
        qrCodeImage.src = qrCodeDataURL;
        qrCodeImage.classList.remove('hidden');
        qrCodeLoading.classList.add('hidden');
      } catch (error) {
        console.error('Fehler beim Generieren des QR-Codes:', error);
        // Bei Fehler: Spinner verstecken und Fehlermeldung anzeigen
        if (qrCodeLoading) {
          qrCodeLoading.innerHTML = '<span class="text-error text-sm">QR-Code konnte nicht generiert werden</span>';
        }
      }
    }
  }

  // Bezahlt-Status Badge aktualisieren (kontextabh√§ngig)
  async function loadUserBezahltStatus() {
    const jahrSelect = document.getElementById('jahr') as HTMLSelectElement;
    const benutzerSelect = document.getElementById('benutzer') as HTMLSelectElement;

    if (!jahrSelect) return;

    const jahr = parseInt(jahrSelect.value);
    if (!jahr) return;

    // Pr√ºfen ob Jahr abgeschlossen ist
    if (!isJahrAbgeschlossen(jahr)) {
      const statusDiv = document.getElementById('user-bezahlt-status');
      if (statusDiv) {
        statusDiv.style.display = 'none';
      }
      return;
    }

    try {
      // Aktuelle User-Info holen
      const meResponse = await fetch('/api/auth/me', {
        credentials: 'same-origin'
      });
      if (!meResponse.ok) return;
      const currentUser = await meResponse.json();

      // Bezahlt-Status f√ºr alle User mit Aufenthalten in diesem Jahr holen
      const response = await fetch(`/api/jahresabschluss/bezahlt?jahr=${jahr}`, {
        credentials: 'same-origin'
      });
      if (!response.ok) return;

      const users = await response.json();

      const statusDiv = document.getElementById('user-bezahlt-status');
      const badgeElement = document.getElementById('bezahlt-badge');
      const textElement = document.getElementById('bezahlt-text');

      if (!statusDiv || !badgeElement || !textElement) return;

      // Kontext bestimmen
      const isAdmin = currentUser.role === 'ADMIN';
      const selectedUserId = benutzerSelect ? parseInt(benutzerSelect.value) : null;

      const bezahlenBtn = document.getElementById('bezahlen-btn');
      const bezahlenBtnText = document.getElementById('bezahlen-btn-text');

      if (isAdmin && !selectedUserId) {
        // Admin sieht alle User ‚Üí Zeige Gesamtstatistik als Badge
        const bezahltCount = users.filter((u: any) => u.bezahlt).length;
        const totalCount = users.length;

        if (bezahltCount === totalCount && totalCount > 0) {
          // Alle bezahlt
          badgeElement.classList.remove('hidden');
          badgeElement.className = 'badge badge-success gap-2';
          textElement.textContent = `Jahr ${jahr}: Alle bezahlt (${totalCount})`;
          if (bezahlenBtn) bezahlenBtn.classList.add('hidden');
          statusDiv.style.display = 'block';
        } else if (bezahltCount > 0) {
          // Teilweise bezahlt
          badgeElement.classList.remove('hidden');
          badgeElement.className = 'badge badge-warning gap-2';
          textElement.textContent = `Jahr ${jahr}: ${bezahltCount} von ${totalCount} bezahlt`;
          if (bezahlenBtn) bezahlenBtn.classList.add('hidden');
          statusDiv.style.display = 'block';
        } else {
          // Niemand bezahlt
          statusDiv.style.display = 'none';
        }
      } else {
        // Admin mit User-Filter ODER normaler User ‚Üí Zeige individuellen Status
        const targetUserId = selectedUserId || currentUser.id;
        const userStatus = users.find((u: any) => u.userId === targetUserId);

        if (userStatus) {
          // User hat Aufenthalte in diesem Jahr
          if (userStatus.bezahlt) {
            // Bezahlt ‚Üí Gr√ºner Badge, Button versteckt
            badgeElement.classList.remove('hidden');
            badgeElement.className = 'badge badge-success gap-2';
            if (isAdmin && selectedUserId) {
              textElement.textContent = `${userStatus.name}: Jahr ${jahr} bezahlt`;
            } else {
              textElement.textContent = `Jahr ${jahr} bezahlt`;
            }
            if (bezahlenBtn) bezahlenBtn.classList.add('hidden');
            statusDiv.style.display = 'block';
          } else {
            // Nicht bezahlt ‚Üí Badge versteckt, roter Button angezeigt
            badgeElement.classList.add('hidden');

            // Button nur f√ºr normale User anzeigen (nicht f√ºr Admin mit Filter)
            if (bezahlenBtn && !isAdmin) {
              bezahlenBtn.classList.remove('hidden');
              if (bezahlenBtnText) {
                bezahlenBtnText.textContent = `Jahr ${jahr} bezahlen`;
              }
              // Modal-Daten aktualisieren mit Gesamtkosten
              updateModalData(jahr);
              statusDiv.style.display = 'block';
            } else {
              // Admin mit Filter sieht roten Badge
              badgeElement.classList.remove('hidden');
              badgeElement.className = 'badge badge-error gap-2';
              textElement.textContent = `${userStatus.name}: Jahr ${jahr} unbezahlt`;
              if (bezahlenBtn) bezahlenBtn.classList.add('hidden');
              statusDiv.style.display = 'block';
            }
          }
        } else {
          // User hat keine Aufenthalte in diesem Jahr
          statusDiv.style.display = 'none';
          if (bezahlenBtn) bezahlenBtn.classList.add('hidden');
        }
      }
    } catch (error) {
      console.error('Fehler beim Laden des Bezahlt-Status:', error);
    }
  }

  // Bezahlt-Status f√ºr Admins laden (alle User)
  async function loadAdminBezahltStatus() {
    if (!isAdminUser) return;

    const jahrSelect = document.getElementById('jahr') as HTMLSelectElement;
    if (!jahrSelect) return;

    const jahr = parseInt(jahrSelect.value);
    if (!jahr) return;

    // Pr√ºfen ob Jahr abgeschlossen ist
    const jahrAbgeschlossen = isJahrAbgeschlossen(jahr);

    const adminCard = document.getElementById('admin-bezahlt-card');
    if (!adminCard) return;

    // Card nur anzeigen wenn Jahr abgeschlossen ist
    if (!jahrAbgeschlossen) {
      adminCard.style.display = 'none';
      return;
    }

    adminCard.style.display = 'block';

    // Jahr anzeigen
    const jahrDisplay = document.getElementById('bezahlt-jahr-display');
    if (jahrDisplay) {
      jahrDisplay.textContent = jahr.toString();
    }

    try {
      const response = await fetch(`/api/jahresabschluss/bezahlt?jahr=${jahr}`, {
        credentials: 'same-origin'
      });
      if (response.ok) {
        const users = await response.json();
        updateBezahltTable(users, jahr);
      } else {
        console.error('‚ùå API-Fehler:', response.status, response.statusText);
      }
    } catch (error) {
      console.error('Fehler beim Laden des Bezahlt-Status:', error);
    }
  }

  // Bezahlt-Tabelle aktualisieren
  function updateBezahltTable(users: any[], jahr: number) {
    const tbody = document.getElementById('bezahlt-tbody');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (users.length === 0) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td colspan="3" class="text-center py-4 text-base-content/60">
          Keine Benutzer gefunden
        </td>
      `;
      tbody.appendChild(row);
      return;
    }

    users.forEach(user => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="font-medium">${user.name}</td>
        <td>${user.email}</td>
        <td class="text-center">
          <input
            type="checkbox"
            class="checkbox checkbox-success border-2 border-base-300"
            data-user-id="${user.userId}"
            data-jahr="${jahr}"
            ${user.bezahlt ? 'checked' : ''}
          />
        </td>
      `;
      tbody.appendChild(row);

      // Event listener f√ºr Checkbox
      const checkbox = row.querySelector('input[type="checkbox"]') as HTMLInputElement;
      if (checkbox) {
        checkbox.addEventListener('change', async () => {
          await updateBezahltStatus(user.userId, jahr, checkbox.checked);
        });
      }
    });
  }

  // Bezahlt-Status aktualisieren
  async function updateBezahltStatus(userId: number, jahr: number, bezahlt: boolean) {
    try {
      const response = await fetch('/api/jahresabschluss/bezahlt', {
        method: 'POST',
        credentials: 'same-origin',
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({
          userId,
          jahr,
          bezahlt
        })
      });

      if (!response.ok) {
        throw new Error('Fehler beim Aktualisieren des Bezahlt-Status');
      }

      // Badge aktualisieren nach √Ñnderung
      await loadUserBezahltStatus();
    } catch (error) {
      console.error('Fehler beim Aktualisieren des Bezahlt-Status:', error);
      alert('Fehler beim Speichern des Status');
    }
  }

  // Event-Listener
  document.addEventListener('DOMContentLoaded', async () => {
    // console.log('üöÄ DOM geladen, starte Initialisierung...');

    try {
      // Pr√ºfen ob User Admin ist
      const meResponse = await fetch('/api/auth/me');
      if (meResponse.ok) {
        const currentUser = await meResponse.json();
        isAdminUser = currentUser.role === 'ADMIN';
        // console.log('üë§ User-Rolle:', isAdminUser ? 'ADMIN' : 'USER');
      }

      await loadAvailableYears();
      // console.log('‚úÖ Verf√ºgbare Jahre geladen');

      const currentYear = new Date().getFullYear().toString();
      await loadPreise(currentYear);
      // console.log('‚úÖ Preise geladen');

      await loadTankfuellungen();
      // console.log('‚úÖ Tankf√ºllungen geladen');

      // Benutzer laden (nur f√ºr Admins)
      await loadBenutzer();
      // console.log('‚úÖ Benutzer geladen');

      await loadAufenthalte();
      // console.log('‚úÖ Aufenthalte geladen');

      // Bezahlt-Status laden
      await loadUserBezahltStatus();
      await loadAdminBezahltStatus();
      // console.log('‚úÖ Bezahlt-Status geladen');



      // Filter-Event-Listener (automatische Filterung bei Select-√Ñnderung)
      const jahrSelect = document.getElementById('jahr');
      const statusSelect = document.getElementById('status');
      const benutzerSelect = document.getElementById('benutzer');

      if (jahrSelect) {
        jahrSelect.addEventListener('change', async () => {
          await loadAufenthalte();
          await loadUserBezahltStatus();
          await loadAdminBezahltStatus();
        });
        // console.log('‚úÖ Jahr-Select Event-Listener gesetzt');
      }
      if (statusSelect) {
        statusSelect.addEventListener('change', loadAufenthalte);
        // console.log('‚úÖ Status-Select Event-Listener gesetzt');
      }
      if (benutzerSelect) {
        benutzerSelect.addEventListener('change', async () => {
          await loadAufenthalte();
          await loadUserBezahltStatus(); // Badge aktualisieren
        });
        // console.log('‚úÖ Benutzer-Select Event-Listener gesetzt');
      }

      // console.log('üéØ Alle Event-Listener gesetzt!');
      
      // Cache leeren beim Verlassen der Seite
      window.addEventListener('beforeunload', clearAllCaches);
      
      // Cache leeren beim Neuladen der Seite
      window.addEventListener('unload', clearAllCaches);
      
      // Toast-Close-Button Event-Listener
      const toastClose = document.getElementById('toast-close');
      if (toastClose) {
        toastClose.addEventListener('click', hideToast);
      }
      
    } catch (error) {
      console.error('‚ùå Fehler bei der Initialisierung:', error);
    }
  });
</script>
