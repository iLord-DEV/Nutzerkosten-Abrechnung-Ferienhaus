---
import Layout from '../../layouts/Layout.astro';
import { getUser } from '../../utils/auth';

// Authentifizierung pr√ºfen
const user = await getUser(Astro);
if (!user) {
  return Astro.redirect('/login');
}
---

<Layout title="Statistiken - Nutzerkosten">
  <div class="px-4 sm:px-6 lg:px-8">
    <div class="mb-8">
      <h1 class="text-3xl font-bold text-base-content flex items-center gap-3">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
          <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
        </svg>
        Meine Verbrauchsstatistiken
      </h1>
      <p class="mt-2 text-base-content/70">
        Detaillierte Analyse deines Verbrauchs im Vergleich zu anderen Nutzern
      </p>
    </div>

    <!-- Filter -->
    <div class="bg-base-100 shadow rounded-lg mb-8">
      <div class="px-4 py-5 sm:p-6">
        <div class="grid grid-cols-1 gap-4 sm:grid-cols-3">
          <div class="form-control w-full">
            <label class="label" for="jahr">
              <span class="label-text flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                </svg>
                Jahr
              </span>
            </label>
            <select id="jahr" class="select select-bordered w-full">
              <!-- Wird dynamisch geladen -->
            </select>
          </div>
          <div class="form-control w-full">
            <label class="label" for="zeitraum">
              <span class="label-text flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" />
                </svg>
                Ansicht
              </span>
            </label>
            <select id="zeitraum" class="select select-bordered w-full">
              <option value="aufenthalte">Aufenthalte im Detail</option>
              <option value="abwesenheit">Abwesenheitsverbrauch</option>
              <option value="uebersicht">√úbersicht</option>
            </select>
          </div>
          <div id="admin-option" class="form-control w-full" style="display: none;">
            <label class="label" for="user-filter">
              <span class="label-text flex items-center gap-2">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15 19.128a9.38 9.38 0 002.625.372 9.337 9.337 0 004.121-.952 4.125 4.125 0 00-7.533-2.493M15 19.128v-.003c0-1.113-.285-2.16-.786-3.07M15 19.128v.106A12.318 12.318 0 018.624 21c-2.331 0-4.512-.645-6.374-1.766l-.001-.109a6.375 6.375 0 0111.964-3.07M12 6.375a3.375 3.375 0 11-6.75 0 3.375 3.375 0 016.75 0zm8.25 2.25a2.625 2.625 0 11-5.25 0 2.625 2.625 0 015.25 0z" />
                </svg>
                Benutzer
              </span>
            </label>
            <select id="user-filter" class="select select-bordered w-full">
              <option value="meine">Nur meine Aufenthalte</option>
              <option value="alle">Alle Aufenthalte</option>
            </select>
          </div>
        </div>
      </div>
    </div>

    <!-- √úbersichtskarten -->
    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
      <div class="bg-gradient-to-r from-blue-500 to-blue-600 text-white rounded-lg p-6 shadow-lg">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="w-8 h-8 bg-white bg-opacity-20 rounded-md flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.361-6.867 8.21 8.21 0 003 2.48z" />
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 18a3.75 3.75 0 00.495-7.467 5.99 5.99 0 00-1.925 3.546 5.974 5.974 0 01-2.133-1A3.75 3.75 0 0012 18z" />
              </svg>
            </div>
          </div>
          <div class="ml-4">
            <p class="text-blue-100 text-sm font-medium">Gesamtverbrauch</p>
            <p class="text-2xl font-bold" id="gesamt-verbrauch">-</p>
          </div>
        </div>
      </div>

      <div class="bg-gradient-to-r from-green-500 to-green-600 text-white rounded-lg p-6 shadow-lg">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="w-8 h-8 bg-white bg-opacity-20 rounded-md flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M14.25 7.756a4.5 4.5 0 100 8.488M7.5 10.5h5.25m-5.25 3h5.25M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
          </div>
          <div class="ml-4">
            <p class="text-green-100 text-sm font-medium">Gesamtkosten</p>
            <p class="text-2xl font-bold" id="gesamt-kosten">-</p>
          </div>
        </div>
      </div>

      <div class="bg-gradient-to-r from-purple-500 to-purple-600 text-white rounded-lg p-6 shadow-lg">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="w-8 h-8 bg-white bg-opacity-20 rounded-md flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
              </svg>
            </div>
          </div>
          <div class="ml-4">
            <p class="text-purple-100 text-sm font-medium">√ò Verbrauch/Tag</p>
            <p class="text-2xl font-bold" id="durchschnitt-verbrauch-tag">-</p>
          </div>
        </div>
      </div>

      <div class="bg-gradient-to-r from-yellow-500 to-yellow-600 text-white rounded-lg p-6 shadow-lg">
        <div class="flex items-center">
          <div class="flex-shrink-0">
            <div class="w-8 h-8 bg-white bg-opacity-20 rounded-md flex items-center justify-center">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
              </svg>
            </div>
          </div>
          <div class="ml-4">
            <p class="text-yellow-100 text-sm font-medium">Aufenthalte</p>
            <p class="text-2xl font-bold" id="anzahl-aufenthalte">-</p>
          </div>
        </div>
      </div>
    </div>

    <!-- Vergleich mit anderen Nutzern -->
    <div class="bg-base-100 shadow rounded-lg mb-8">
      <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg leading-6 font-medium text-base-content mb-4 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18L9 11.25l4.306 4.307a11.95 11.95 0 015.814-5.519l2.74-1.22m0 0l-5.94-2.28m5.94 2.28l-2.28 5.941" />
          </svg>
          Vergleich mit anderen Nutzern
        </h3>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
          <div class="text-center">
            <div class="text-3xl font-bold text-blue-600 dark:text-blue-400" id="mein-verbrauch-pro-tag">-</div>
            <div class="text-sm text-base-content/60">Dein Verbrauch/Tag</div>
            <div class="text-xs text-base-content/50 mt-1" id="vergleich-verbrauch-tag">-</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-green-600 dark:text-green-400" id="mein-verbrauch-pro-aufenthalt">-</div>
            <div class="text-sm text-base-content/60">Dein Verbrauch/Aufenthalt</div>
            <div class="text-xs text-base-content/50 mt-1" id="vergleich-verbrauch-aufenthalt">-</div>
          </div>
          <div class="text-center">
            <div class="text-3xl font-bold text-purple-600 dark:text-purple-400" id="meine-kosten-pro-aufenthalt">-</div>
            <div class="text-sm text-base-content/60">Deine Kosten/Aufenthalt</div>
            <div class="text-xs text-base-content/50 mt-1" id="vergleich-kosten-aufenthalt">-</div>
          </div>
        </div>
        <div class="mt-4 text-center text-sm text-base-content/60" id="referenz-info">
          Vergleich mit <span id="anzahl-andere-user">-</span> anderen Nutzern
        </div>
      </div>
    </div>

    <!-- Aufenthalte im Detail -->
    <div id="aufenthalte-detail" class="bg-base-100 shadow rounded-lg mb-8" style="display: none;">
      <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg leading-6 font-medium text-base-content mb-4 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
          </svg>
          Deine Aufenthalte im Detail
        </h3>
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-base-300">
            <thead class="bg-base-200">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/60 uppercase tracking-wider">
                  Zeitraum
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/60 uppercase tracking-wider">
                  Tage
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/60 uppercase tracking-wider">
                  Brennerstunden gesamt
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/60 uppercase tracking-wider">
                  Liter gesamt
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/60 uppercase tracking-wider">
                  Liter/Tag
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/60 uppercase tracking-wider">
                  Heizkosten gesamt
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/60 uppercase tracking-wider">
                  √úbernachtung
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/60 uppercase tracking-wider">
                  Gesamt
                </th>
              </tr>
            </thead>
            <tbody id="aufenthalte-tbody" class="bg-base-100 divide-y divide-base-300">
              <!-- Wird dynamisch gef√ºllt -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Abwesenheitsverbrauch -->
    <div id="abwesenheit-detail" class="bg-base-100 shadow rounded-lg mb-8" style="display: none;">
      <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg leading-6 font-medium text-base-content mb-4 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
          </svg>
          Verbrauch w√§hrend Abwesenheit aller Nutzer
        </h3>
        <p class="text-sm text-base-content/70 mb-4">
          Diese Werte zeigen, wie viel verbraucht wurde, w√§hrend niemand anwesend war.
        </p>
        
        <!-- Gesamt√ºbersicht Abwesenheitskosten -->
        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-5 gap-4 mb-6">
          <div class="bg-red-50 dark:bg-red-900/20 border border-red-200 dark:border-red-800 rounded-lg p-4">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-red-500 rounded-md flex items-center justify-center">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-white">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M14.25 7.756a4.5 4.5 0 100 8.488M7.5 10.5h5.25m-5.25 3h5.25M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                  </svg>
                </div>
              </div>
              <div class="ml-3">
                <p class="text-red-600 dark:text-red-400 text-sm font-medium">Gesamtkosten Abwesenheit</p>
                <p class="text-red-900 dark:text-red-100 text-xl font-bold" id="abwesenheit-gesamtkosten">-</p>
              </div>
            </div>
          </div>
          
          <div class="bg-orange-50 dark:bg-orange-900/20 border border-orange-200 dark:border-orange-800 rounded-lg p-4">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-orange-500 rounded-md flex items-center justify-center">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-white">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.361-6.867 8.21 8.21 0 003 2.48z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 18a3.75 3.75 0 00.495-7.467 5.99 5.99 0 00-1.925 3.546 5.974 5.974 0 01-2.133-1A3.75 3.75 0 0012 18z" />
                  </svg>
                </div>
              </div>
              <div class="ml-3">
                <p class="text-orange-600 dark:text-orange-400 text-sm font-medium">Gesamtliter Abwesenheit</p>
                <p class="text-orange-900 dark:text-orange-100 text-xl font-bold" id="abwesenheit-gesamtliter">-</p>
              </div>
            </div>
          </div>
          
          <div class="bg-purple-50 dark:bg-purple-900/20 border border-purple-200 dark:border-purple-800 rounded-lg p-4">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-purple-500 rounded-md flex items-center justify-center">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-white">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
                  </svg>
                </div>
              </div>
              <div class="ml-3">
                <p class="text-purple-600 dark:text-purple-400 text-sm font-medium">Abwesenheitsperioden</p>
                <p class="text-purple-900 dark:text-purple-100 text-xl font-bold" id="abwesenheit-perioden">-</p>
              </div>
            </div>
          </div>
          
          <div class="bg-green-50 dark:bg-green-900/20 border border-green-200 dark:border-green-800 rounded-lg p-4">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-white">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
                  </svg>
                </div>
              </div>
              <div class="ml-3">
                <p class="text-green-600 dark:text-green-400 text-sm font-medium">√ò Verbrauch/Tag</p>
                <p class="text-green-900 dark:text-green-100 text-xl font-bold" id="abwesenheit-verbrauch-pro-tag">-</p>
              </div>
            </div>
          </div>
          
          <div class="bg-blue-50 dark:bg-blue-900/20 border border-blue-200 dark:border-blue-800 rounded-lg p-4">
            <div class="flex items-center">
              <div class="flex-shrink-0">
                <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-white">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 18.75a60.07 60.07 0 0115.797 2.101c.727.198 1.453-.342 1.453-1.096V18.75M3.75 4.5v.75A.75.75 0 013 6h-.75m0 0v-.375c0-.621.504-1.125 1.125-1.125H20.25M2.25 6v9m18-10.5v.75c0 .414.336.75.75.75h.75m-1.5-1.5h.375c.621 0 1.125.504 1.125 1.125v9.75c0 .621-.504 1.125-1.125 1.125h-.375m1.5-1.5H21a.75.75 0 00-.75.75v.75m0 0H3.75m0 0h-.375a1.125 1.125 0 01-1.125-1.125V15m1.5 1.5v-.75A.75.75 0 003 15h-.75M15 10.5a3 3 0 11-6 0 3 3 0 016 0zm3 0h.008v.008H18V10.5zm-12 0h.008v.008H6V10.5z" />
                  </svg>
                </div>
              </div>
              <div class="ml-3">
                <p class="text-blue-600 dark:text-blue-400 text-sm font-medium">√ò Kosten/Tag</p>
                <p class="text-blue-900 dark:text-blue-100 text-xl font-bold" id="abwesenheit-kosten-pro-tag">-</p>
              </div>
            </div>
          </div>
        </div>

        <!-- Monatliche Abwesenheits√ºbersicht -->
        <div class="mb-6">
          <h4 class="text-md font-medium text-base-content mb-3 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
            </svg>
            Monatliche Abwesenheitsverbr√§uche
          </h4>
          <div class="grid grid-cols-2 md:grid-cols-4 lg:grid-cols-6 gap-3">
            <div id="monatliche-abwesenheit-container">
              <!-- Wird dynamisch gef√ºllt -->
            </div>
          </div>
        </div>

        <!-- Detaillierte Tabelle -->
        <div class="overflow-x-auto">
          <table class="min-w-full divide-y divide-base-300">
            <thead class="bg-base-200">
              <tr>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/60 uppercase tracking-wider">
                  Zeitraum
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/60 uppercase tracking-wider">
                  Monat
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/60 uppercase tracking-wider">
                  Tage
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/60 uppercase tracking-wider">
                  Brennerstunden
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/60 uppercase tracking-wider">
                  Liter gesamt
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/60 uppercase tracking-wider">
                  Liter/Tag
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/60 uppercase tracking-wider">
                  Kosten
                </th>
                <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-base-content/60 uppercase tracking-wider">
                  √úbergang
                </th>
              </tr>
            </thead>
            <tbody id="abwesenheit-tbody" class="bg-base-100 divide-y divide-base-300">
              <!-- Wird dynamisch gef√ºllt -->
            </tbody>
          </table>
        </div>
      </div>
    </div>

    <!-- Charts -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-8 mb-8">
      <!-- Monatlicher Verbrauch -->
      <div class="bg-base-100 shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg leading-6 font-medium text-base-content mb-4 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" />
            </svg>
            Monatlicher Verbrauch
          </h3>
          <div class="h-64">
            <canvas id="verbrauch-chart" width="400" height="200"></canvas>
          </div>
        </div>
      </div>

      <!-- Kostenverteilung -->
      <div class="bg-base-100 shadow rounded-lg">
        <div class="px-4 py-5 sm:p-6">
          <h3 class="text-lg leading-6 font-medium text-base-content mb-4 flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M14.25 7.756a4.5 4.5 0 100 8.488M7.5 10.5h5.25m-5.25 3h5.25M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            Kostenverteilung
          </h3>
          <div class="h-64">
            <canvas id="kosten-chart" width="400" height="200"></canvas>
          </div>
        </div>
      </div>
    </div>

    <!-- Export-Optionen -->
    <div class="bg-base-100 shadow rounded-lg">
      <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg leading-6 font-medium text-base-content mb-4 flex items-center gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M3 16.5v2.25A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75V16.5m-13.5-9L12 3m0 0l4.5 4.5M12 3v13.5" />
          </svg>
          Daten exportieren
        </h3>
        <div class="flex flex-wrap gap-4">
          <button class="bg-blue-600 hover:bg-blue-700 text-white px-4 py-2 rounded-md text-sm font-medium inline-flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z" />
            </svg>
            PDF-Report
          </button>
          <button class="bg-green-600 hover:bg-green-700 text-white px-4 py-2 rounded-md text-sm font-medium inline-flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M3.375 19.5h17.25m-17.25 0a1.125 1.125 0 01-1.125-1.125M3.375 19.5h7.5c.621 0 1.125-.504 1.125-1.125m-9.75 0V5.625m0 12.75v-1.5c0-.621.504-1.125 1.125-1.125m18.375 2.625V5.625m0 12.75c0 .621-.504 1.125-1.125 1.125m1.125-1.125v-1.5c0-.621-.504-1.125-1.125-1.125m0 3.75h-7.5A1.125 1.125 0 0112 18.375m9.75-12.75c0-.621-.504-1.125-1.125-1.125H3.375c-.621 0-1.125.504-1.125 1.125m19.5 0v1.5c0 .621-.504 1.125-1.125 1.125M2.25 5.625v1.5c0 .621.504 1.125 1.125 1.125m0 0h17.25m-17.25 0h7.5c.621 0 1.125.504 1.125 1.125M3.375 8.25c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125m17.25-3.75h-7.5c-.621 0-1.125.504-1.125 1.125m8.625-1.125c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125v1.5c0 .621.504 1.125 1.125 1.125M12 10.875v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 10.875c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125M13.125 12h7.5m-7.5 0c-.621 0-1.125.504-1.125 1.125M20.625 12c.621 0 1.125.504 1.125 1.125v1.5c0 .621-.504 1.125-1.125 1.125m-17.25 0h7.5M12 14.625v-1.5m0 1.5c0 .621-.504 1.125-1.125 1.125M12 14.625c0 .621.504 1.125 1.125 1.125m-2.25 0c.621 0 1.125.504 1.125 1.125m0 1.5v-1.5m0 0c0-.621.504-1.125 1.125-1.125m0 0h7.5" />
            </svg>
            Excel-Export
          </button>
          <button class="bg-purple-600 hover:bg-purple-700 text-white px-4 py-2 rounded-md text-sm font-medium inline-flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
              <path stroke-linecap="round" stroke-linejoin="round" d="M9 12h3.75M9 15h3.75M9 18h3.75m3 .75H18a2.25 2.25 0 002.25-2.25V6.108c0-1.135-.845-2.098-1.976-2.192a48.424 48.424 0 00-1.123-.08m-5.801 0c-.065.21-.1.433-.1.664 0 .414.336.75.75.75h4.5a.75.75 0 00.75-.75 2.25 2.25 0 00-.1-.664m-5.8 0A2.251 2.251 0 0113.5 2.25H15c1.012 0 1.867.668 2.15 1.586m-5.8 0c-.376.023-.75.05-1.124.08C9.095 4.01 8.25 4.973 8.25 6.108V8.25m0 0H4.875c-.621 0-1.125.504-1.125 1.125v11.25c0 .621.504 1.125 1.125 1.125h9.75c.621 0 1.125-.504 1.125-1.125V9.375c0-.621-.504-1.125-1.125-1.125H8.25zM6.75 12h.008v.008H6.75V12zm0 3h.008v.008H6.75V15zm0 3h.008v.008H6.75V18z" />
            </svg>
            CSV-Daten
          </button>
        </div>
      </div>
    </div>
  </div>
</ProtectedLayout>

<script>
  import { Chart, registerables } from 'chart.js';
  Chart.register(...registerables);

  let verbrauchChart: Chart | null = null;
  let kostenChart: Chart | null = null;
  let currentData: any = null;

  // Statistiken laden
  async function loadStatistiken() {
    const currentYear = new Date().getFullYear().toString();
    const jahr = (document.getElementById('jahr') as HTMLSelectElement)?.value || currentYear;
    const userFilter = (document.getElementById('user-filter') as HTMLSelectElement)?.value || 'meine';
    
    try {
      console.log('üöÄ Lade Statistiken f√ºr Jahr:', jahr, 'User-Filter:', userFilter);
      
      // URL-Parameter zusammenstellen
      let url = `/api/statistiken?jahr=${jahr}`;
      if (userFilter === 'alle') {
        url += '&alle=true';
      }
      
      const response = await fetch(url);
      if (response.ok) {
        currentData = await response.json();
        console.log('üìä Statistiken geladen:', currentData);
        console.log('üîç Abwesenheitsdaten:', currentData.absenceConsumption);
        updateUebersichtskarten(currentData);
        updateCharts(currentData);
        updateVergleich(currentData);
        updateDetailViews(currentData);
      }
    } catch (error) {
      console.error('Fehler beim Laden der Statistiken:', error);
    }
  }

  // √úbersichtskarten aktualisieren
  function updateUebersichtskarten(data: any) {
    const gesamtVerbrauchEl = document.getElementById('gesamt-verbrauch');
    const gesamtKostenEl = document.getElementById('gesamt-kosten');
    const durchschnittVerbrauchTagEl = document.getElementById('durchschnitt-verbrauch-tag');
    const anzahlAufenthalteEl = document.getElementById('anzahl-aufenthalte');

    if (gesamtVerbrauchEl) gesamtVerbrauchEl.textContent = `${data.gesamtVerbrauch?.toFixed(1) || 0} h`;
    if (gesamtKostenEl) gesamtKostenEl.textContent = `‚Ç¨ ${data.gesamtKosten?.toFixed(2) || 0}`;
    if (durchschnittVerbrauchTagEl) durchschnittVerbrauchTagEl.textContent = `${data.durchschnittVerbrauchProTag?.toFixed(1) || 0} h`;
    if (anzahlAufenthalteEl) anzahlAufenthalteEl.textContent = data.anzahlAufenthalte || 0;
  }

  // Vergleich mit anderen Nutzern aktualisieren
  function updateVergleich(data: any) {
    const meinVerbrauchProTagEl = document.getElementById('mein-verbrauch-pro-tag');
    const meinVerbrauchProAufenthaltEl = document.getElementById('mein-verbrauch-pro-aufenthalt');
    const meineKostenProAufenthaltEl = document.getElementById('meine-kosten-pro-aufenthalt');
    const vergleichVerbrauchTagEl = document.getElementById('vergleich-verbrauch-tag');
    const vergleichVerbrauchAufenthaltEl = document.getElementById('vergleich-verbrauch-aufenthalt');
    const vergleichKostenAufenthaltEl = document.getElementById('vergleich-kosten-aufenthalt');
    const anzahlAndereUserEl = document.getElementById('anzahl-andere-user');

    const meinVerbrauchProTag = data.durchschnittVerbrauchProTag || 0;
    const meinVerbrauchProAufenthalt = data.anzahlAufenthalte > 0 ? data.gesamtVerbrauch / data.anzahlAufenthalte : 0;
    const meineKostenProAufenthalt = data.anzahlAufenthalte > 0 ? data.gesamtKosten / data.anzahlAufenthalte : 0;

    const refVerbrauchProTag = data.referenceValues?.durchschnittVerbrauchProTag || 0;
    const refVerbrauchProAufenthalt = data.referenceValues?.durchschnittVerbrauchProAufenthalt || 0;
    const refKostenProAufenthalt = data.referenceValues?.durchschnittKostenProAufenthalt || 0;

    if (meinVerbrauchProTagEl) meinVerbrauchProTagEl.textContent = `${meinVerbrauchProTag.toFixed(1)} h`;
    if (meinVerbrauchProAufenthaltEl) meinVerbrauchProAufenthaltEl.textContent = `${meinVerbrauchProAufenthalt.toFixed(1)} h`;
    if (meineKostenProAufenthaltEl) meineKostenProAufenthaltEl.textContent = `‚Ç¨ ${meineKostenProAufenthalt.toFixed(2)}`;

    // Vergleichstexte
    if (vergleichVerbrauchTagEl) {
      const diff = refVerbrauchProTag > 0 ? ((meinVerbrauchProTag - refVerbrauchProTag) / refVerbrauchProTag * 100) : 0;
      const text = refVerbrauchProTag > 0 ? 
        `${diff > 0 ? '+' : ''}${diff.toFixed(1)}% vs. Durchschnitt` : 
        'Kein Vergleich m√∂glich';
      vergleichVerbrauchTagEl.textContent = text;
      vergleichVerbrauchTagEl.className = `text-xs mt-1 ${diff > 0 ? 'text-red-500' : diff < 0 ? 'text-green-500' : 'text-base-content/50'}`;
    }

    if (vergleichVerbrauchAufenthaltEl) {
      const diff = refVerbrauchProAufenthalt > 0 ? ((meinVerbrauchProAufenthalt - refVerbrauchProAufenthalt) / refVerbrauchProAufenthalt * 100) : 0;
      const text = refVerbrauchProAufenthalt > 0 ? 
        `${diff > 0 ? '+' : ''}${diff.toFixed(1)}% vs. Durchschnitt` : 
        'Kein Vergleich m√∂glich';
      vergleichVerbrauchAufenthaltEl.textContent = text;
      vergleichVerbrauchAufenthaltEl.className = `text-xs mt-1 ${diff > 0 ? 'text-red-500' : diff < 0 ? 'text-green-500' : 'text-base-content/50'}`;
    }

    if (vergleichKostenAufenthaltEl) {
      const diff = refKostenProAufenthalt > 0 ? ((meineKostenProAufenthalt - refKostenProAufenthalt) / refKostenProAufenthalt * 100) : 0;
      const text = refKostenProAufenthalt > 0 ? 
        `${diff > 0 ? '+' : ''}${diff.toFixed(1)}% vs. Durchschnitt` : 
        'Kein Vergleich m√∂glich';
      vergleichKostenAufenthaltEl.textContent = text;
      vergleichKostenAufenthaltEl.className = `text-xs mt-1 ${diff > 0 ? 'text-red-500' : diff < 0 ? 'text-green-500' : 'text-base-content/50'}`;
    }

    if (anzahlAndereUserEl) anzahlAndereUserEl.textContent = data.referenceValues?.anzahlAndereUser || 0;
  }

  // Detail-Ansichten aktualisieren
  function updateDetailViews(data: any) {
    const zeitraum = (document.getElementById('zeitraum') as HTMLSelectElement)?.value || 'aufenthalte';
    
    // Alle Detail-Ansichten verstecken
    document.getElementById('aufenthalte-detail')?.style.setProperty('display', 'none');
    document.getElementById('abwesenheit-detail')?.style.setProperty('display', 'none');

    if (zeitraum === 'aufenthalte') {
      updateAufenthalteDetail(data);
      document.getElementById('aufenthalte-detail')?.style.setProperty('display', 'block');
    } else if (zeitraum === 'abwesenheit') {
      updateAbwesenheitDetail(data);
      document.getElementById('abwesenheit-detail')?.style.setProperty('display', 'block');
    }
  }

  // Aufenthalte-Detail aktualisieren
  function updateAufenthalteDetail(data: any) {
    const tbody = document.getElementById('aufenthalte-tbody');
    if (!tbody || !data.aufenthaltsDetails) return;

    tbody.innerHTML = '';
    
    // Summen berechnen
    let gesamtTage = 0;
    let gesamtBrennerstunden = 0;
    let gesamtLiter = 0;
    let gesamtHeizkosten = 0;
    let gesamtUebernachtung = 0;
    let gesamtKosten = 0;
    
    data.aufenthaltsDetails.forEach((aufenthalt: any) => {
      // Liter pro Tag berechnen
      const literProTag = aufenthalt.tage > 0 ? aufenthalt.verbrauchteLiter / aufenthalt.tage : 0;
      
      // Summen akkumulieren
      gesamtTage += aufenthalt.tage;
      gesamtBrennerstunden += aufenthalt.brennerstunden;
      gesamtLiter += aufenthalt.verbrauchteLiter;
      gesamtHeizkosten += aufenthalt.oelKosten;
      gesamtUebernachtung += aufenthalt.uebernachtungKosten;
      gesamtKosten += aufenthalt.gesamtKosten;
      
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content">
          ${new Date(aufenthalt.ankunft).toLocaleDateString('de-DE')} - ${new Date(aufenthalt.abreise).toLocaleDateString('de-DE')}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content">
          ${aufenthalt.tage}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content">
          ${aufenthalt.brennerstunden.toFixed(1)} h
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content">
          ${aufenthalt.verbrauchteLiter.toFixed(1)} L
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content">
          ${literProTag.toFixed(1)} L
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content">
          ‚Ç¨ ${aufenthalt.oelKosten.toFixed(2)}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content">
          ‚Ç¨ ${aufenthalt.uebernachtungKosten.toFixed(2)}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-base-content">
          ‚Ç¨ ${aufenthalt.gesamtKosten.toFixed(2)}
        </td>
      `;
      tbody.appendChild(row);
    });
    
    // Summenzeile hinzuf√ºgen
    const durchschnittLiterProTag = gesamtTage > 0 ? gesamtLiter / gesamtTage : 0;
    
    const summenRow = document.createElement('tr');
    summenRow.className = 'bg-base-200 font-semibold';
    summenRow.innerHTML = `
      <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-base-content">
        GESAMT
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-base-content">
        ${gesamtTage}
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-base-content">
        ${gesamtBrennerstunden.toFixed(1)} h
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-base-content">
        ${gesamtLiter.toFixed(1)} L
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-base-content">
        ${durchschnittLiterProTag.toFixed(1)} L
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-base-content">
        ‚Ç¨ ${gesamtHeizkosten.toFixed(2)}
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-base-content">
        ‚Ç¨ ${gesamtUebernachtung.toFixed(2)}
      </td>
      <td class="px-6 py-4 whitespace-nowrap text-sm font-bold text-blue-600 dark:text-blue-400">
        ‚Ç¨ ${gesamtKosten.toFixed(2)}
      </td>
    `;
    tbody.appendChild(summenRow);
  }

  // Abwesenheits-Detail aktualisieren
  function updateAbwesenheitDetail(data: any) {
    // Gesamt√ºbersicht aktualisieren
    const gesamtKostenEl = document.getElementById('abwesenheit-gesamtkosten');
    const gesamtLiterEl = document.getElementById('abwesenheit-gesamtliter');
    const periodenEl = document.getElementById('abwesenheit-perioden');
    const verbrauchProTagEl = document.getElementById('abwesenheit-verbrauch-pro-tag');
    const kostenProTagEl = document.getElementById('abwesenheit-kosten-pro-tag');

    if (gesamtKostenEl) gesamtKostenEl.textContent = `‚Ç¨ ${data.absenceTotals?.gesamtKosten?.toFixed(2) || 0}`;
    if (gesamtLiterEl) gesamtLiterEl.textContent = `${data.absenceTotals?.gesamtLiter?.toFixed(1) || 0} L`;
    if (periodenEl) periodenEl.textContent = data.absenceTotals?.anzahlPerioden || 0;
    
    // Durchschnittswerte berechnen
    const gesamtTage = data.absenceConsumption?.reduce((sum: number, periode: any) => sum + (periode.tage || 0), 0) || 0;
    const durchschnittVerbrauchProTag = gesamtTage > 0 ? (data.absenceTotals?.gesamtLiter || 0) / gesamtTage : 0;
    const durchschnittKostenProTag = gesamtTage > 0 ? (data.absenceTotals?.gesamtKosten || 0) / gesamtTage : 0;
    
    if (verbrauchProTagEl) verbrauchProTagEl.textContent = `${durchschnittVerbrauchProTag.toFixed(1)} L`;
    if (kostenProTagEl) kostenProTagEl.textContent = `‚Ç¨ ${durchschnittKostenProTag.toFixed(2)}`;

    // Monatliche √úbersicht aktualisieren
    updateMonatlicheAbwesenheit(data.monatlicheAbwesenheit);

    // Detaillierte Tabelle aktualisieren
    const tbody = document.getElementById('abwesenheit-tbody');
    if (!tbody || !data.absenceConsumption) return;

    tbody.innerHTML = '';
    if (data.absenceConsumption.length === 0) {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td colspan="8" class="px-6 py-4 text-center text-sm text-base-content/60">
          Keine Abwesenheitsperioden gefunden
        </td>
      `;
      tbody.appendChild(row);
      return;
    }

    data.absenceConsumption.forEach((periode: any) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content">
          ${periode.periode}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content">
          ${periode.monat}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content">
          ${periode.tage}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content">
          ${periode.brennerstunden.toFixed(1)} h
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content">
          ${periode.liter.toFixed(1)} L
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content">
          ${periode.literProTag.toFixed(1)} L/Tag
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content">
          ‚Ç¨ ${periode.kosten.toFixed(2)}
        </td>
        <td class="px-6 py-4 whitespace-nowrap text-sm text-base-content/60">
          ${periode.letzterNutzer} ‚Üí ${periode.naechsterNutzer}
        </td>
      `;
      tbody.appendChild(row);
    });
  }

  // Monatliche Abwesenheits√ºbersicht aktualisieren
  function updateMonatlicheAbwesenheit(monatlicheAbwesenheit: any[]) {
    const container = document.getElementById('monatliche-abwesenheit-container');
    if (!container) return;

    container.innerHTML = '';
    
    if (!monatlicheAbwesenheit || monatlicheAbwesenheit.length === 0) {
      container.innerHTML = '<div class="col-span-full text-center text-base-content/60">Keine Daten verf√ºgbar</div>';
      return;
    }

    monatlicheAbwesenheit.forEach(monat => {
      if (monat.liter > 0 || monat.kosten > 0) {
        const card = document.createElement('div');
        card.className = 'bg-base-200 rounded-lg p-3 text-center';
        card.innerHTML = `
          <div class="text-sm font-medium text-base-content">${monat.monat}</div>
          <div class="text-xs text-base-content/60 mt-1">
            ${monat.liter.toFixed(1)} L
          </div>
          <div class="text-xs text-base-content/60">
            ‚Ç¨ ${monat.kosten.toFixed(0)}
          </div>
          <div class="text-xs text-base-content/50">
            ${monat.perioden} Periode${monat.perioden !== 1 ? 'n' : ''}
          </div>
        `;
        container.appendChild(card);
      }
    });
  }

  // Charts aktualisieren
  function updateCharts(data: any) {
    updateVerbrauchChart(data);
    updateKostenChart(data);
  }

  // Verbrauch-Chart aktualisieren
  function updateVerbrauchChart(data: any) {
    const ctx = document.getElementById('verbrauch-chart') as HTMLCanvasElement;
    if (!ctx) return;

    if (verbrauchChart) {
      verbrauchChart.destroy();
    }

    const monatlicheDaten = data.monatlicheVerbrauch || Array(12).fill(0);
    
    verbrauchChart = new Chart(ctx, {
      type: 'line',
      data: {
        labels: ['Jan', 'Feb', 'Mar', 'Apr', 'Mai', 'Jun', 'Jul', 'Aug', 'Sep', 'Okt', 'Nov', 'Dez'],
        datasets: [{
          label: 'Dein Verbrauch (Stunden)',
          data: monatlicheDaten,
          borderColor: 'rgb(59, 130, 246)',
          backgroundColor: 'rgba(59, 130, 246, 0.1)',
          tension: 0.4,
          fill: true
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            labels: {
              color: document.documentElement.classList.contains('dark') ? '#f3f4f6' : '#374151'
            }
          }
        },
        scales: {
          y: {
            beginAtZero: true,
            grid: {
              color: document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb'
            },
            ticks: {
              color: document.documentElement.classList.contains('dark') ? '#f3f4f6' : '#374151'
            }
          },
          x: {
            grid: {
              color: document.documentElement.classList.contains('dark') ? '#374151' : '#e5e7eb'
            },
            ticks: {
              color: document.documentElement.classList.contains('dark') ? '#f3f4f6' : '#374151'
            }
          }
        }
      }
    });
  }

  // Kosten-Chart aktualisieren
  function updateKostenChart(data: any) {
    const ctx = document.getElementById('kosten-chart') as HTMLCanvasElement;
    if (!ctx) return;

    if (kostenChart) {
      kostenChart.destroy();
    }

    const oelKosten = data.oelKosten || 0;
    const uebernachtungKostenBerechnet = data.uebernachtungKostenBerechnet || 0;
    const uebernachtungKostenBeguenstigtNichtBerechnet = data.uebernachtungKostenBeguenstigtNichtBerechnet || 0;

    console.log('üé® Chart-Daten:', {
      oelKosten,
      uebernachtungKostenBerechnet,
      uebernachtungKostenBeguenstigtNichtBerechnet,
      gesamtUebernachtung: data.uebernachtungKosten
    });

    // Labels und Daten vorbereiten - nur Kategorien mit Werten > 0 anzeigen
    const labels = [];
    const chartData = [];
    const colors = [];

    labels.push('√ñlkosten');
    chartData.push(oelKosten);
    colors.push('rgb(59, 130, 246)');

    if (uebernachtungKostenBerechnet > 0) {
      labels.push('√úbernachtungen');
      chartData.push(uebernachtungKostenBerechnet);
      colors.push('rgb(34, 197, 94)');
    }

    if (uebernachtungKostenBeguenstigtNichtBerechnet > 0) {
      labels.push('√úbernachtungen Beg√ºnstigte (nicht berechnet)');
      chartData.push(uebernachtungKostenBeguenstigtNichtBerechnet);
      colors.push('rgb(168, 85, 247)');
    }

    kostenChart = new Chart(ctx, {
      type: 'doughnut',
      data: {
        labels: labels,
        datasets: [{
          data: chartData,
          backgroundColor: colors,
          borderWidth: 2,
          borderColor: document.documentElement.classList.contains('dark') ? '#1f2937' : '#ffffff'
        }]
      },
      options: {
        responsive: true,
        maintainAspectRatio: false,
        plugins: {
          legend: {
            position: 'bottom',
            labels: {
              color: document.documentElement.classList.contains('dark') ? '#f3f4f6' : '#374151'
            }
          },
          tooltip: {
            callbacks: {
              label: function(context) {
                const label = context.label || '';
                const value = context.parsed || 0;
                return `${label}: ‚Ç¨ ${value.toFixed(2)}`;
              }
            }
          }
        }
      }
    });
  }

  // Verf√ºgbare Jahre laden
  async function loadAvailableYears() {
    try {
      const response = await fetch('/api/aufenthalte/years');
      if (response.ok) {
        const years = await response.json();
        const jahrSelect = document.getElementById('jahr') as HTMLSelectElement;
        const currentYear = new Date().getFullYear();

        if (jahrSelect) {
          jahrSelect.innerHTML = '';
          years.forEach((year: number) => {
            const option = document.createElement('option');
            option.value = year.toString();
            option.textContent = year.toString();
            if (year === currentYear) {
              option.selected = true;
            }
            jahrSelect.appendChild(option);
          });
        }
      }
    } catch (error) {
      console.error('Fehler beim Laden der verf√ºgbaren Jahre:', error);
      const jahrSelect = document.getElementById('jahr') as HTMLSelectElement;
      const currentYear = new Date().getFullYear();
      if (jahrSelect) {
        jahrSelect.innerHTML = `<option value="${currentYear}">${currentYear}</option>`;
      }
    }
  }

  // Admin-Option anzeigen/verstecken
  async function checkAdminRole() {
    try {
      const response = await fetch('/api/auth/me');
      if (response.ok) {
        const user = await response.json();
        const adminOption = document.getElementById('admin-option');
        if (adminOption && user.role === 'ADMIN') {
          adminOption.style.display = 'block';
        }
      }
    } catch (error) {
      console.error('Fehler beim Pr√ºfen der Benutzerrolle:', error);
    }
  }

  // Event-Listener
  document.addEventListener('DOMContentLoaded', async () => {
    await checkAdminRole();
    await loadAvailableYears();
    await loadStatistiken();

    // Filter-Selects - automatisches Neuladen bei √Ñnderung
    const jahrSelect = document.getElementById('jahr');
    const zeitraumSelect = document.getElementById('zeitraum');
    const userFilterSelect = document.getElementById('user-filter');

    if (jahrSelect) {
      jahrSelect.addEventListener('change', loadStatistiken);
    }

    if (userFilterSelect) {
      userFilterSelect.addEventListener('change', loadStatistiken);
    }

    // Zeitraum-√Ñnderung - nur Detail-Ansicht aktualisieren ohne API-Call
    if (zeitraumSelect) {
      zeitraumSelect.addEventListener('change', () => {
        if (currentData) {
          updateDetailViews(currentData);
        }
      });
    }
  });

</script>
