---
import ProtectedLayout from '../../layouts/ProtectedLayout.astro';

// Zugriffskontrolle: Nur Admins
const sessionCookie = Astro.cookies.get('session');
if (!sessionCookie) {
  return Astro.redirect('/login');
}

const session = JSON.parse(sessionCookie.value);
if (session.role !== 'ADMIN') {
  return Astro.redirect('/dashboard');
}
---

<ProtectedLayout title="Tankfüllungen - Nutzerkosten">
  <div class="section-container">
    <div class="page-header">
      <div class="sm:flex sm:items-center">
        <div class="sm:flex-auto">
          <h1 class="page-title">
            Tankfüllungen
          </h1>
          <p class="page-description">
            Verwalten Sie alle Tankfüllungen und überwachen Sie den Ölverbrauch
          </p>
        </div>
      <div class="mt-4 sm:mt-0 sm:ml-16 sm:flex-none">
        <a href="/tankfuellungen/neu" class="btn btn-success gap-2">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
            <path stroke-linecap="round" stroke-linejoin="round" d="M12 4.5v15m7.5-7.5h-15" />
          </svg>
          Neue Tankfüllung
        </a>
      </div>
      </div>
    </div>

    <!-- Aktueller Zähler-Status -->
    <div class="alert alert-info mb-6">
      <div class="flex items-center">
        <div class="flex-shrink-0">
          <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-white">
              <path stroke-linecap="round" stroke-linejoin="round" d="M11.42 15.17L17.25 21A2.652 2.652 0 0021 17.25l-5.877-5.877M11.42 15.17l2.496-3.03c.317-.384.74-.626 1.208-.766M11.42 15.17l-4.655 5.653a2.548 2.548 0 11-3.586-3.586l6.837-5.63m5.108-.233c.55-.164 1.163-.188 1.743-.14a4.5 4.5 0 004.486-6.336l-3.276 3.277a3.004 3.004 0 01-2.25-2.25l3.276-3.276a4.5 4.5 0 00-6.336 4.486c.091 1.076-.071 2.264-.904 2.95l-.102.085m-1.745 1.437L5.909 7.5H4.5L2.25 3.75l1.5-1.5L7.5 4.5v1.409l4.26 4.26m-1.745 1.437l1.745-1.437m6.615 8.206L15.75 15.75M4.867 19.125h.008v.008h-.008v-.008z" />
            </svg>
          </div>
        </div>
        <div class="ml-3">
          <h3 class="text-sm font-medium">
            Aktueller Zähler
          </h3>
          <p class="text-sm" id="aktueller-zaehler-info">
            Wird geladen...
          </p>
        </div>
      </div>
    </div>

    <!-- Verbrauchsübersicht -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8">
      <div class="bg-base-100 overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-blue-500 rounded-md flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-white">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.361-6.867 8.21 8.21 0 003 2.48z" />
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 18a3.75 3.75 0 00.495-7.467 5.99 5.99 0 00-1.925 3.546 5.974 5.974 0 01-2.133-1A3.75 3.75 0 0012 18z" />
                </svg>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-base-content/60 truncate">
                  Aktueller Verbrauch
                </dt>
                <dd class="text-lg font-medium text-base-content" id="aktueller-verbrauch">
                  -
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-base-100 overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-green-500 rounded-md flex items-center justify-center">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 text-white">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
                </svg>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-base-content/60 truncate">
                  Trend
                </dt>
                <dd class="text-lg font-medium text-green-600 dark:text-green-400" id="verbrauchs-trend">
                  -
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>

      <div class="bg-base-100 overflow-hidden shadow rounded-lg">
        <div class="p-5">
          <div class="flex items-center">
            <div class="flex-shrink-0">
              <div class="w-8 h-8 bg-yellow-500 rounded-md flex items-center justify-center">
                <span class="text-white text-sm font-medium">⚠️</span>
              </div>
            </div>
            <div class="ml-5 w-0 flex-1">
              <dl>
                <dt class="text-sm font-medium text-base-content/60 truncate">
                  Status
                </dt>
                <dd class="text-lg font-medium text-yellow-600 dark:text-yellow-400" id="verbrauchs-status">
                  -
                </dd>
              </dl>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Verbrauchsverlauf Chart -->
    <div class="bg-base-100 shadow rounded-lg mb-8">
      <div class="px-4 py-5 sm:p-6">
        <h3 class="text-lg leading-6 font-medium text-base-content mb-4">
          Verbrauchsverlauf
        </h3>
        <div class="h-64 bg-base-200 rounded-lg flex items-center justify-center">
          <canvas id="verbrauchs-chart" class="w-full h-full"></canvas>
        </div>
      </div>
    </div>

    <!-- Tankfüllungen-Tabelle -->
    <div class="bg-base-100 shadow rounded-lg">
      <div class="px-4 py-5 sm:p-6">
        <div class="overflow-x-auto">
          <table class="table table-zebra">
            <thead>
              <tr>
                <th>Datum</th>
                <th>Zählerstand</th>
                <th>Zähler</th>
                <th>Liter</th>
                <th>Preis/Liter</th>
                <th>Gesamtkosten</th>
                <th>Verbrauch</th>
                <th>Aktionen</th>
              </tr>
            </thead>
            <tbody id="tankfuellungen-tbody">
              <!-- Wird dynamisch geladen -->
            </tbody>
          </table>
        </div>
        
        <!-- Lade-Animation -->
        <div id="loading" class="text-center py-8">
          <div class="inline-flex items-center px-4 py-2 text-sm font-medium text-base-content/60">
            <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-base-content/60" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
              <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
              <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
            </svg>
            Lade Tankfüllungen...
          </div>
        </div>
        
        <!-- Keine Daten -->
        <div id="no-data" class="hidden text-center py-8">
          <div class="text-base-content/60">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-16 h-16 mx-auto mb-2">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.361-6.867 8.21 8.21 0 003 2.48z" />
              <path stroke-linecap="round" stroke-linejoin="round" d="M12 18a3.75 3.75 0 00.495-7.467 5.99 5.99 0 00-1.925 3.546 5.974 5.974 0 01-2.133-1A3.75 3.75 0 0012 18z" />
            </svg>
            <p class="mt-2 text-lg font-medium">Keine Tankfüllungen gefunden</p>
            <p class="mt-1">Erstellen Sie Ihre erste Tankfüllung.</p>
          </div>
        </div>
      </div>
    </div>
  </div>
</ProtectedLayout>

<script>
  import { Chart, registerables } from 'chart.js';
  Chart.register(...registerables);

  let currentTankfuellungen: Array<{
    id: number;
    datum: string;
    liter: number;
    preisProLiter: number;
    zaehlerstand: number;
    verbrauchProStunde?: string;
    verbrauchteStunden?: string;
    zaehler?: {
      id: number;
      einbauDatum: string;
    };
  }> = [];
  
  let verbrauchsChart: Chart | null = null;

  // Aktuellen Zähler laden
  async function loadAktuellerZaehler() {
    try {
      const response = await fetch('/api/zaehler');
      if (response.ok) {
        const zaehler = await response.json();
        const aktiverZaehler = zaehler.find((z: any) => z.istAktiv);
        
        const infoElement = document.getElementById('aktueller-zaehler-info');
        if (infoElement) {
                  if (aktiverZaehler) {
          const einbauDatum = new Date(aktiverZaehler.einbauDatum).toLocaleDateString('de-DE');
          infoElement.textContent = `Zähler #${aktiverZaehler.id} - Eingebaut am ${einbauDatum} - Letzter Stand: ${aktiverZaehler.letzterStand.toFixed(1)} h`;
        } else {
            infoElement.innerHTML = '<span class="text-red-600 dark:text-red-400">Kein aktiver Zähler gefunden! <a href="/admin/zaehler" class="underline">Zähler einbauen</a></span>';
          }
        }
      }
    } catch (error) {
      console.error('Fehler beim Laden des aktuellen Zählers:', error);
    }
  }

  // Tankfüllungen aus der API laden
  async function loadTankfuellungen() {
    try {
      showLoading(true);
      const response = await fetch('/api/tankfuellungen');
      if (response.ok) {
        currentTankfuellungen = await response.json();
        renderTankfuellungen(currentTankfuellungen);
        updateVerbrauchsUebersicht(currentTankfuellungen);
        renderVerbrauchsChart(currentTankfuellungen);
      } else {
        console.error('Fehler beim Laden der Tankfüllungen');
        showNoData();
      }
    } catch (error) {
      console.error('Fehler beim Laden der Tankfüllungen:', error);
      showNoData();
    } finally {
      showLoading(false);
    }
  }

  // Tankfüllungen rendern
  function renderTankfuellungen(tankfuellungen: typeof currentTankfuellungen) {
    const tbody = document.getElementById('tankfuellungen-tbody');
    if (!tbody) return;

    if (tankfuellungen.length === 0) {
      showNoData();
      return;
    }

    tbody.innerHTML = '';
    
    // Tankfüllungen in absteigender Reihenfolge für die Tabelle anzeigen
    const tankfuellungenReversed = [...tankfuellungen].reverse();
    
    tankfuellungenReversed.forEach((tankfuellung: typeof currentTankfuellungen[0], index: number) => {
      const row = document.createElement('tr');
      const datum = new Date(tankfuellung.datum).toLocaleDateString('de-DE');
      const gesamtKosten = tankfuellung.liter * tankfuellung.preisProLiter;
      
      // Verbrauch berechnen - verwende die bereits berechneten Werte aus der API
      let verbrauch = '-';
      if (tankfuellung.verbrauchProStunde && tankfuellung.verbrauchProStunde !== '-') {
        verbrauch = `${tankfuellung.verbrauchProStunde} L/h`;
      }

      const zaehlerInfo = tankfuellung.zaehler 
        ? `#${tankfuellung.zaehler.id}`
        : 'Unbekannt';

      row.innerHTML = `
        <td>${datum}</td>
        <td>${tankfuellung.zaehlerstand.toFixed(1)} h</td>
        <td>${zaehlerInfo}</td>
        <td>${tankfuellung.liter} L</td>
        <td>€ ${tankfuellung.preisProLiter.toFixed(2)}</td>
        <td>€ ${gesamtKosten.toFixed(2)}</td>
        <td>${verbrauch}</td>
        <td>
          <a href="/tankfuellungen/${tankfuellung.id}/edit" class="btn btn-ghost btn-xs">
            Bearbeiten
          </a>
          <button onclick="deleteTankfuellung(${tankfuellung.id})" class="btn btn-ghost btn-xs text-error">
            Löschen
          </button>
        </td>
      `;
      
      tbody.appendChild(row);
    });
  }

  // Verbrauchsübersicht aktualisieren
  function updateVerbrauchsUebersicht(tankfuellungen: typeof currentTankfuellungen) {
    if (tankfuellungen.length < 2) return;

    // Sortiere Tankfüllungen nach Datum
    const sortedTankfuellungen = [...tankfuellungen].sort((a, b) => new Date(a.datum).getTime() - new Date(b.datum).getTime());
    
    // Finde die letzten Tankfüllungen mit dem gleichen Zähler
    const aktiverZaehler = sortedTankfuellungen[sortedTankfuellungen.length - 1]?.zaehler?.id;
    const tankfuellungenGleicherZaehler = sortedTankfuellungen.filter(t => t.zaehler?.id === aktiverZaehler);
    
    if (tankfuellungenGleicherZaehler.length < 2) {
      // Keine ausreichenden Daten für Verbrauchsberechnung
      const aktuellerVerbrauchEl = document.getElementById('aktueller-verbrauch');
      const verbrauchsTrendEl = document.getElementById('verbrauchs-trend');
      const verbrauchsStatusEl = document.getElementById('verbrauchs-status');
      
      if (aktuellerVerbrauchEl) aktuellerVerbrauchEl.textContent = '-';
      if (verbrauchsTrendEl) verbrauchsTrendEl.textContent = 'Unbekannt';
      if (verbrauchsStatusEl) verbrauchsStatusEl.textContent = 'Unbekannt';
      return;
    }

    // Aktueller Verbrauch (letzte 2 Tankfüllungen mit gleichem Zähler)
    const letzte = tankfuellungenGleicherZaehler[tankfuellungenGleicherZaehler.length - 1];
    const vorletzte = tankfuellungenGleicherZaehler[tankfuellungenGleicherZaehler.length - 2];
    const stundenDifferenz = letzte.zaehlerstand - vorletzte.zaehlerstand;
    const verbrauch = stundenDifferenz > 0 ? (vorletzte.liter / stundenDifferenz).toFixed(1) : '-';

    // Trend berechnen
    let trend = 'Stabil';
    let trendColor = 'text-base-content/70';
    
    if (tankfuellungenGleicherZaehler.length >= 3) {
      const drittletzte = tankfuellungenGleicherZaehler[tankfuellungenGleicherZaehler.length - 3];
      const stundenDifferenzAlt = vorletzte.zaehlerstand - drittletzte.zaehlerstand;
      
      if (stundenDifferenzAlt > 0) {
        const verbrauchAlt = (drittletzte.liter / stundenDifferenzAlt).toFixed(1);
        const verbrauchNeu = parseFloat(verbrauch);
        const verbrauchAltNum = parseFloat(verbrauchAlt);
        
        if (verbrauchNeu < verbrauchAltNum * 0.9) {
          trend = '↘️ Abnehmend';
          trendColor = 'text-green-600 dark:text-green-400';
        } else if (verbrauchNeu > verbrauchAltNum * 1.1) {
          trend = '↗️ Zunehmend';
          trendColor = 'text-red-600 dark:text-red-400';
        }
      }
    }

    // Status aktualisieren
    const aktuellerVerbrauchEl = document.getElementById('aktueller-verbrauch');
    const verbrauchsTrendEl = document.getElementById('verbrauchs-trend');
    const verbrauchsStatusEl = document.getElementById('verbrauchs-status');

    if (aktuellerVerbrauchEl) aktuellerVerbrauchEl.textContent = `${verbrauch} L/h`;
    if (verbrauchsTrendEl) {
      verbrauchsTrendEl.textContent = trend;
      verbrauchsTrendEl.className = `text-lg font-medium ${trendColor}`;
    }
    if (verbrauchsStatusEl) verbrauchsStatusEl.textContent = verbrauch !== '-' ? 'Normal' : 'Unbekannt';
  }

  // Verbrauchs-Chart rendern
  function renderVerbrauchsChart(tankfuellungen: typeof currentTankfuellungen) {
    const canvas = document.getElementById('verbrauchs-chart') as HTMLCanvasElement;
    if (!canvas) {
      console.error('Canvas-Element nicht gefunden');
      return;
    }

    // Chart zerstören falls vorhanden
    if (verbrauchsChart) {
      verbrauchsChart.destroy();
      verbrauchsChart = null;
    }

    // Mindestens 2 Tankfüllungen für Chart benötigt
    if (tankfuellungen.length < 2) {
      console.log('Nicht genügend Tankfüllungen für Chart');
      canvas.getContext('2d')?.clearRect(0, 0, canvas.width, canvas.height);
      return;
    }

    try {
      // Daten für Chart vorbereiten - sortiert nach Datum
      const sortedTankfuellungen = [...tankfuellungen].sort((a, b) => new Date(a.datum).getTime() - new Date(b.datum).getTime());
      
      const labels: string[] = [];
      const data: number[] = [];
      
      // Verbrauch zwischen aufeinanderfolgenden Tankfüllungen berechnen
      for (let i = 1; i < sortedTankfuellungen.length; i++) {
        const aktuelle = sortedTankfuellungen[i];
        const vorherige = sortedTankfuellungen[i - 1];
        
        // Nur wenn beide Tankfüllungen den gleichen Zähler haben
        if (aktuelle.zaehler?.id === vorherige.zaehler?.id) {
          const stundenDifferenz = aktuelle.zaehlerstand - vorherige.zaehlerstand;
          if (stundenDifferenz > 0) {
            const verbrauch = vorherige.liter / stundenDifferenz;
            labels.push(new Date(aktuelle.datum).toLocaleDateString('de-DE'));
            data.push(verbrauch);
            console.log(`Chart-Datenpunkt: ${new Date(aktuelle.datum).toLocaleDateString('de-DE')} - Verbrauch: ${verbrauch.toFixed(2)} L/h (${vorherige.liter}L / ${stundenDifferenz}h)`);
          }
        }
      }

      if (data.length === 0) {
        console.log('Keine gültigen Verbrauchsdaten für Chart');
        return;
      }

      console.log('Chart-Daten:', { labels, data });

      verbrauchsChart = new Chart(canvas, {
        type: 'line',
        data: {
          labels: labels,
          datasets: [{
            label: 'Verbrauch (L/h)',
            data: data,
            borderColor: 'rgb(59, 130, 246)',
            backgroundColor: 'rgba(59, 130, 246, 0.1)',
            tension: 0.1,
            fill: true,
            pointBackgroundColor: 'rgb(59, 130, 246)',
            pointBorderColor: 'rgb(59, 130, 246)',
            pointRadius: 4,
            pointHoverRadius: 6
          }]
        },
        options: {
          responsive: true,
          maintainAspectRatio: false,
          plugins: {
            legend: {
              display: true,
              position: 'top'
            },
            tooltip: {
              callbacks: {
                label: function(context) {
                  return `Verbrauch: ${context.parsed.y.toFixed(2)} L/h`;
                }
              }
            }
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: 'Verbrauch (L/h)'
              },
              ticks: {
                callback: function(value) {
                  return Number(value).toFixed(1) + ' L/h';
                }
              }
            },
            x: {
              title: {
                display: true,
                text: 'Datum'
              }
            }
          }
        }
      });
    } catch (error) {
      console.error('Fehler beim Erstellen des Charts:', error);
    }
  }

  // Tankfüllung löschen
  async function deleteTankfuellung(id: number) {
    if (!confirm('Möchten Sie diese Tankfüllung wirklich löschen?')) {
      return;
    }
    
    try {
      const response = await fetch(`/api/tankfuellungen/${id}`, {
        method: 'DELETE',
      });
      
      if (response.ok) {
        alert('Tankfüllung erfolgreich gelöscht!');
        loadTankfuellungen(); // Neu laden
      } else {
        const errorData = await response.json();
        alert(`Fehler beim Löschen der Tankfüllung: ${errorData.error || 'Unbekannter Fehler'}`);
      }
    } catch (error) {
      console.error('Fehler beim Löschen:', error);
      alert('Ein Fehler ist aufgetreten');
    }
  }

  // Funktion global verfügbar machen
  (window as any).deleteTankfuellung = deleteTankfuellung;

  // Lade-Animation anzeigen/verstecken
  function showLoading(show: boolean) {
    const loading = document.getElementById('loading');
    if (loading) {
      loading.classList.toggle('hidden', !show);
    }
  }

  // Keine Daten anzeigen
  function showNoData() {
    const noData = document.getElementById('no-data');
    if (noData) {
      noData.classList.remove('hidden');
    }
  }

  // Event-Listener
  document.addEventListener('DOMContentLoaded', () => {
    loadAktuellerZaehler();
    loadTankfuellungen();
  });
</script>
