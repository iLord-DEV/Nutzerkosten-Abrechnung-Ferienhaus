---
import Button from '../components/ui/Button.astro';
import FormInput from '../components/ui/FormInput.astro';
---

<!DOCTYPE html>
<html lang="de" data-theme="wuestenstein">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Anmelden - Nutzerkosten-Abrechnung für Wohngemeinschaften" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content="Astro" />
    <title>Anmelden - Nutzerkosten</title>
  </head>
  <body class="min-h-screen bg-base-200">
    <!-- Toast Container für Notifications -->
    <div id="toast-container" class="toast toast-top toast-end"></div>

    <div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
      <div class="max-w-md w-full">
        <!-- Header mit Icon und Titel -->
        <div class="text-center mb-8 animate-fade-in">
          <div class="mx-auto w-16 h-16 bg-primary rounded-2xl flex items-center justify-center shadow-lg mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-primary-content">
              <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
            </svg>
          </div>
          <h1 class="text-4xl font-bold text-base-content mb-2">
            Willkommen zurück
          </h1>
          <p class="text-base-content/70">
            Melden Sie sich an, um auf Ihre Nutzerkosten zuzugreifen
          </p>
        </div>

        <!-- Login Card -->
        <div class="card bg-base-100 shadow-xl animate-slide-up">
          <div class="card-body">
            <form id="login-form" class="space-y-4">
              <!-- Error Alert -->
              <div id="error-alert" class="alert alert-error hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span id="error-message">Fehler</span>
              </div>

              <!-- Email Input -->
              <div class="form-control">
                <label class="label">
                  <span class="label-text font-medium">E-Mail-Adresse</span>
                </label>
                <label class="input input-bordered flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 opacity-70">
                    <path d="M2.5 3A1.5 1.5 0 0 0 1 4.5v.793c.026.009.051.02.076.032L7.674 8.51c.206.1.446.1.652 0l6.598-3.185A.755.755 0 0 1 15 5.293V4.5A1.5 1.5 0 0 0 13.5 3h-11Z" />
                    <path d="M15 6.954 8.978 9.86a2.25 2.25 0 0 1-1.956 0L1 6.954V11.5A1.5 1.5 0 0 0 2.5 13h11a1.5 1.5 0 0 0 1.5-1.5V6.954Z" />
                  </svg>
                  <input
                    type="email"
                    id="email-address"
                    name="email"
                    autocomplete="email"
                    required
                    class="grow"
                    placeholder="ihre@email.de"
                  />
                </label>
              </div>

              <!-- Password Input -->
              <div class="form-control">
                <label class="label">
                  <span class="label-text font-medium">Passwort</span>
                </label>
                <label class="input input-bordered flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 opacity-70">
                    <path fill-rule="evenodd" d="M14 6a4 4 0 0 1-4.899 3.899l-1.955 1.955a.5.5 0 0 1-.353.146H5v1.5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1-.5-.5v-2.293a.5.5 0 0 1 .146-.353l3.955-3.955A4 4 0 1 1 14 6Zm-4-2a.75.75 0 0 0 0 1.5.5.5 0 0 1 .5.5.75.75 0 0 0 1.5 0 2 2 0 0 0-2-2Z" clip-rule="evenodd" />
                  </svg>
                  <input
                    type="password"
                    id="password"
                    name="password"
                    autocomplete="current-password"
                    required
                    class="grow"
                    placeholder="••••••••"
                  />
                </label>
              </div>

              <!-- Remember Me & Forgot Password -->
              <div class="flex items-center justify-between text-sm">
                <label class="label cursor-pointer gap-2 p-0">
                  <input type="checkbox" id="remember-me" name="remember-me" class="checkbox checkbox-sm checkbox-primary" />
                  <span class="label-text">Angemeldet bleiben</span>
                </label>
                <a href="#" class="link link-primary link-hover">
                  Passwort vergessen?
                </a>
              </div>

              <!-- Submit Button -->
              <button type="submit" id="submit-btn" class="btn btn-primary btn-block">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.5 10.5V6.75a4.5 4.5 0 10-9 0v3.75m-.75 11.25h10.5a2.25 2.25 0 002.25-2.25v-6.75a2.25 2.25 0 00-2.25-2.25H6.75a2.25 2.25 0 00-2.25 2.25v6.75a2.25 2.25 0 002.25 2.25z" />
                </svg>
                <span id="submit-text">Anmelden</span>
              </button>

              <!-- Register Link -->
              <div class="divider text-sm opacity-50">oder</div>
              <div class="text-center">
                <p class="text-sm text-base-content/70">
                  Noch kein Konto?
                  <a href="#" class="link link-primary font-medium">
                    Jetzt registrieren
                  </a>
                </p>
              </div>
            </form>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>

<script>
  const loginForm = document.getElementById('login-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const submitText = document.getElementById('submit-text') as HTMLSpanElement;
  const errorAlert = document.getElementById('error-alert') as HTMLDivElement;
  const errorMessage = document.getElementById('error-message') as HTMLSpanElement;

  function showError(message: string) {
    errorMessage.textContent = message;
    errorAlert.classList.remove('hidden');
    setTimeout(() => {
      errorAlert.classList.add('hidden');
    }, 5000);
  }

  function setLoading(loading: boolean) {
    if (loading) {
      submitBtn.disabled = true;
      submitBtn.classList.add('loading');
      submitText.textContent = 'Wird angemeldet...';
    } else {
      submitBtn.disabled = false;
      submitBtn.classList.remove('loading');
      submitText.textContent = 'Anmelden';
    }
  }

  if (loginForm) {
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Hide previous errors
      errorAlert.classList.add('hidden');

      const formData = new FormData(e.target as HTMLFormElement);
      const email = formData.get('email') as string;
      const password = formData.get('password') as string;

      setLoading(true);

      try {
        const response = await fetch('/api/auth/login', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ email, password }),
        });

        const data = await response.json();

        if (data.success) {
          // Erfolgreicher Login
          console.log('Login erfolgreich:', data.user);

          // Success toast
          const toast = document.createElement('div');
          toast.className = 'alert alert-success shadow-lg';
          toast.innerHTML = `
            <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z" />
            </svg>
            <span>Login erfolgreich! Weiterleitung...</span>
          `;
          document.getElementById('toast-container')?.appendChild(toast);

          // Kurz warten, damit der Cookie gesetzt wird
          setTimeout(() => {
            // Weiterleitung basierend auf der Rolle
            if (data.user.role === 'ADMIN') {
              window.location.href = '/admin/dashboard';
            } else {
              window.location.href = '/dashboard';
            }
          }, 300);
        } else {
          // Fehler anzeigen
          setLoading(false);
          showError(data.error || 'Login fehlgeschlagen. Bitte überprüfen Sie Ihre Zugangsdaten.');
        }
      } catch (error) {
        console.error('Login-Fehler:', error);
        setLoading(false);
        showError('Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut.');
      }
    });
  }
</script>

<style>
  @import '../styles/global.css';

  /* Animations */
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slide-up {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fade-in 0.6s ease-out;
  }

  .animate-slide-up {
    animation: slide-up 0.6s ease-out 0.2s both;
  }
</style>
