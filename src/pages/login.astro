---
import Button from '../components/ui/Button.astro';
import FormInput from '../components/ui/FormInput.astro';
import '../styles/global.css';
import { getUser } from '../utils/auth';

// Prüfen ob User bereits eingeloggt ist → Server-Redirect
const user = await getUser(Astro);
if (user) {
  const redirectTo = user.role === 'ADMIN' ? '/admin/dashboard' : '/dashboard';
  return Astro.redirect(redirectTo);
}
---

<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content="Anmelden - Nutzerkosten-Abrechnung für Wohngemeinschaften" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content="Astro" />
    <title>Anmelden - Nutzerkosten</title>
    <script is:inline>
      (function() {
        const stored = localStorage.getItem('theme');
        const systemPrefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
        const theme = stored || (systemPrefersDark ? 'dark' : 'light');
        document.documentElement.setAttribute('data-theme', theme);
      })();
    </script>
  </head>
  <body class="min-h-screen bg-base-200">
    <!-- Toast Container für Notifications -->
    <div id="toast-container" class="toast toast-top toast-end"></div>

    <div class="min-h-screen flex items-center justify-center py-12 px-4 sm:px-6 lg:px-8">
      <div class="max-w-md w-full">
        <!-- Header mit Icon und Titel -->
        <div class="text-center mb-8 animate-fade-in">
          <div class="mx-auto w-16 h-16 bg-primary rounded-2xl flex items-center justify-center shadow-lg mb-4">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10 text-primary-content">
              <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
            </svg>
          </div>
          <h1 class="text-4xl font-bold text-base-content mb-2">
            Willkommen zurück
          </h1>
          <p class="text-base-content/70">
            Melden Sie sich mit einem Magic-Link an
          </p>
        </div>

        <!-- Login Card -->
        <div class="card bg-base-100 shadow-xl animate-slide-up">
          <div class="card-body">
            <!-- Token einfügen (nur für PWA sichtbar) -->
            <div id="pwa-token-section" class="hidden">
              <div class="bg-base-200 rounded-lg p-4">
                <p class="text-sm font-medium mb-2">Code aus E-Mail einfügen:</p>
                <div class="flex gap-2">
                  <input
                    type="text"
                    id="paste-token-input"
                    class="input input-bordered input-sm flex-1 font-mono"
                    placeholder="abc123def456..."
                  />
                  <button type="button" id="paste-token-btn" class="btn btn-sm btn-primary">
                    OK
                  </button>
                </div>
                <p id="paste-token-error" class="text-xs text-error mt-2 hidden"></p>
              </div>
              <div class="divider text-xs text-base-content/50">oder neuen Code anfordern</div>
            </div>

            <form id="login-form" class="space-y-4">
              <!-- Error Alert -->
              <div id="error-alert" class="alert alert-error hidden">
                <svg xmlns="http://www.w3.org/2000/svg" class="stroke-current shrink-0 h-6 w-6" fill="none" viewBox="0 0 24 24">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 14l2-2m0 0l2-2m-2 2l-2-2m2 2l2 2m7-2a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span id="error-message">Fehler</span>
              </div>

              <!-- Email/Username Input -->
              <div class="form-control">
                <label class="label">
                  <span class="label-text font-medium">E-Mail oder Benutzername</span>
                </label>
                <label class="input input-bordered flex items-center gap-2">
                  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 16 16" fill="currentColor" class="w-4 h-4 opacity-70">
                    <path d="M8 8a3 3 0 1 0 0-6 3 3 0 0 0 0 6ZM12.735 14c.618 0 1.093-.561.872-1.139a6.002 6.002 0 0 0-11.215 0c-.22.578.254 1.139.872 1.139h9.47Z" />
                  </svg>
                  <input
                    type="text"
                    id="identifier"
                    name="identifier"
                    autocomplete="username"
                    required
                    class="grow"
                    placeholder="ihre@email.de oder benutzername"
                  />
                </label>
              </div>

              <!-- Info Alert -->
              <div class="alert alert-info">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6">
                  <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>
                </svg>
                <span class="text-sm">Wir senden Ihnen einen Anmelde-Link per E-Mail. Dieser ist 15 Minuten gültig.</span>
              </div>

              <!-- Submit Button -->
              <button type="submit" id="submit-btn" class="btn btn-primary btn-block">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M21.75 6.75v10.5a2.25 2.25 0 01-2.25 2.25h-15a2.25 2.25 0 01-2.25-2.25V6.75m19.5 0A2.25 2.25 0 0019.5 4.5h-15a2.25 2.25 0 00-2.25 2.25m19.5 0v.243a2.25 2.25 0 01-1.07 1.916l-7.5 4.615a2.25 2.25 0 01-2.36 0L3.32 8.91a2.25 2.25 0 01-1.07-1.916V6.75" />
                </svg>
                <span id="submit-text">Magic-Link anfordern</span>
              </button>

            </form>
          </div>
        </div>
      </div>
    </div>
  </body>
</html>

<script>
  const loginForm = document.getElementById('login-form') as HTMLFormElement;
  const submitBtn = document.getElementById('submit-btn') as HTMLButtonElement;
  const submitText = document.getElementById('submit-text') as HTMLSpanElement;
  const errorAlert = document.getElementById('error-alert') as HTMLDivElement;
  const errorMessage = document.getElementById('error-message') as HTMLSpanElement;

  // PWA-Erkennung - Token-Sektion nur in PWA anzeigen
  const isPWA = window.matchMedia('(display-mode: standalone)').matches
             || (window.navigator as any).standalone === true;

  const pwaTokenSection = document.getElementById('pwa-token-section');
  if (isPWA && pwaTokenSection) {
    pwaTokenSection.classList.remove('hidden');
  }

  // Token einfügen Handler
  const pasteTokenInput = document.getElementById('paste-token-input') as HTMLInputElement;
  const pasteTokenBtn = document.getElementById('paste-token-btn') as HTMLButtonElement;
  const pasteTokenError = document.getElementById('paste-token-error') as HTMLParagraphElement;

  if (pasteTokenBtn && pasteTokenInput) {
    pasteTokenBtn.addEventListener('click', async () => {
      let token = pasteTokenInput.value.trim();

      if (!token) {
        pasteTokenError.textContent = 'Bitte füge den Code ein';
        pasteTokenError.classList.remove('hidden');
        return;
      }

      // Falls jemand doch die volle URL einfügt, Token extrahieren
      if (token.includes('token=')) {
        token = token.split('token=')[1]?.split('&')[0] || token;
      }

      // Token sollte nur hex-Zeichen enthalten (a-f, 0-9)
      if (!/^[a-f0-9]+$/i.test(token)) {
        pasteTokenError.textContent = 'Ungültiger Code';
        pasteTokenError.classList.remove('hidden');
        return;
      }

      // Button deaktivieren während Verarbeitung
      pasteTokenBtn.disabled = true;
      pasteTokenBtn.textContent = '...';

      try {
        // Direkt API aufrufen statt zu /verify zu navigieren (iOS PWA Fix)
        const response = await fetch('/api/auth/verify-magic-link', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ token }),
        });

        const data = await response.json();

        if (data.success) {
          // Erfolg - Seite neu laden, Server macht den Redirect
          window.location.reload();
        } else {
          pasteTokenError.textContent = data.error || 'Ungültiger Code';
          pasteTokenError.classList.remove('hidden');
          pasteTokenBtn.disabled = false;
          pasteTokenBtn.textContent = 'OK';
        }
      } catch (error) {
        pasteTokenError.textContent = 'Fehler bei der Anmeldung';
        pasteTokenError.classList.remove('hidden');
        pasteTokenBtn.disabled = false;
        pasteTokenBtn.textContent = 'OK';
      }
    });

    // Enter-Taste im Input-Feld
    pasteTokenInput.addEventListener('keypress', (e) => {
      if (e.key === 'Enter') {
        e.preventDefault();
        pasteTokenBtn.click();
      }
    });

    // Fehler ausblenden bei Eingabe
    pasteTokenInput.addEventListener('input', () => {
      pasteTokenError.classList.add('hidden');
    });
  }

  function showError(message: string) {
    errorMessage.textContent = message;
    errorAlert.classList.remove('hidden');
    setTimeout(() => {
      errorAlert.classList.add('hidden');
    }, 5000);
  }

  function setLoading(loading: boolean) {
    if (loading) {
      submitBtn.disabled = true;
      submitBtn.classList.add('loading');
      submitText.textContent = 'Wird gesendet...';
    } else {
      submitBtn.disabled = false;
      submitBtn.classList.remove('loading');
      submitText.textContent = 'Magic-Link anfordern';
    }
  }

  if (loginForm) {
    loginForm.addEventListener('submit', async (e) => {
      e.preventDefault();

      // Hide previous errors
      errorAlert.classList.add('hidden');

      const formData = new FormData(e.target as HTMLFormElement);
      const identifier = formData.get('identifier') as string;

      if (!identifier || identifier.trim() === '') {
        showError('Bitte geben Sie Ihre E-Mail oder Ihren Benutzernamen ein.');
        return;
      }

      setLoading(true);

      try {
        const response = await fetch('/api/auth/request-magic-link', {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify({ identifier: identifier.trim(), isPWA }),
        });

        const data = await response.json();

        if (data.success) {
          // Erfolg - Redirect zur Bestätigungsseite
          // In Development: Magic-Link als URL-Parameter mitgeben
          const url = data.magicLink
            ? `/magic-link-gesendet?link=${encodeURIComponent(data.magicLink)}`
            : '/magic-link-gesendet';
          window.location.href = url;
        } else {
          // Fehler anzeigen
          setLoading(false);
          showError(data.error || 'Fehler beim Senden des Magic-Links');
        }
      } catch (error) {
        console.error('Magic-Link-Fehler:', error);
        setLoading(false);
        showError('Ein Fehler ist aufgetreten. Bitte versuchen Sie es erneut.');
      }
    });
  }
</script>

<style>
  /* Animations */
  @keyframes fade-in {
    from {
      opacity: 0;
      transform: translateY(-10px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  @keyframes slide-up {
    from {
      opacity: 0;
      transform: translateY(20px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }

  .animate-fade-in {
    animation: fade-in 0.6s ease-out;
  }

  .animate-slide-up {
    animation: slide-up 0.6s ease-out 0.2s both;
  }
</style>
