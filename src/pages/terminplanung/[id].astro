---
import Layout from '../../layouts/ProtectedLayout.astro';
import { getUser } from '../../utils/auth';
import { PrismaClient } from '@prisma/client';

const prisma = new PrismaClient();
const user = await getUser(Astro);
const { id } = Astro.params;

// Terminplanung server-seitig laden
let terminplanung = null;
try {
  terminplanung = await prisma.terminPlanung.findUnique({
    where: { id: parseInt(id!) },
    include: {
      user: {
        select: {
          id: true,
          name: true,
          email: true
        }
      },
      abstimmungen: {
        include: {
          user: {
            select: {
              id: true,
              name: true
            }
          }
        }
      },
      kommentare: {
        include: {
          user: {
            select: {
              id: true,
              name: true
            }
          },
          parent: {
            include: {
              user: {
                select: {
                  id: true,
                  name: true
                }
              }
            }
          },
          replies: {
            include: {
              user: {
                select: {
                  id: true,
                  name: true
                }
              }
            },
            orderBy: {
              createdAt: 'asc'
            }
          }
        },
        where: {
          parentId: null
        },
        orderBy: {
          createdAt: 'desc'
        }
      },
      aenderungen: {
        include: {
          user: {
            select: {
              id: true,
              name: true
            }
          }
        },
        orderBy: {
          createdAt: 'desc'
        }
      }
    }
  });
} catch (error) {
  console.error('Fehler beim Laden der Terminplanung:', error);
}

if (!terminplanung) {
  await prisma.$disconnect();
  return new Response('Terminplanung nicht gefunden', { status: 404 });
}

await prisma.$disconnect();
---

<Layout title="Terminplanung Details">
  <div class="container mx-auto px-4 py-8">
    <div class="mb-6">
      <a href="/terminplanung" class="text-blue-600 hover:text-blue-800 flex items-center gap-2">
        ‚Üê Zur√ºck zur √úbersicht
      </a>
    </div>

    <div id="terminplanung-details" class="max-w-4xl mx-auto">
      <!-- Terminplanung wird hier dynamisch geladen -->
    </div>
    
    <!-- Versteckte Daten f√ºr JavaScript -->
    <script>
      window.terminplanungData = {JSON.stringify(terminplanung)};
    </script>
    
  </div>

  <!-- Abstimmungs-Modal -->
  <div id="abstimmungModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg max-w-md w-full p-6">
        <h3 class="text-lg font-semibold mb-4">Abstimmung</h3>
        <form id="abstimmungForm">
          <div class="mb-4">
            <label class="block text-sm font-medium text-gray-700 mb-3">Deine Stimme:</label>
            <div class="space-y-2">
              <label class="flex items-center">
                <input type="radio" name="stimme" value="APPROVE" class="mr-3">
                <span class="text-green-700">‚úÖ Zustimmen</span>
              </label>
              <label class="flex items-center">
                <input type="radio" name="stimme" value="NEED_INFO" class="mr-3">
                <span class="text-yellow-700">‚ùì Brauche mehr Infos / Diskussion</span>
              </label>
            </div>
          </div>
          
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Kommentar (optional)</label>
            <textarea 
              id="kommentar" 
              name="kommentar" 
              rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Deine Gedanken zu diesem Termin..."
            ></textarea>
          </div>
          
          <div class="flex justify-end gap-3">
            <button 
              type="button" 
              id="abstimmungCancelBtn"
              class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50"
            >
              Abbrechen
            </button>
            <button 
              type="submit" 
              class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
            >
              Stimme abgeben
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Bearbeitungs-Modal -->
  <div id="editModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg max-w-md w-full p-6">
        <h3 class="text-lg font-semibold mb-4">Terminplanung bearbeiten</h3>
        <form id="editForm">
          <input type="hidden" id="editTerminplanungId" name="terminplanungId">
          <div class="mb-4">
            <label for="editTitel" class="block text-sm font-medium text-gray-700 mb-2">Titel</label>
            <input 
              type="text" 
              id="editTitel" 
              name="titel" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>
          <div class="mb-4">
            <label for="editStartDatum" class="block text-sm font-medium text-gray-700 mb-2">Startdatum</label>
            <input 
              type="date" 
              id="editStartDatum" 
              name="startDatum" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>
          <div class="mb-4">
            <label for="editEndDatum" class="block text-sm font-medium text-gray-700 mb-2">Enddatum</label>
            <input 
              type="date" 
              id="editEndDatum" 
              name="endDatum" 
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              required
            />
          </div>
          <div class="mb-6">
            <label for="editBeschreibung" class="block text-sm font-medium text-gray-700 mb-2">Beschreibung</label>
            <textarea 
              id="editBeschreibung" 
              name="beschreibung" 
              rows="3"
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
            ></textarea>
          </div>
          
          <div class="flex justify-end gap-3">
            <button 
              type="button" 
              id="editCancelBtn"
              class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50"
            >
              Abbrechen
            </button>
            <button 
              type="submit" 
              class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
            >
              Speichern
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Kommentar-Modal -->
  <div id="kommentarModal" class="fixed inset-0 bg-black bg-opacity-50 hidden z-50">
    <div class="flex items-center justify-center min-h-screen p-4">
      <div class="bg-white rounded-lg max-w-md w-full p-6">
        <h3 class="text-lg font-semibold mb-4">Kommentar hinzuf√ºgen</h3>
        <form id="kommentarForm">
          <input type="hidden" id="kommentarTerminplanungId" name="terminplanungId">
          <input type="hidden" id="kommentarParentId" name="parentId">
          <div class="mb-6">
            <label class="block text-sm font-medium text-gray-700 mb-2">Dein Kommentar:</label>
            <textarea 
              id="kommentarInhalt" 
              name="kommentarInhalt" 
              rows="4"
              required
              class="w-full px-3 py-2 border border-gray-300 rounded-md focus:outline-none focus:ring-2 focus:ring-blue-500"
              placeholder="Was m√∂chtest du zu diesem Termin sagen?"
            ></textarea>
          </div>
          
          <div class="flex justify-end gap-3">
            <button 
              type="button" 
              id="kommentarCancelBtn"
              class="px-4 py-2 text-gray-600 border border-gray-300 rounded-md hover:bg-gray-50"
            >
              Abbrechen
            </button>
            <button 
              type="submit" 
              class="px-4 py-2 bg-blue-600 text-white rounded-md hover:bg-blue-700"
            >
              Kommentar hinzuf√ºgen
            </button>
          </div>
        </form>
      </div>
    </div>
  </div>
</Layout>

<script>
  const terminplanungId = parseInt(window.location.pathname.split('/').pop());
  let currentUser = null;
  
  // Terminplanung-Daten vom Server √ºbernehmen
  let terminplanung = null;
  
  // User-Info laden
  async function loadCurrentUser() {
    try {
      const response = await fetch('/api/auth/me');
      if (response.ok) {
        currentUser = await response.json();
        // Terminplanung-Daten vom Server laden
        if (window.terminplanungData) {
          terminplanung = JSON.parse(window.terminplanungData);
          renderTerminplanung();
        } else {
          loadTerminplanung();
        }
      } else {
        console.error('User-Auth fehlgeschlagen:', response.status);
      }
    } catch (error) {
      console.error('Fehler beim Laden der User-Info:', error);
    }
  }
  
  // Sofortige Initialisierung
  if (window.terminplanungData) {
    terminplanung = JSON.parse(window.terminplanungData);
    loadCurrentUser();
  } else {
    loadCurrentUser();
  }

  // Terminplanung neu laden (f√ºr Updates)
  async function loadTerminplanung() {
    try {
      console.log('Lade Terminplanung f√ºr ID:', terminplanungId);
      const response = await fetch(`/api/terminplanung/${terminplanungId}`);
      if (response.ok) {
        terminplanung = await response.json();
        console.log('Terminplanung geladen:', terminplanung);
        renderTerminplanung();
      } else {
        const error = await response.json();
        console.error('API-Fehler:', error);
        const detailsEl = document.getElementById('terminplanung-details');
        if (detailsEl) {
          detailsEl.innerHTML = `
            <div class="text-center py-8">
              <p class="text-red-600">Fehler: ${error.error}</p>
            </div>
          `;
        }
      }
    } catch (error) {
      console.error('Fehler beim Laden der Terminplanung:', error);
      const detailsEl = document.getElementById('terminplanung-details');
      if (detailsEl) {
        detailsEl.innerHTML = `
          <div class="text-center py-8">
            <p class="text-red-600">Fehler beim Laden der Terminplanung</p>
          </div>
        `;
      }
    }
  }

  // Terminplanung rendern
  function renderTerminplanung() {
    console.log('renderTerminplanung aufgerufen, terminplanung:', terminplanung);
    if (!terminplanung) {
      console.log('Keine Terminplanung gefunden');
      return;
    }

    const statusColor = 
      terminplanung.status === 'APPROVED' ? 'bg-green-100 text-green-800' :
      terminplanung.status === 'DISCUSSING' ? 'bg-yellow-100 text-yellow-800' :
      terminplanung.status === 'PENDING' ? 'bg-orange-100 text-orange-800' :
      'bg-gray-100 text-gray-800';

    const statusText = 
      terminplanung.status === 'APPROVED' ? 'Freigegeben' :
      terminplanung.status === 'DISCUSSING' ? 'In Diskussion' :
      terminplanung.status === 'PENDING' ? 'Warten auf Abstimmungen' :
      'Storniert';

    // Pr√ºfen ob User bereits abgestimmt hat
    const userAbstimmung = terminplanung.abstimmungen.find(a => 
      a.userId === currentUser?.id && a.version === terminplanung.version
    );

    const canEdit = (terminplanung.userId === currentUser?.id || currentUser?.role === 'ADMIN');
    const canVote = terminplanung.userId !== currentUser?.id && terminplanung.status !== 'CANCELLED';

    const detailsEl = document.getElementById('terminplanung-details');
    if (!detailsEl) {
      console.error('terminplanung-details Element nicht gefunden');
      return;
    }
    
    detailsEl.innerHTML = `
      <div class="bg-white rounded-lg shadow-lg p-6">
        <!-- Header -->
        <div class="flex justify-between items-start mb-6">
          <div>
            <h1 class="text-2xl font-bold text-gray-900 mb-2">${terminplanung.titel}</h1>
            <div class="flex items-center gap-4 text-sm text-gray-600">
              <span>von ${terminplanung.user.name}</span>
              <span>‚Ä¢</span>
              <span>Version ${terminplanung.version}</span>
            </div>
          </div>
          <span class="px-3 py-1 rounded-full text-sm font-medium ${statusColor}">
            ${statusText}
          </span>
        </div>

        <!-- Termin-Details -->
        <div class="mb-6 p-4 bg-gray-50 rounded-lg">
          <h3 class="font-semibold text-gray-900 mb-2">Termin</h3>
          <div class="text-lg">
            ${new Date(terminplanung.startDatum).toLocaleDateString('de-DE', { 
              weekday: 'long', 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            })} - 
            ${new Date(terminplanung.endDatum).toLocaleDateString('de-DE', { 
              weekday: 'long', 
              year: 'numeric', 
              month: 'long', 
              day: 'numeric' 
            })}
          </div>
          ${terminplanung.beschreibung ? `
            <div class="mt-2 text-gray-700">
              <strong>Beschreibung:</strong><br>
              ${terminplanung.beschreibung}
            </div>
          ` : ''}
        </div>

        <!-- Aktionen -->
        <div class="flex gap-3 mb-6">
          ${(terminplanung.userId === currentUser?.id || currentUser?.role === 'ADMIN') ? `
            <button 
              onclick="editTerminplanung()"
              class="px-4 py-2 bg-blue-100 text-blue-700 rounded hover:bg-blue-200"
            >
              Bearbeiten
            </button>
            <button 
              onclick="cancelTerminplanung()"
              class="px-4 py-2 bg-red-100 text-red-700 rounded hover:bg-red-200"
            >
              Stornieren
            </button>
          ` : ''}
          ${canVote ? `
            ${terminplanung.abstimmungen.some(a => a.userId === currentUser?.id && a.stimme === 'APPROVE' && a.version === terminplanung.version) ? `
              <button 
                onclick="window.zustimmungEntziehen(${terminplanung.id})"
                class="px-4 py-2 bg-red-600 text-white rounded hover:bg-red-700 font-medium"
              >
                ‚ùå Zustimmung entziehen
              </button>
            ` : `
              <button 
                onclick="window.zustimmen(${terminplanung.id})"
                class="px-4 py-2 bg-green-600 text-white rounded hover:bg-green-700 font-medium"
              >
                ‚úÖ Zustimmen
              </button>
            `}
          ` : ''}
          <button 
            onclick="window.openKommentarModal()"
            class="px-4 py-2 bg-yellow-100 text-yellow-700 rounded hover:bg-yellow-200"
          >
            Kommentieren
          </button>
        </div>

        <!-- Abstimmungen -->
        <div class="mb-6">
          <h3 class="font-semibold text-gray-900 mb-3">Abstimmungen (Version ${terminplanung.version})</h3>
          <div class="space-y-2">
            ${terminplanung.abstimmungen
              .filter(a => a.version === terminplanung.version)
              .map(abstimmung => `
                <div class="flex items-center justify-between p-3 bg-gray-50 rounded">
                  <div class="flex items-center gap-3">
                    <span class="font-medium">${abstimmung.user.name}</span>
                    <span class="px-2 py-1 rounded text-xs ${
                      abstimmung.stimme === 'APPROVE' ? 'bg-green-100 text-green-800' : 'bg-yellow-100 text-yellow-800'
                    }">
                      ${abstimmung.stimme === 'APPROVE' ? '‚úÖ Zustimmen' : '‚ùì Mehr Infos'}
                    </span>
                  </div>
                  <span class="text-sm text-gray-500">
                    ${new Date(abstimmung.createdAt).toLocaleDateString('de-DE')}
                  </span>
                </div>
                ${abstimmung.kommentar ? `
                  <div class="ml-6 p-2 bg-white rounded text-sm text-gray-700">
                    "${abstimmung.kommentar}"
                  </div>
                ` : ''}
              `).join('')}
            ${terminplanung.abstimmungen.filter(a => a.version === terminplanung.version).length === 0 ? 
              '<p class="text-gray-500 text-sm">Noch keine Abstimmungen</p>' : ''}
          </div>
          
          <!-- Status-Info -->
          ${terminplanung.status === 'PENDING' ? `
            <div class="mt-4 p-3 bg-orange-50 border border-orange-200 rounded">
              <div class="flex items-center gap-2">
                <span class="text-orange-600">‚è≥</span>
                <span class="text-sm text-orange-800">
                  Warten auf Abstimmungen der anderen Mitglieder
                </span>
              </div>
            </div>
          ` : terminplanung.status === 'DISCUSSING' ? `
            <div class="mt-4 p-3 bg-yellow-50 border border-yellow-200 rounded">
              <div class="flex items-center gap-2">
                <span class="text-yellow-600">üí¨</span>
                <span class="text-sm text-yellow-800">
                  In Diskussion - es gibt Kommentare oder "Mehr Infos" Stimmen
                </span>
              </div>
            </div>
          ` : terminplanung.status === 'APPROVED' ? `
            <div class="mt-4 p-3 bg-green-50 border border-green-200 rounded">
              <div class="flex items-center gap-2">
                <span class="text-green-600">‚úÖ</span>
                <span class="text-sm text-green-800">
                  Termin ist freigegeben - alle haben zugestimmt!
                </span>
              </div>
            </div>
          ` : ''}
        </div>

        <!-- Kommentare -->
        <div class="mb-6">
          <h3 class="font-semibold text-gray-900 mb-3">Kommentare</h3>
          <div class="space-y-3">
            ${terminplanung.kommentare.map(kommentar => `
              <div class="p-3 bg-gray-50 rounded">
                <div class="flex items-center justify-between mb-1">
                  <span class="font-medium text-sm">${kommentar.user.name}</span>
                  <span class="text-xs text-gray-500">
                    ${new Date(kommentar.createdAt).toLocaleDateString('de-DE')} 
                    ${new Date(kommentar.createdAt).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}
                  </span>
                </div>
                <p class="text-gray-700">${kommentar.inhalt}</p>
                
                <!-- Antworten anzeigen -->
                ${kommentar.replies && kommentar.replies.length > 0 ? `
                  <div class="mt-2 ml-6 space-y-2 border-l-2 border-gray-300 pl-3">
                    ${kommentar.replies.map(reply => `
                      <div class="bg-gray-100 p-2 rounded">
                        <div class="flex items-center justify-between mb-1">
                          <span class="font-medium text-xs">${reply.user.name}</span>
                          <span class="text-xs text-gray-500">
                            ${new Date(reply.createdAt).toLocaleDateString('de-DE')} 
                            ${new Date(reply.createdAt).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}
                          </span>
                        </div>
                        <p class="text-xs text-gray-700">${reply.inhalt}</p>
                      </div>
                    `).join('')}
                  </div>
                ` : ''}
                
                <!-- Antwort-Button -->
                <button 
                  onclick="window.antworten(${terminplanung.id}, ${kommentar.id})"
                  class="mt-2 text-xs text-blue-600 hover:text-blue-800"
                >
                  Antworten
                </button>
              </div>
            `).join('')}
            ${terminplanung.kommentare.length === 0 ? 
              '<p class="text-gray-500 text-sm">Noch keine Kommentare</p>' : ''}
          </div>
        </div>

        <!-- √Ñnderungshistorie -->
        ${terminplanung.aenderungen.length > 0 ? `
          <div>
            <h3 class="font-semibold text-gray-900 mb-3">√Ñnderungshistorie</h3>
            <div class="space-y-2">
              ${terminplanung.aenderungen.map(aenderung => `
                <div class="p-3 bg-blue-50 rounded text-sm">
                  <div class="font-medium">${aenderung.user.name} hat die Termine ge√§ndert</div>
                  <div class="text-gray-600 mt-1">
                    <strong>Von:</strong> ${new Date(aenderung.alteStartDatum).toLocaleDateString('de-DE')} - 
                    ${new Date(aenderung.alteEndDatum).toLocaleDateString('de-DE')}<br>
                    <strong>Zu:</strong> ${new Date(aenderung.neueStartDatum).toLocaleDateString('de-DE')} - 
                    ${new Date(aenderung.neueEndDatum).toLocaleDateString('de-DE')}
                  </div>
                  ${aenderung.grund ? `<div class="mt-1 text-gray-700">"${aenderung.grund}"</div>` : ''}
                  <div class="text-xs text-gray-500 mt-1">
                    ${new Date(aenderung.createdAt).toLocaleDateString('de-DE')}
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        ` : ''}
      </div>
    `;
  }

  // Modal-Funktionen
  function openAbstimmungModal() {
    const modal = document.getElementById('abstimmungModal');
    const form = document.getElementById('abstimmungForm');
    
    // Bestehende Abstimmung vorausf√ºllen
    const userAbstimmung = terminplanung.abstimmungen.find(a => 
      a.userId === currentUser?.id && a.version === terminplanung.version
    );
    
    if (userAbstimmung) {
      form.querySelector(`input[value="${userAbstimmung.stimme}"]`).checked = true;
      document.getElementById('kommentar').value = userAbstimmung.kommentar || '';
    } else {
      form.reset();
    }
    
    modal.classList.remove('hidden');
  }

  function closeAbstimmungModal() {
    document.getElementById('abstimmungModal').classList.add('hidden');
  }

  // Globale Funktionen
  window.openKommentarModal = function() {
    const terminplanungIdEl = document.getElementById('kommentarTerminplanungId') as HTMLInputElement;
    const parentIdEl = document.getElementById('kommentarParentId') as HTMLInputElement;
    const modal = document.getElementById('kommentarModal');
    
    if (terminplanungIdEl && parentIdEl && modal) {
      terminplanungIdEl.value = terminplanung.id.toString();
      parentIdEl.value = '';
      modal.classList.remove('hidden');
    }
  };

  window.closeKommentarModal = function() {
    const modal = document.getElementById('kommentarModal');
    const form = document.getElementById('kommentarForm') as HTMLFormElement;
    
    if (modal) modal.classList.add('hidden');
    if (form) form.reset();
  };

  window.antworten = function(terminplanungId: number, parentId: number) {
    const terminplanungIdEl = document.getElementById('kommentarTerminplanungId') as HTMLInputElement;
    const parentIdEl = document.getElementById('kommentarParentId') as HTMLInputElement;
    const modal = document.getElementById('kommentarModal');
    
    if (terminplanungIdEl && parentIdEl && modal) {
      terminplanungIdEl.value = terminplanungId.toString();
      parentIdEl.value = parentId.toString();
      modal.classList.remove('hidden');
    }
  };

  // Event Listeners
  const abstimmungCancelBtn = document.getElementById('abstimmungCancelBtn');
  const kommentarCancelBtn = document.getElementById('kommentarCancelBtn');
  const editCancelBtn = document.getElementById('editCancelBtn');
  
  if (abstimmungCancelBtn) abstimmungCancelBtn.addEventListener('click', closeAbstimmungModal);
  if (kommentarCancelBtn) kommentarCancelBtn.addEventListener('click', window.closeKommentarModal);
  if (editCancelBtn) editCancelBtn.addEventListener('click', () => {
    const modal = document.getElementById('editModal');
    if (modal) modal.classList.add('hidden');
  });

  const abstimmungForm = document.getElementById('abstimmungForm') as HTMLFormElement;
  const kommentarForm = document.getElementById('kommentarForm') as HTMLFormElement;
  
  if (abstimmungForm) {
    abstimmungForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target as HTMLFormElement);
      const data = {
        stimme: formData.get('stimme'),
        kommentar: formData.get('kommentar')
      };
      
      try {
        const response = await fetch(`/api/terminplanung/${terminplanungId}/abstimmung`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        
        if (response.ok) {
          closeAbstimmungModal();
          loadTerminplanung();
        } else {
          const error = await response.json();
          alert('Fehler: ' + error.error);
        }
      } catch (error) {
        console.error('Fehler beim Abgeben der Abstimmung:', error);
        alert('Fehler beim Abgeben der Abstimmung');
      }
    });
  }

  if (kommentarForm) {
    kommentarForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target as HTMLFormElement);
      const data = {
        inhalt: formData.get('kommentarInhalt'),
        parentId: formData.get('parentId') ? parseInt(formData.get('parentId') as string) : null
      };
      
      try {
        const response = await fetch(`/api/terminplanung/${terminplanungId}/kommentar`, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        
        if (response.ok) {
          window.closeKommentarModal();
          loadTerminplanung();
        } else {
          const error = await response.json();
          alert('Fehler: ' + error.error);
        }
      } catch (error) {
        console.error('Fehler beim Erstellen des Kommentars:', error);
        alert('Fehler beim Erstellen des Kommentars');
      }
    });
  }

  // Funktionen
  window.zustimmen = async function(terminplanungId: number) {
    try {
      const response = await fetch(`/api/terminplanung/${terminplanungId}/abstimmung`, {
        method: 'POST',
        headers: {
          'Content-Type': 'application/json'
        },
        body: JSON.stringify({
          stimme: 'APPROVE',
          kommentar: ''
        })
      });
      
      if (response.ok) {
        alert('Zustimmung erfolgreich abgegeben!');
        loadTerminplanung();
      } else {
        const error = await response.json();
        alert('Fehler: ' + error.error);
      }
    } catch (error) {
      console.error('Fehler beim Zustimmen:', error);
      alert('Fehler beim Zustimmen');
    }
  };

  window.zustimmungEntziehen = async function(terminplanungId: number) {
    try {
      const response = await fetch(`/api/terminplanung/${terminplanungId}/abstimmung`, {
        method: 'DELETE',
        headers: {
          'Content-Type': 'application/json'
        }
      });
      
      if (response.ok) {
        alert('Zustimmung erfolgreich entzogen!');
        loadTerminplanung();
      } else {
        const error = await response.json();
        alert('Fehler: ' + error.error);
      }
    } catch (error) {
      console.error('Fehler beim Entziehen der Zustimmung:', error);
      alert('Fehler beim Entziehen der Zustimmung');
    }
  };

  window.editTerminplanung = function() {
    // Modal f√ºr Bearbeitung √∂ffnen und Werte vorausf√ºllen
    const modal = document.getElementById('editModal');
    if (modal) {
      // Werte vorausf√ºllen
      const titelInput = document.getElementById('editTitel');
      const startDatumInput = document.getElementById('editStartDatum');
      const endDatumInput = document.getElementById('editEndDatum');
      const beschreibungInput = document.getElementById('editBeschreibung');
      
      if (titelInput) titelInput.value = terminplanung.titel || '';
      if (startDatumInput) startDatumInput.value = new Date(terminplanung.startDatum).toISOString().split('T')[0];
      if (endDatumInput) endDatumInput.value = new Date(terminplanung.endDatum).toISOString().split('T')[0];
      if (beschreibungInput) beschreibungInput.value = terminplanung.beschreibung || '';
      
      modal.classList.remove('hidden');
    }
  };

  function cancelTerminplanung() {
    if (confirm('M√∂chtest du diese Terminplanung wirklich stornieren?')) {
      // TODO: Stornierung implementieren
      alert('Stornierung wird implementiert...');
    }
  }

  const editForm = document.getElementById('editForm') as HTMLFormElement;
  
  if (editForm) {
    editForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      
      const formData = new FormData(e.target as HTMLFormElement);
      const data = {
        titel: formData.get('titel'),
        startDatum: new Date(formData.get('startDatum') as string).toISOString(),
        endDatum: new Date(formData.get('endDatum') as string).toISOString(),
        beschreibung: formData.get('beschreibung')
      };
      
      try {
        const response = await fetch(`/api/terminplanung/${terminplanung.id}`, {
          method: 'PUT',
          headers: {
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(data)
        });
        
        if (response.ok) {
          alert('Terminplanung erfolgreich aktualisiert! Alle Abstimmungen wurden zur√ºckgesetzt.');
          const modal = document.getElementById('editModal');
          if (modal) modal.classList.add('hidden');
          // Terminplanung neu laden um aktualisierte Daten anzuzeigen
          loadTerminplanung();
        } else {
          const error = await response.json();
          alert('Fehler: ' + error.error);
        }
      } catch (error) {
        console.error('Fehler beim Aktualisieren der Terminplanung:', error);
        alert('Fehler beim Aktualisieren der Terminplanung');
      }
    });
  }

  // Initialisierung
  console.log('Initialisierung gestartet');
  
  // Sofortige Initialisierung
  loadCurrentUser();
</script>
