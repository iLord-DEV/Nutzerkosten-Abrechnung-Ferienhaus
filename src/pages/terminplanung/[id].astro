---
import ProtectedLayout from '../../layouts/ProtectedLayout.astro';
import { getUser } from '../../utils/auth';

const { id } = Astro.params;

// Authentifizierung pr√ºfen
const user = await getUser(Astro);
if (!user) {
  return Astro.redirect('/login');
}
---

<ProtectedLayout title="Terminplanung Details">
  <div class="container mx-auto px-4 py-8 max-w-5xl">
    <div class="mb-6">
      <a href="/terminplanung" class="btn btn-ghost gap-2">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
          <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 19.5L3 12m0 0l7.5-7.5M3 12h18" />
        </svg>
        Zur√ºck zur √úbersicht
      </a>
    </div>

    <div id="terminplanung-details">
      <!-- Terminplanung wird hier dynamisch geladen -->
    </div>
  </div>

  <!-- Abstimmungs-Modal -->
  <dialog id="abstimmungModal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4">Abstimmung</h3>
      <form id="abstimmungForm" method="dialog">
        <div class="form-control mb-4">
          <label class="label">
            <span class="label-text">Deine Stimme:</span>
          </label>
          <div class="space-y-2">
            <label class="label cursor-pointer justify-start gap-3">
              <input type="radio" name="stimme" value="APPROVE" class="radio radio-success">
              <span class="label-text">‚úÖ Zustimmen</span>
            </label>
            <label class="label cursor-pointer justify-start gap-3">
              <input type="radio" name="stimme" value="NEED_INFO" class="radio radio-warning">
              <span class="label-text">‚ùì Brauche mehr Infos / Diskussion</span>
            </label>
          </div>
        </div>

        <div class="form-control mb-6">
          <label class="label">
            <span class="label-text">Kommentar (optional)</span>
          </label>
          <textarea
            id="kommentar"
            name="kommentar"
            class="textarea textarea-bordered"
            placeholder="Deine Gedanken zu diesem Termin..."
          ></textarea>
        </div>

        <div class="modal-action">
          <button type="button" id="abstimmungCancelBtn" class="btn">Abbrechen</button>
          <button type="submit" class="btn btn-primary bg-primary text-primary-content px-6">Stimme abgeben</button>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- Bearbeitungs-Modal -->
  <dialog id="editModal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4">Terminplanung bearbeiten</h3>
      <form id="editForm" method="dialog">
        <input type="hidden" id="editTerminplanungId" name="terminplanungId">

        <div class="form-control mb-4">
          <label class="label">
            <span class="label-text">Titel</span>
          </label>
          <input
            type="text"
            id="editTitel"
            name="titel"
            class="input input-bordered"
            required
          >
        </div>

        <div class="form-control mb-4">
          <label class="label">
            <span class="label-text">Startdatum</span>
          </label>
          <input
            type="date"
            id="editStartDatum"
            name="startDatum"
            class="input input-bordered"
            required
          >
        </div>

        <div class="form-control mb-4">
          <label class="label">
            <span class="label-text">Enddatum</span>
          </label>
          <input
            type="date"
            id="editEndDatum"
            name="endDatum"
            class="input input-bordered"
            required
          >
        </div>

        <div class="form-control mb-6">
          <label class="label">
            <span class="label-text">Beschreibung</span>
          </label>
          <textarea
            id="editBeschreibung"
            name="beschreibung"
            class="textarea textarea-bordered"
          ></textarea>
        </div>

        <div class="modal-action">
          <button type="button" id="editCancelBtn" class="btn">Abbrechen</button>
          <button type="submit" class="btn btn-primary bg-primary text-primary-content px-6">Speichern</button>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- Kommentar-Modal -->
  <dialog id="kommentarModal" class="modal">
    <div class="modal-box">
      <h3 class="font-bold text-lg mb-4">Kommentar hinzuf√ºgen</h3>
      <form id="kommentarForm" method="dialog">
        <input type="hidden" id="kommentarTerminplanungId" name="terminplanungId">
        <input type="hidden" id="kommentarParentId" name="parentId">

        <div class="form-control mb-6">
          <label class="label" for="kommentarInhalt">
            <span class="label-text">Dein Kommentar:</span>
          </label>
          <textarea
            id="kommentarInhalt"
            name="kommentarInhalt"
            required
            class="textarea textarea-bordered"
            placeholder="Was m√∂chtest du zu diesem Termin sagen?"
          ></textarea>
        </div>

        <div class="modal-action">
          <button type="button" id="kommentarCancelBtn" class="btn">Abbrechen</button>
          <button type="submit" class="btn btn-primary bg-primary text-primary-content px-6">Kommentar hinzuf√ºgen</button>
        </div>
      </form>
    </div>
    <form method="dialog" class="modal-backdrop">
      <button>close</button>
    </form>
  </dialog>

  <!-- Toast Notification -->
  <div id="toast" class="toast toast-end hidden">
    <div id="toast-content" class="alert">
      <div class="flex items-center gap-2">
        <span id="toast-icon"></span>
        <div>
          <div id="toast-title" class="font-bold"></div>
          <div id="toast-message" class="text-sm"></div>
        </div>
      </div>
    </div>
  </div>
</ProtectedLayout>

<script>
  const terminplanungId = parseInt(window.location.pathname.split('/').pop());
  let terminplanung = null;
  let currentUser = null;

  // Toast Notification System
  function showToast(type, title, message) {
    const toast = document.getElementById('toast');
    const toastContent = document.getElementById('toast-content');
    const toastIcon = document.getElementById('toast-icon');
    const toastTitle = document.getElementById('toast-title');
    const toastMessage = document.getElementById('toast-message');

    // Toast-Typ konfigurieren
    const configs = {
      success: {
        icon: '‚úÖ',
        alertClass: 'alert-success'
      },
      error: {
        icon: '‚ùå',
        alertClass: 'alert-error'
      },
      info: {
        icon: '‚ÑπÔ∏è',
        alertClass: 'alert-info'
      },
      warning: {
        icon: '‚ö†Ô∏è',
        alertClass: 'alert-warning'
      }
    };

    const config = configs[type] || configs.info;

    // Toast-Content aktualisieren
    toastIcon.textContent = config.icon;
    toastTitle.textContent = title;
    toastMessage.textContent = message;

    // Styling anwenden
    toastContent.className = `alert ${config.alertClass}`;

    // Toast anzeigen
    toast.classList.remove('hidden');

    // Auto-hide nach 3 Sekunden
    setTimeout(() => {
      hideToast();
    }, 3000);
  }

  function hideToast() {
    const toast = document.getElementById('toast');
    toast.classList.add('hidden');
  }

  // User-Info laden
  async function loadCurrentUser() {
    try {
      const response = await fetch('/api/auth/me');
      if (response.ok) {
        currentUser = await response.json();
        console.log('üîç DEBUG: Current user loaded:', currentUser);
      }
    } catch (error) {
      console.error('Fehler beim Laden der User-Info:', error);
    }
  }

  // Terminplanung laden
  async function loadTerminplanung() {
    console.log('üîç DEBUG: loadTerminplanung() gestartet');
    console.log('üîç DEBUG: terminplanungId =', terminplanungId);
    
    try {
      console.log('üîç DEBUG: Fetching API...');
      const response = await fetch(`/api/terminplanung/${terminplanungId}`);
      console.log('üîç DEBUG: Response status =', response.status);
      
      if (response.ok) {
        console.log('üîç DEBUG: Response OK, parsing JSON...');
        terminplanung = await response.json();
        console.log('üîç DEBUG: Terminplanung geladen:', terminplanung);
        console.log('üîç DEBUG: Calling renderTerminplanung()...');
        renderTerminplanung();
        console.log('üîç DEBUG: renderTerminplanung() completed');
      } else {
        console.log('üîç DEBUG: Response not OK, parsing error...');
        const error = await response.json();
        console.log('üîç DEBUG: Error:', error);
        const detailsEl = document.getElementById('terminplanung-details');
        if (detailsEl) {
          detailsEl.innerHTML = `
            <div class="text-center py-8">
              <p class="text-red-600">Fehler: ${error.error}</p>
            </div>
          `;
        }
      }
    } catch (error) {
      console.error('üîç DEBUG: Catch block - Fehler beim Laden der Terminplanung:', error);
      const detailsEl = document.getElementById('terminplanung-details');
      if (detailsEl) {
        detailsEl.innerHTML = `
          <div class="text-center py-8">
            <p class="text-red-600">Fehler beim Laden der Terminplanung</p>
          </div>
        `;
      }
    }
  }

  // Terminplanung rendern
  function renderTerminplanung() {
    if (!terminplanung) return;

    const statusBadge =
      terminplanung.status === 'APPROVED' ? 'badge-success' :
      terminplanung.status === 'DISCUSSING' ? 'badge-warning' :
      terminplanung.status === 'PENDING' ? 'badge-info' :
      'badge';

    const statusText =
      terminplanung.status === 'APPROVED' ? 'Freigegeben' :
      terminplanung.status === 'DISCUSSING' ? 'In Diskussion' :
      terminplanung.status === 'PENDING' ? 'Warten auf Abstimmungen' :
      'Storniert';

    const canEdit = (terminplanung.userId === currentUser?.id || currentUser?.role === 'ADMIN') && terminplanung.status !== 'APPROVED';
    // Kind-User k√∂nnen nicht abstimmen
    const canVote = terminplanung.userId !== currentUser?.id && terminplanung.status !== 'CANCELLED' && !currentUser?.isKind;

    const detailsEl = document.getElementById('terminplanung-details');
    if (!detailsEl) return;

    detailsEl.innerHTML = `
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <!-- Header -->
          <div class="flex justify-between items-start mb-6">
            <div>
              <h1 class="card-title text-3xl mb-2">${terminplanung.titel}</h1>
              <div class="flex items-center gap-4 text-sm opacity-70">
                <span>von ${terminplanung.user.name}</span>
                <span>‚Ä¢</span>
                <span>Version ${terminplanung.version}</span>
              </div>
            </div>
            <span class="badge ${statusBadge} badge-lg">${statusText}</span>
          </div>

          <!-- Termin-Details -->
          <div class="alert mb-6">
            <div>
              <h3 class="font-semibold mb-2">Termin</h3>
              <div class="text-base">
                ${new Date(terminplanung.startDatum).toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })} -
                ${new Date(terminplanung.endDatum).toLocaleDateString('de-DE', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' })}
              </div>
              ${terminplanung.beschreibung ? `
                <div class="mt-2">
                  <strong>Beschreibung:</strong><br>
                  ${terminplanung.beschreibung}
                </div>
              ` : ''}
            </div>
          </div>

          <!-- Aktionen -->
          <div class="card-actions mb-6">
            ${canEdit ? `
              <button onclick="editTerminplanung()" class="btn btn-sm btn-outline">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M16.862 4.487l1.687-1.688a1.875 1.875 0 112.652 2.652L10.582 16.07a4.5 4.5 0 01-1.897 1.13L6 18l.8-2.685a4.5 4.5 0 011.13-1.897l8.932-8.931zm0 0L19.5 7.125M18 14v4.75A2.25 2.25 0 0115.75 21H5.25A2.25 2.25 0 013 18.75V8.25A2.25 2.25 0 015.25 6H10" />
                </svg>
                Bearbeiten
              </button>
              <button onclick="cancelTerminplanung()" class="btn btn-sm btn-error btn-outline">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                </svg>
                Stornieren
              </button>
            ` : ''}
            ${canVote ? `
              ${terminplanung.abstimmungen.some(a => a.userId === currentUser?.id && a.stimme === 'APPROVE' && a.version === terminplanung.version) ? `
                <button onclick="window.zustimmungEntziehen(${terminplanung.id})" class="btn btn-sm btn-error">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M6 18L18 6M6 6l12 12" />
                  </svg>
                  Zustimmung entziehen
                </button>
              ` : `
                <button onclick="window.zustimmen(${terminplanung.id})" class="btn btn-sm btn-success">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M4.5 12.75l6 6 9-13.5" />
                  </svg>
                  Zustimmen
                </button>
              `}
            ` : ''}
            <button onclick="window.openKommentarModal()" class="btn btn-sm btn-warning btn-outline">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4">
                <path stroke-linecap="round" stroke-linejoin="round" d="M7.5 8.25h9m-9 3H12m-9.75 1.51c0 1.6 1.123 2.994 2.707 3.227 1.129.166 2.27.293 3.423.379.35.026.67.21.865.501L12 21l2.755-4.133a1.14 1.14 0 01.865-.501 48.172 48.172 0 003.423-.379c1.584-.233 2.707-1.626 2.707-3.228V6.741c0-1.602-1.123-2.995-2.707-3.228A48.394 48.394 0 0012 3c-2.392 0-4.744.175-7.043.513C3.373 3.746 2.25 5.14 2.25 6.741v6.018z" />
              </svg>
              Kommentieren
            </button>
          </div>

          <!-- Abstimmungen -->
          <div class="divider">Abstimmungen (Version ${terminplanung.version})</div>
          <div class="space-y-2">
            ${terminplanung.abstimmungen
              .filter(a => a.version === terminplanung.version)
              .map(abstimmung => `
                <div class="flex items-center justify-between p-3 bg-base-200 rounded">
                  <div class="flex items-center gap-3">
                    <span class="font-medium">${abstimmung.userId === currentUser?.id ? 'Du' : abstimmung.user.name}</span>
                    <span class="badge ${abstimmung.stimme === 'APPROVE' ? 'badge-success' : 'badge-warning'}">
                      ${abstimmung.stimme === 'APPROVE' ? `‚úÖ ${abstimmung.userId === currentUser?.id ? 'hast' : 'hat'} zugestimmt` : '‚ùì Mehr Infos'}
                    </span>
                  </div>
                  <span class="text-sm opacity-60">
                    ${new Date(abstimmung.createdAt).toLocaleDateString('de-DE')}
                  </span>
                </div>
                ${abstimmung.kommentar ? `
                  <div class="ml-6 p-2 bg-base-100 rounded text-sm italic">
                    "${abstimmung.kommentar}"
                  </div>
                ` : ''}
              `).join('')}
            ${terminplanung.abstimmungen.filter(a => a.version === terminplanung.version).length === 0 ?
              '<p class="text-sm opacity-60">Noch keine Abstimmungen</p>' : ''}
          </div>

          <!-- Status-Info -->
          ${terminplanung.status === 'PENDING' ? `
            <div class="alert alert-info mt-4">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
              <span>Warten auf Abstimmungen der anderen Mitglieder</span>
            </div>
          ` : terminplanung.status === 'DISCUSSING' ? `
            <div class="alert alert-warning mt-4">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 9v2m0 4h.01m-6.938 4h13.856c1.54 0 2.502-1.667 1.732-3L13.732 4c-.77-1.333-2.694-1.333-3.464 0L3.34 16c-.77 1.333.192 3 1.732 3z"></path></svg>
              <span>In Diskussion - es gibt Kommentare oder "Mehr Infos" Stimmen</span>
            </div>
          ` : terminplanung.status === 'APPROVED' ? `
            <div class="alert alert-success mt-4">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="stroke-current shrink-0 w-6 h-6"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m6 2a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
              <span>Termin ist freigegeben - alle haben zugestimmt!</span>
            </div>
          ` : ''}
        </div>
      </div>

      <!-- Kommentare -->
      <div class="card bg-base-100 shadow-xl mt-4">
        <div class="card-body">
          <h3 class="card-title">Kommentare</h3>
          <div class="space-y-3">
            ${terminplanung.kommentare
              .filter(kommentar => !kommentar.parentId)
              .map(kommentar => `
                <div class="p-3 bg-base-200 rounded">
                  <div class="flex items-center justify-between mb-1">
                    <span class="font-medium text-sm">${kommentar.user.name}</span>
                    <span class="text-xs opacity-60">
                      ${new Date(kommentar.createdAt).toLocaleDateString('de-DE')}
                      ${new Date(kommentar.createdAt).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}
                    </span>
                  </div>
                  <p>${kommentar.inhalt}</p>

                  <!-- Antworten anzeigen -->
                  ${kommentar.replies && kommentar.replies.length > 0 ? `
                    <div class="mt-2 ml-6 space-y-2 border-l-2 border-base-300 pl-3">
                      ${kommentar.replies.map(reply => `
                        <div class="bg-base-300 p-2 rounded">
                          <div class="flex items-center justify-between mb-1">
                            <span class="font-medium text-xs">${reply.user.name}</span>
                            <span class="text-xs opacity-60">
                              ${new Date(reply.createdAt).toLocaleDateString('de-DE')}
                              ${new Date(reply.createdAt).toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}
                            </span>
                          </div>
                          <p class="text-xs">${reply.inhalt}</p>
                        </div>
                      `).join('')}
                    </div>
                  ` : ''}

                  <button onclick="window.antworten(${terminplanung.id}, ${kommentar.id})" class="btn btn-ghost btn-xs mt-2">
                    Antworten
                  </button>
                </div>
              `).join('')}
            ${terminplanung.kommentare.filter(k => !k.parentId).length === 0 ?
              '<p class="text-sm opacity-60">Noch keine Kommentare</p>' : ''}
          </div>
        </div>
      </div>

      <!-- √Ñnderungshistorie -->
      ${terminplanung.aenderungen.length > 0 ? `
        <div class="card bg-base-100 shadow-xl mt-4" id="aenderungen">
          <div class="card-body">
            <h3 class="card-title">√Ñnderungshistorie</h3>
            <div class="space-y-2">
              ${terminplanung.aenderungen.map(aenderung => `
                <div class="alert alert-info">
                  <div class="w-full">
                    <div class="font-medium">${aenderung.user.name} hat die Termine ge√§ndert</div>
                    <div class="text-sm mt-1">
                      <strong>Von:</strong> ${new Date(aenderung.alteStartDatum).toLocaleDateString('de-DE')} -
                      ${new Date(aenderung.alteEndDatum).toLocaleDateString('de-DE')}<br>
                      <strong>Zu:</strong> ${new Date(aenderung.neueStartDatum).toLocaleDateString('de-DE')} -
                      ${new Date(aenderung.neueEndDatum).toLocaleDateString('de-DE')}
                    </div>
                    ${aenderung.grund ? `
                      <div class="mt-1">"${aenderung.grund}"</div>
                    ` : ''}
                    <div class="text-xs opacity-60 mt-1">
                      ${new Date(aenderung.createdAt).toLocaleDateString('de-DE')}
                    </div>
                  </div>
                </div>
              `).join('')}
            </div>
          </div>
        </div>
      ` : ''}
    `;
  }

  // Globale Funktionen
  window.openKommentarModal = function() {
    const terminplanungIdEl = document.getElementById('kommentarTerminplanungId');
    const parentIdEl = document.getElementById('kommentarParentId');
    const modal = document.getElementById('kommentarModal');
    if (terminplanungIdEl && parentIdEl && modal) {
      terminplanungIdEl.value = terminplanung.id.toString();
      parentIdEl.value = '';
      modal.showModal();
    }
  };

  window.closeKommentarModal = function() {
    const modal = document.getElementById('kommentarModal');
    const form = document.getElementById('kommentarForm');
    if (modal) modal.close();
    if (form) form.reset();
  };

  window.antworten = function(terminplanungId, parentId) {
    const terminplanungIdEl = document.getElementById('kommentarTerminplanungId');
    const parentIdEl = document.getElementById('kommentarParentId');
    const modal = document.getElementById('kommentarModal');
    if (terminplanungIdEl && parentIdEl && modal) {
      terminplanungIdEl.value = terminplanungId.toString();
      parentIdEl.value = parentId.toString();
      modal.showModal();
    }
  };

  window.zustimmen = async function(terminplanungId) {
    try {
      const response = await fetch(`/api/terminplanung/${terminplanungId}/abstimmung`, {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ stimme: 'APPROVE', kommentar: '' })
      });
      if (response.ok) {
        showToast('success', 'Zustimmung abgegeben', 'Deine Zustimmung wurde erfolgreich gespeichert!');
        loadTerminplanung();
      } else {
        const error = await response.json();
        showToast('error', 'Fehler', error.error);
      }
    } catch (error) {
      console.error('Fehler beim Zustimmen:', error);
      showToast('error', 'Fehler', 'Beim Zustimmen ist ein Fehler aufgetreten');
    }
  };

  window.zustimmungEntziehen = async function(terminplanungId) {
    try {
      const response = await fetch(`/api/terminplanung/${terminplanungId}/abstimmung`, {
        method: 'DELETE',
        headers: { 'Content-Type': 'application/json' }
      });
      if (response.ok) {
        showToast('info', 'Zustimmung entzogen', 'Deine Zustimmung wurde erfolgreich zur√ºckgezogen!');
        loadTerminplanung();
      } else {
        const error = await response.json();
        showToast('error', 'Fehler', error.error);
      }
    } catch (error) {
      console.error('Fehler beim Entziehen der Zustimmung:', error);
      showToast('error', 'Fehler', 'Beim Entziehen der Zustimmung ist ein Fehler aufgetreten');
    }
  };

  window.editTerminplanung = function() {
    const modal = document.getElementById('editModal');
    if (modal) {
      const titelInput = document.getElementById('editTitel');
      const startDatumInput = document.getElementById('editStartDatum');
      const endDatumInput = document.getElementById('editEndDatum');
      const beschreibungInput = document.getElementById('editBeschreibung');

      if (titelInput) titelInput.value = terminplanung.titel || '';
      if (startDatumInput) startDatumInput.value = new Date(terminplanung.startDatum).toISOString().split('T')[0];
      if (endDatumInput) endDatumInput.value = new Date(terminplanung.endDatum).toISOString().split('T')[0];
      if (beschreibungInput) beschreibungInput.value = terminplanung.beschreibung || '';

      modal.showModal();
    }
  };

  window.cancelTerminplanung = async function() {
    if (confirm('M√∂chtest du diese Terminplanung wirklich stornieren? Diese Aktion kann nicht r√ºckg√§ngig gemacht werden und l√∂scht alle Kommentare und Abstimmungen.')) {
      try {
        const response = await fetch(`/api/terminplanung/${terminplanung.id}`, {
          method: 'DELETE',
          headers: { 'Content-Type': 'application/json' }
        });
        
        if (response.ok) {
          showToast('success', 'Storniert', 'Die Terminplanung wurde erfolgreich storniert und gel√∂scht!');
          // Weiterleitung zur Terminplanung-√úbersicht
          setTimeout(() => {
            window.location.href = '/terminplanung';
          }, 1500);
        } else {
          const error = await response.json();
          showToast('error', 'Fehler', error.error);
        }
      } catch (error) {
        console.error('Fehler beim Stornieren der Terminplanung:', error);
        showToast('error', 'Fehler', 'Beim Stornieren der Terminplanung ist ein Fehler aufgetreten');
      }
    }
  };

  // Event Listeners
  const abstimmungCancelBtn = document.getElementById('abstimmungCancelBtn');
  const kommentarCancelBtn = document.getElementById('kommentarCancelBtn');
  const editCancelBtn = document.getElementById('editCancelBtn');

  if (abstimmungCancelBtn) {
    abstimmungCancelBtn.addEventListener('click', () => {
      document.getElementById('abstimmungModal').close();
    });
  }

  if (kommentarCancelBtn) {
    kommentarCancelBtn.addEventListener('click', window.closeKommentarModal);
  }

  if (editCancelBtn) {
    editCancelBtn.addEventListener('click', () => {
      const modal = document.getElementById('editModal');
      if (modal) modal.close();
    });
  }

  const abstimmungForm = document.getElementById('abstimmungForm');
  const kommentarForm = document.getElementById('kommentarForm');
  const editForm = document.getElementById('editForm');

  if (abstimmungForm) {
    abstimmungForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = {
        stimme: formData.get('stimme'),
        kommentar: formData.get('kommentar')
      };
      try {
        const response = await fetch(`/api/terminplanung/${terminplanungId}/abstimmung`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (response.ok) {
          document.getElementById('abstimmungModal').close();
          showToast('success', 'Abstimmung abgegeben', 'Deine Stimme wurde erfolgreich gespeichert!');
          loadTerminplanung();
        } else {
          const error = await response.json();
          showToast('error', 'Fehler', error.error);
        }
      } catch (error) {
        console.error('Fehler beim Abgeben der Abstimmung:', error);
        showToast('error', 'Fehler', 'Beim Abgeben der Abstimmung ist ein Fehler aufgetreten');
      }
    });
  }

  if (kommentarForm) {
    kommentarForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = {
        inhalt: formData.get('kommentarInhalt'),
        parentId: formData.get('parentId') ? parseInt(formData.get('parentId')) : null
      };
      try {
        const response = await fetch(`/api/terminplanung/${terminplanungId}/kommentar`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (response.ok) {
          window.closeKommentarModal();
          showToast('success', 'Kommentar hinzugef√ºgt', 'Dein Kommentar wurde erfolgreich gespeichert!');
          loadTerminplanung();
        } else {
          const error = await response.json();
          showToast('error', 'Fehler', error.error);
        }
      } catch (error) {
        console.error('Fehler beim Erstellen des Kommentars:', error);
        showToast('error', 'Fehler', 'Beim Erstellen des Kommentars ist ein Fehler aufgetreten');
      }
    });
  }

  if (editForm) {
    editForm.addEventListener('submit', async (e) => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const data = {
        titel: formData.get('titel'),
        startDatum: new Date(formData.get('startDatum')).toISOString(),
        endDatum: new Date(formData.get('endDatum')).toISOString(),
        beschreibung: formData.get('beschreibung')
      };
      try {
        const response = await fetch(`/api/terminplanung/${terminplanung.id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify(data)
        });
        if (response.ok) {
          showToast('success', 'Terminplanung aktualisiert', 'Die Terminplanung wurde erfolgreich gespeichert! Alle Abstimmungen wurden zur√ºckgesetzt.');
          const modal = document.getElementById('editModal');
          if (modal) modal.close();
          loadTerminplanung();
        } else {
          const error = await response.json();
          showToast('error', 'Fehler', error.error);
        }
      } catch (error) {
        console.error('Fehler beim Aktualisieren der Terminplanung:', error);
        showToast('error', 'Fehler', 'Beim Aktualisieren der Terminplanung ist ein Fehler aufgetreten');
      }
    });
  }

  // Auto-resize f√ºr Textareas (Fallback f√ºr Browser ohne field-sizing)
  function autoResizeTextarea(textarea) {
    // Nur wenn field-sizing nicht unterst√ºtzt wird
    if (!CSS.supports('field-sizing', 'content')) {
      textarea.style.height = 'auto';
      textarea.style.height = textarea.scrollHeight + 'px';
    }
  }

  // Alle Textareas mit Auto-Resize
  document.addEventListener('DOMContentLoaded', () => {
    const textareas = document.querySelectorAll('textarea');
    textareas.forEach(textarea => {
      textarea.addEventListener('input', () => autoResizeTextarea(textarea));
      // Initial resize
      autoResizeTextarea(textarea);
    });
  });

  // Initialisierung
  console.log('üîç DEBUG: Initialisierung gestartet');
  loadCurrentUser().then(() => {
    loadTerminplanung();
  });
</script>