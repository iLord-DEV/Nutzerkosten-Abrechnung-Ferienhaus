---
import ProtectedLayout from '../layouts/ProtectedLayout.astro';
import { getUser } from '../utils/auth';

// Authentifizierung prüfen
const user = await getUser(Astro);
if (!user) {
  return Astro.redirect('/login');
}
---

<ProtectedLayout title="Dashboard - Nutzerkosten">
  <div class="px-4 sm:px-6 lg:px-8">
    <div class="mb-8">
      <div class="flex items-center justify-between">
        <div>
          <h1 class="text-3xl font-bold">
            Mein Dashboard
          </h1>
          <p class="mt-2 text-base-content/70">
            Willkommen, <span id="user-name">Benutzer</span>! Hier findest du deine persönlichen Aufenthalte und Kosten.
          </p>
        </div>

      </div>
    </div>

    <!-- Temperatur-Anzeige -->
    <div class="card bg-base-100 shadow-xl mb-8">
      <div class="card-body">
        <h2 class="card-title">
          <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
            <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 7.5l3 2.25-3 2.25m4.5 0h3m-9 8.25h13.5A2.25 2.25 0 0021 18V6a2.25 2.25 0 00-2.25-2.25H5.25A2.25 2.25 0 003 6v12a2.25 2.25 0 002.25 2.25z" />
          </svg>
          Aktuelle Temperaturen
        </h2>
        <div class="stats stats-horizontal shadow mt-4">
          <div class="stat">
            <div class="stat-figure text-primary">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
            </div>
            <div class="stat-title">Bad</div>
            <div class="stat-value text-primary" id="temp-bad">--°C</div>
            <div class="stat-desc" id="temp-bad-update">Lädt...</div>
          </div>

          <div class="stat">
            <div class="stat-figure text-secondary">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
              </svg>
            </div>
            <div class="stat-title">Wohnzimmer</div>
            <div class="stat-value text-secondary" id="temp-wohnzimmer">--°C</div>
            <div class="stat-desc" id="temp-wohnzimmer-update">Lädt...</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Persönliche Übersichtskarten -->
    <div class="stats stats-vertical lg:stats-horizontal shadow w-full mb-8">
      <div class="stat">
        <div class="stat-title">Meine Aufenthalte</div>
        <div class="stat-value text-primary" id="my-aufenthalte">-</div>
      </div>

      <div class="stat">
        <div class="stat-title">Aufenthalte insgesamt</div>
        <div class="stat-value text-primary" id="total-aufenthalte">-</div>
      </div>

      <div class="stat">
        <div class="stat-title">Letzter Zählerstand</div>
        <div class="stat-value text-primary" id="last-zaehlerstand">-</div>
      </div>

      <div class="stat">
        <div class="stat-title">Meine Kosten <span id="kosten-jahr">2024</span></div>
        <div class="stat-value text-primary" id="my-kosten">-</div>
      </div>
    </div>

    <!-- Schnellaktionen für Benutzer -->
    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-8">
      <!-- Meine Aktionen -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title">Meine Aktionen</h2>
          <div class="space-y-2">
            <a href="/aufenthalte/neu" class="btn btn-primary w-full">
              Neuen Aufenthalt erfassen
            </a>
            <a href="/statistiken" class="btn btn-ghost w-full">
              Meine Statistiken anzeigen
            </a>
            <a href="/statistiken?gesamt=true" class="btn btn-ghost w-full">
              Gesamtübersicht aller Nutzer
            </a>
            <a href="/aufenthalte" class="btn btn-ghost w-full">
              Alle meine Aufenthalte
            </a>
            <a href="/profil/passwort-aendern" class="btn btn-ghost w-full">
              Passwort ändern
            </a>
          </div>
        </div>
      </div>

      <!-- Letzte Aktivitäten -->
      <div class="card bg-base-100 shadow-xl">
        <div class="card-body">
          <h2 class="card-title">Meine letzten Aktivitäten</h2>
          <div class="flow-root">
            <ul role="list" class="-mb-8" id="my-aktivitaeten-liste">
              <!-- Wird dynamisch geladen -->
            </ul>
          </div>
        </div>
      </div>
    </div>

    <!-- Meine Aufenthalte -->
    <div class="card bg-base-100 shadow-xl">
      <div class="card-body">
        <h2 class="card-title">Meine Aufenthalte</h2>
        <div class="overflow-x-auto">
          <table class="table table-zebra">
            <thead>
              <tr>
                <th>Ankunft</th>
                <th>Abreise</th>
                <th>Zählerstand</th>
                <th>Übernachtungen Mitgl.</th>
                <th>Übernachtungen Gäste</th>
                <th>Kosten</th>
              </tr>
            </thead>
            <tbody id="aufenthalte-tabelle">
              <!-- Wird dynamisch geladen -->
            </tbody>
          </table>
        </div>
      </div>
    </div>
  </div>
</ProtectedLayout>

<script>
  // Benutzer-Dashboard Funktionalität
  let currentUser: any = null;

  // Benutzer-Informationen laden
  async function loadUserInfo() {
    try {
      const response = await fetch('/api/auth/me');
      if (response.ok) {
        currentUser = await response.json();
        const userNameEl = document.getElementById('user-name');
        if (userNameEl) {
          userNameEl.textContent = currentUser.name;
        }
        
        // Dashboard-Daten laden
        loadDashboardData();
        loadMyAufenthalte();
        loadMyAktivitaeten();
      } else {
        // Nicht eingeloggt, zurück zum Login
        window.location.href = '/login';
      }
    } catch (error) {
      console.error('Fehler beim Laden der Benutzer-Informationen:', error);
      window.location.href = '/login';
    }
  }

  // Dashboard-Daten laden
  async function loadDashboardData() {
    try {
      const currentYear = new Date().getFullYear();
      const kostenJahrEl = document.getElementById('kosten-jahr');
      if (kostenJahrEl) kostenJahrEl.textContent = currentYear.toString();

      // Persönliche Statistiken laden
      const statsResponse = await fetch(`/api/statistiken?jahr=${currentYear}`);
      if (statsResponse.ok) {
        const stats = await statsResponse.json();

        const myAufenthalteEl = document.getElementById('my-aufenthalte');
        const myTankfuellungenEl = document.getElementById('my-tankfuellungen');
        const myKostenEl = document.getElementById('my-kosten');

        if (myAufenthalteEl) myAufenthalteEl.textContent = stats.anzahlAufenthalte || '0';
        if (myTankfuellungenEl) myTankfuellungenEl.textContent = '0'; // Normale Benutzer haben keine Tankfüllungen
        if (myKostenEl) myKostenEl.textContent = `€ ${(stats.gesamtKosten || 0).toFixed(2)}`;
      }

      // Gesamtanzahl Aufenthalte laden und letzten Zählerstand ermitteln
      const aufenthalteResponse = await fetch(`/api/aufenthalte?jahr=${currentYear}`);
      if (aufenthalteResponse.ok) {
        const aufenthalte = await aufenthalteResponse.json();
        const totalAufenthalteEl = document.getElementById('total-aufenthalte');
        if (totalAufenthalteEl) totalAufenthalteEl.textContent = aufenthalte.length.toString();

        // Letzten Zählerstand aus dem neuesten Aufenthalt holen
        if (aufenthalte.length > 0) {
          // Aufenthalte nach Abreisedatum sortieren (neueste zuerst)
          const sortedAufenthalte = aufenthalte.sort((a: any, b: any) =>
            new Date(b.abreise).getTime() - new Date(a.abreise).getTime()
          );
          const neuesterAufenthalt = sortedAufenthalte[0];
          const lastZaehlerstandEl = document.getElementById('last-zaehlerstand');
          if (lastZaehlerstandEl && neuesterAufenthalt.zaehlerAbreise) {
            lastZaehlerstandEl.textContent = `${neuesterAufenthalt.zaehlerAbreise} h`;
          }
        }
      }
    } catch (error) {
      console.error('Fehler beim Laden der Dashboard-Daten:', error);
    }
  }

  // Meine Aufenthalte laden
  async function loadMyAufenthalte() {
    try {
      const response = await fetch('/api/aufenthalte');
      if (response.ok) {
        const aufenthalte = await response.json();
        const myAufenthalte = aufenthalte.filter((a: any) => a.userId === currentUser.id);
        
        renderAufenthalteTabelle(myAufenthalte);
      }
    } catch (error) {
      console.error('Fehler beim Laden der Aufenthalte:', error);
    }
  }

  // Aufenthalte-Tabelle rendern
  function renderAufenthalteTabelle(aufenthalte: any[]) {
    const tbody = document.getElementById('aufenthalte-tabelle');
    if (!tbody) return;

    tbody.innerHTML = '';

    if (aufenthalte.length === 0) {
      tbody.innerHTML = `
        <tr>
          <td colspan="6" class="text-center opacity-50">
            Noch keine Aufenthalte erfasst
          </td>
        </tr>
      `;
      return;
    }

    aufenthalte.forEach((aufenthalt: any) => {
      const row = document.createElement('tr');
      row.innerHTML = `
        <td>${new Date(aufenthalt.ankunft).toLocaleDateString('de-DE')}</td>
        <td>${new Date(aufenthalt.abreise).toLocaleDateString('de-DE')}</td>
        <td>${aufenthalt.zaehlerAnkunft}h - ${aufenthalt.zaehlerAbreise}h</td>
        <td>${aufenthalt.uebernachtungenMitglieder}</td>
        <td>${aufenthalt.uebernachtungenGaeste}</td>
        <td><span class="font-semibold">€ ${calculateKosten(aufenthalt).toFixed(2)}</span></td>
      `;
      tbody.appendChild(row);
    });
  }

  // Kosten für einen Aufenthalt berechnen (vereinfacht)
  function calculateKosten(aufenthalt: any) {
            const stunden = (aufenthalt.zaehlerAbreise - aufenthalt.zaehlerAnkunft);
            const oelkosten = stunden * 5.5 * 1.01; // 5.5 L/h, 1.01€/L
    const uebernachtungskosten = (aufenthalt.uebernachtungenMitglieder * 15 + aufenthalt.uebernachtungenGaeste * 25);
    
    return oelkosten + uebernachtungskosten;
  }

  // Meine Aktivitäten laden
  async function loadMyAktivitaeten() {
    try {
      const aufenthalteResponse = await fetch('/api/aufenthalte');
      const tankfuellungenResponse = await fetch('/api/tankfuellungen');
      
      if (aufenthalteResponse.ok && tankfuellungenResponse.ok) {
        const aufenthalte = await aufenthalteResponse.json();
        const tankfuellungen = await tankfuellungenResponse.json();
        
        const myAufenthalte = aufenthalte.filter((a: any) => a.userId === currentUser.id);
        // Normale Benutzer haben keine Tankfüllungen
        const myTankfuellungen: any[] = [];
        
        renderAktivitaeten(myAufenthalte, myTankfuellungen);
      }
    } catch (error) {
      console.error('Fehler beim Laden der Aktivitäten:', error);
    }
  }

  // Aktivitäten rendern
  function renderAktivitaeten(aufenthalte: any[], tankfuellungen: any[]) {
    const ul = document.getElementById('my-aktivitaeten-liste');
    if (!ul) return;

    ul.innerHTML = '';

    const alleAktivitaeten = [
      ...aufenthalte.map((a: any) => ({
        type: 'aufenthalt',
        datum: new Date(a.ankunft),
        dateRange: `${new Date(a.ankunft).toLocaleDateString('de-DE')} - ${new Date(a.abreise).toLocaleDateString('de-DE')}`,
        text: `Aufenthalt`
      })),
      ...tankfuellungen.map((t: any) => ({
        type: 'tankfuellung',
        datum: new Date(t.datum),
        dateRange: new Date(t.datum).toLocaleDateString('de-DE'),
        text: `Tankfüllung: ${t.liter}L`
      }))
    ];

    // Nach Datum sortieren (neueste zuerst)
    alleAktivitaeten.sort((a: any, b: any) => b.datum.getTime() - a.datum.getTime());

    // Nur die letzten 5 anzeigen
    alleAktivitaeten.slice(0, 5).forEach((aktivitaet: any, index: number) => {
      const li = document.createElement('li');
      li.className = 'relative pb-8';

      const badgeColor = 'badge-primary';
      const isLast = index === Math.min(alleAktivitaeten.length, 5) - 1;

      li.innerHTML = `
        <div class="relative flex space-x-3">
          <div>
            <span class="badge ${badgeColor} badge-lg"></span>
          </div>
          <div class="min-w-0 flex-1 flex justify-between space-x-4">
            <div>
              <p class="text-sm font-medium">${aktivitaet.text}</p>
            </div>
            <div class="text-right text-sm whitespace-nowrap opacity-70">
              <time>${aktivitaet.dateRange}</time>
            </div>
          </div>
        </div>
        ${!isLast ? '<div class="absolute left-2 top-8 -ml-px h-full w-0.5 bg-base-300" aria-hidden="true"></div>' : ''}
      `;

      ul.appendChild(li);
    });

    if (alleAktivitaeten.length === 0) {
      ul.innerHTML = `
        <li class="text-center opacity-50 py-4">
          Noch keine Aktivitäten
        </li>
      `;
    }
  }



  // Temperaturen laden
  async function loadTemperaturen() {
    try {
      const response = await fetch('/api/temperaturen');
      if (response.ok) {
        const data = await response.json();

        const tempBadEl = document.getElementById('temp-bad');
        const tempWohnzimmerEl = document.getElementById('temp-wohnzimmer');
        const tempBadUpdateEl = document.getElementById('temp-bad-update');
        const tempWohnzimmerUpdateEl = document.getElementById('temp-wohnzimmer-update');

        if (tempBadEl) {
          tempBadEl.textContent = data.bad !== null ? `${data.bad.toFixed(1)}°C` : 'N/A';
        }
        if (tempWohnzimmerEl) {
          tempWohnzimmerEl.textContent = data.wohnzimmer !== null ? `${data.wohnzimmer.toFixed(1)}°C` : 'N/A';
        }

        // Update-Zeitpunkt anzeigen
        if (tempBadUpdateEl && data.lastUpdate?.bad) {
          const updateTime = new Date(data.lastUpdate.bad);
          tempBadUpdateEl.textContent = `Aktualisiert: ${updateTime.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}`;
        }
        if (tempWohnzimmerUpdateEl && data.lastUpdate?.wohnzimmer) {
          const updateTime = new Date(data.lastUpdate.wohnzimmer);
          tempWohnzimmerUpdateEl.textContent = `Aktualisiert: ${updateTime.toLocaleTimeString('de-DE', { hour: '2-digit', minute: '2-digit' })}`;
        }
      }
    } catch (error) {
      console.error('Fehler beim Laden der Temperaturen:', error);
      const tempBadEl = document.getElementById('temp-bad');
      const tempWohnzimmerEl = document.getElementById('temp-wohnzimmer');
      if (tempBadEl) tempBadEl.textContent = 'Fehler';
      if (tempWohnzimmerEl) tempWohnzimmerEl.textContent = 'Fehler';
    }
  }

  // Event-Listener
  document.addEventListener('DOMContentLoaded', () => {
    loadUserInfo();
    loadTemperaturen();

    // Temperaturen alle 5 Minuten aktualisieren
    setInterval(loadTemperaturen, 5 * 60 * 1000);
  });
</script>
</ProtectedLayout>
