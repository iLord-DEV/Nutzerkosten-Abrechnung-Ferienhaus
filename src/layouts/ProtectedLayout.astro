---
import { getSessionData } from '../utils/auth';
import '../styles/global.css';

export interface Props {
  title: string;
  description?: string;
}

const { title, description = "Nutzerkosten-Abrechnung für Wohngemeinschaften" } = Astro.props;

// Authentifizierung prüfen (mit Session für CSRF-Token)
const session = await getSessionData(Astro);
if (!session) {
  return Astro.redirect('/login');
}

const user = session.user;
const isAdmin = user.role === 'ADMIN';
const csrfToken = session.csrfToken;
---

<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <meta name="csrf-token" content={csrfToken} />
    <title>{title}</title>

    <!-- PWA Meta Tags -->
    <meta name="theme-color" content="#2563eb" />
    <link rel="apple-touch-icon" href="/pwa-192x192.png" />
    <meta name="mobile-web-app-capable" content="yes" />
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent" />
    <meta name="apple-mobile-web-app-title" content="Wüstenstein" />

    <!-- Load theme and font size immediately to prevent flash -->
    <script is:inline>
      (function() {
        try {
          const stored = localStorage.getItem('theme');
          const mediaQuery = window.matchMedia('(prefers-color-scheme: dark)');
          const theme = stored || (mediaQuery.matches ? 'dark' : 'light');
          document.documentElement.setAttribute('data-theme', theme);
          const fontSize = localStorage.getItem('fontSize') || '100';
          document.documentElement.style.fontSize = fontSize + '%';

          // Auf System-Änderungen reagieren (nur wenn kein manuelles Theme gesetzt)
          mediaQuery.addEventListener('change', (e) => {
            if (!localStorage.getItem('theme')) {
              document.documentElement.setAttribute('data-theme', e.matches ? 'dark' : 'light');
            }
          });
        } catch (e) {
          document.documentElement.setAttribute('data-theme', 'light');
        }
      })();
    </script>
  </head>
  <body class="min-h-screen bg-base-200 drawer lg:drawer-open">
    <!-- Mobile Drawer -->
    <input id="main-drawer" type="checkbox" class="drawer-toggle" />

    <!-- Main Content Area -->
    <div class="drawer-content flex flex-col">

      <!-- Main Content -->
      <main class="flex-1 p-4 lg:p-6">
        <div class="max-w-7xl mx-auto">
          <slot />
        </div>
      </main>

      <!-- Footer -->
      <footer class="footer footer-center p-4 bg-base-100 text-base-content border-t">
        <aside>
          <p class="text-sm opacity-70">© {new Date().getFullYear()} Nutzerkosten-Abrechnung. Alle Rechte vorbehalten.</p>
        </aside>
      </footer>
    </div>

    <!-- Sidebar (Desktop) + Drawer (Mobile) -->
    <div class="drawer-side z-40">
      <label for="main-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
      <aside class="bg-base-100 w-64 min-h-full flex flex-col">
        <!-- Logo Section -->
        <div class="p-4 border-b">
          <a href="/dashboard" class="flex items-center gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-8 h-8 text-primary">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 21v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21m0 0h4.5V3.545M12.75 21h7.5V10.75M2.25 21h1.5m18 0h-18M2.25 9l4.5-1.636M18.75 3l-1.5.545m0 6.205l3 1m1.5.5l-1.5-.5M6.75 7.364V3h-3v18m3-13.636l10.5-3.819" />
            </svg>
            <span class="text-xl font-bold">Wüstenstein</span>
          </a>
        </div>
        <ul class="menu p-4 space-y-2">
          <!-- Dashboard -->
          <li>
            <a href="/dashboard" class="gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" />
              </svg>
              Dashboard
            </a>
          </li>

          <!-- Aufenthalte -->
          <li>
            <a href="/aufenthalte" class="gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
              </svg>
              Aufenthalte
            </a>
          </li>

          <!-- Terminplanung -->
          <li>
            <a href="/terminplanung" class="gap-3 justify-between">
              <span class="flex items-center gap-3">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5m-9-6h.008v.008H12v-.008zM12 15h.008v.008H12V15zm0 2.25h.008v.008H12v-.008zM9.75 15h.008v.008H9.75V15zm0 2.25h.008v.008H9.75v-.008zM7.5 15h.008v.008H7.5V15zm0 2.25h.008v.008H7.5v-.008zm6.75-4.5h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V15zm0 2.25h.008v.008h-.008v-.008zm2.25-4.5h.008v.008H16.5v-.008zm0 2.25h.008v.008H16.5V15z" />
                </svg>
                Terminplanung
              </span>
              <span id="pending-termine-badge" class="badge badge-warning badge-sm hidden">0</span>
            </a>
          </li>

          <!-- Chat-Assistent -->
          <li>
            <a href="/chat" class="gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M8.625 12a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H8.25m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0H12m4.125 0a.375.375 0 11-.75 0 .375.375 0 01.75 0zm0 0h-.375M21 12c0 4.556-4.03 8.25-9 8.25a9.764 9.764 0 01-2.555-.337A5.972 5.972 0 015.41 20.97a5.969 5.969 0 01-.474-.065 4.48 4.48 0 00.978-2.025c.09-.457-.133-.901-.467-1.226C3.93 16.178 3 14.189 3 12c0-4.556 4.03-8.25 9-8.25s9 3.694 9 8.25z" />
              </svg>
              Chat-Assistent
            </a>
          </li>

          <!-- Checklisten -->
          <li>
            <a href="/checklisten" class="gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
              </svg>
              Checklisten
            </a>
          </li>

          <!-- Admin Links -->
          {isAdmin && (
            <>
              <li>
                <a href="/tankfuellungen" class="gap-3">
                  <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                    <path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.361-6.867 8.21 8.21 0 003 2.48z" />
                    <path stroke-linecap="round" stroke-linejoin="round" d="M12 18a3.75 3.75 0 00.495-7.467 5.99 5.99 0 00-1.925 3.546 5.974 5.974 0 01-2.133-1A3.75 3.75 0 0012 18z" />
                  </svg>
                  Tankfüllungen
                </a>
              </li>
            </>
          )}

          <!-- Statistiken -->
          <li>
            <a href="/statistiken" class="gap-3">
              <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
                <path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" />
              </svg>
              Statistiken
            </a>
          </li>
        </ul>

        <!-- Spacer to push bottom section down -->
        <div class="flex-1"></div>

        <!-- Bottom Section: User & Settings -->
        <div class="border-t">
          <!-- User Info -->
          <a href="/profil" class="flex items-center gap-3 p-4 hover:bg-base-200 transition-colors">
            <div class="avatar placeholder">
              <div id="sidebar-avatar" class="bg-neutral text-neutral-content rounded-full w-10 flex items-center justify-center overflow-hidden">
                <span id="sidebar-avatar-initials" class="text-sm">{user.name?.charAt(0).toUpperCase() || 'U'}</span>
                <img id="sidebar-avatar-image" src="" alt="" class="w-full h-full object-cover hidden" />
              </div>
            </div>
            <div class="flex-1 min-w-0">
              <p class="text-sm font-medium truncate">{user.name}</p>
              <p class="text-xs opacity-70">Profil anzeigen</p>
            </div>
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-4 h-4 opacity-70">
              <path stroke-linecap="round" stroke-linejoin="round" d="M8.25 4.5l7.5 7.5-7.5 7.5" />
            </svg>
          </a>

          <!-- Admin Links -->
          {isAdmin && (
            <>
              <a href="/admin/dashboard" class="flex items-center gap-3 px-4 py-3 hover:bg-base-200 transition-colors border-t">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 opacity-70">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 11-3 0m3 0a1.5 1.5 0 10-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 01-3 0m3 0a1.5 1.5 0 00-3 0m-9.75 0h9.75" />
                </svg>
                <span class="text-sm">Admin-Bereich</span>
              </a>
              <a href="/admin/wissensdatenbank" class="flex items-center gap-3 px-4 py-3 hover:bg-base-200 transition-colors border-t">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 opacity-70">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 6.042A8.967 8.967 0 006 3.75c-1.052 0-2.062.18-3 .512v14.25A8.987 8.987 0 016 18c2.305 0 4.408.867 6 2.292m0-14.25a8.966 8.966 0 016-2.292c1.052 0 2.062.18 3 .512v14.25A8.987 8.987 0 0018 18a8.967 8.967 0 00-6 2.292m0-14.25v14.25" />
                </svg>
                <span class="text-sm">Wissensdatenbank</span>
              </a>
              <a href="/admin/checklisten" class="flex items-center gap-3 px-4 py-3 hover:bg-base-200 transition-colors border-t">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 opacity-70">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M9 12.75L11.25 15 15 9.75M21 12a9 9 0 11-18 0 9 9 0 0118 0z" />
                </svg>
                <span class="text-sm">Checklisten verwalten</span>
              </a>
              <a href="/debug" class="flex items-center gap-3 px-4 py-3 hover:bg-base-200 transition-colors border-t">
                <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 opacity-70">
                  <path stroke-linecap="round" stroke-linejoin="round" d="M12 12.75c1.148 0 2.278.08 3.383.237 1.037.146 1.866.966 1.866 2.013 0 3.728-2.35 6.75-5.25 6.75S6.75 18.728 6.75 15c0-1.046.83-1.867 1.866-2.013A24.204 24.204 0 0112 12.75zm0 0c2.883 0 5.647.508 8.207 1.44a23.91 23.91 0 01-1.152 6.06M12 12.75c-2.883 0-5.647.508-8.208 1.44.125 2.104.52 4.136 1.153 6.06M12 12.75a2.25 2.25 0 002.248-2.354M12 12.75a2.25 2.25 0 01-2.248-2.354M12 8.25c.995 0 1.971-.08 2.922-.236.403-.066.74-.358.795-.762a3.778 3.778 0 00-.399-2.25M12 8.25c-.995 0-1.97-.08-2.922-.236-.402-.066-.74-.358-.795-.762a3.734 3.734 0 01.4-2.253M12 8.25a2.25 2.25 0 00-2.248 2.146M12 8.25a2.25 2.25 0 012.248 2.146M8.683 5a6.032 6.032 0 01-1.155-1.002c.07-.63.27-1.222.574-1.747m.581 2.749A3.75 3.75 0 0115.318 5m0 0c.427-.283.815-.62 1.155-.999a4.471 4.471 0 00-.575-1.752M4.921 6a24.048 24.048 0 00-.392 3.314c1.668.546 3.416.914 5.223 1.082M19.08 6c.205 1.08.337 2.187.392 3.314a23.882 23.882 0 01-5.223 1.082" />
                </svg>
                <span class="text-sm">Debug</span>
              </a>
            </>
          )}

          <!-- Settings Row: Theme & Font Size -->
          <div class="flex items-center justify-between px-4 py-3 border-t">
            <!-- Theme Toggle -->
            <button id="theme-toggle-btn" class="btn btn-ghost btn-sm btn-square" title="Theme wechseln">
              <!-- Sun Icon (shown in dark mode, click to switch to light) -->
              <svg id="theme-icon-sun" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 hidden">
                <path stroke-linecap="round" stroke-linejoin="round" d="M12 3v2.25m6.364.386l-1.591 1.591M21 12h-2.25m-.386 6.364l-1.591-1.591M12 18.75V21m-4.773-4.227l-1.591 1.591M5.25 12H3m4.227-4.773L5.636 5.636M15.75 12a3.75 3.75 0 11-7.5 0 3.75 3.75 0 017.5 0z" />
              </svg>
              <!-- Moon Icon (shown in light mode, click to switch to dark) -->
              <svg id="theme-icon-moon" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5 hidden">
                <path stroke-linecap="round" stroke-linejoin="round" d="M21.752 15.002A9.718 9.718 0 0118 15.75c-5.385 0-9.75-4.365-9.75-9.75 0-1.33.266-2.597.748-3.752A9.753 9.753 0 003 11.25C3 16.635 7.365 21 12.75 21a9.753 9.753 0 009.002-5.998z" />
              </svg>
              <span class="sr-only" id="theme-label">Theme wechseln</span>
            </button>

            <!-- Font Size Controls -->
            <div class="flex items-center gap-1">
              <button id="font-decrease" class="btn btn-ghost btn-xs btn-square" title="Schrift kleiner">
                <span class="text-xs font-bold">A-</span>
              </button>
              <button id="font-increase" class="btn btn-ghost btn-xs btn-square" title="Schrift größer">
                <span class="text-sm font-bold">A+</span>
              </button>
            </div>
          </div>

          <!-- Logout -->
          <button id="logout-btn" class="flex items-center gap-3 w-full px-4 py-3 mb-4 text-error hover:bg-error/10 transition-colors border-t">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5">
              <path stroke-linecap="round" stroke-linejoin="round" d="M15.75 9V5.25A2.25 2.25 0 0013.5 3h-6a2.25 2.25 0 00-2.25 2.25v13.5A2.25 2.25 0 007.5 21h6a2.25 2.25 0 002.25-2.25V15M12 9l-3 3m0 0l3 3m-3-3h12.75" />
            </svg>
            <span class="text-sm">Abmelden</span>
          </button>
        </div>
      </aside>
    </div>

    <!-- Floating Action Button for Mobile Navigation -->
    <label for="main-drawer" class="btn btn-circle btn-primary fixed bottom-4 right-4 z-50 shadow-lg lg:hidden">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="2" stroke="currentColor" class="w-6 h-6">
        <path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6.75h16.5M3.75 12h16.5m-16.5 5.25h16.5" />
      </svg>
    </label>
  </body>
</html>

<script>
  // Theme Switcher Logic
  function initTheme() {
    const toggleBtn = document.getElementById('theme-toggle-btn');
    const sunIcon = document.getElementById('theme-icon-sun');
    const moonIcon = document.getElementById('theme-icon-moon');
    const themeLabel = document.getElementById('theme-label');
    if (!toggleBtn || !sunIcon || !moonIcon) return;

    const html = document.documentElement;

    // Update icons based on current theme
    function updateThemeIcons() {
      const currentTheme = html.getAttribute('data-theme') || 'light';
      if (currentTheme === 'dark') {
        // Dark mode: show sun (to switch to light)
        sunIcon.classList.remove('hidden');
        moonIcon.classList.add('hidden');
        if (themeLabel) themeLabel.textContent = 'Zu Hell wechseln';
      } else {
        // Light mode: show moon (to switch to dark)
        sunIcon.classList.add('hidden');
        moonIcon.classList.remove('hidden');
        if (themeLabel) themeLabel.textContent = 'Zu Dunkel wechseln';
      }
    }

    updateThemeIcons();

    // Theme toggle handler - speichert explizite Wahl in localStorage
    toggleBtn.addEventListener('click', () => {
      const current = html.getAttribute('data-theme') || 'light';
      const newTheme = current === 'light' ? 'dark' : 'light';
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
      updateThemeIcons();
    });

    // Auf System-Änderungen reagieren und Icons aktualisieren
    window.matchMedia('(prefers-color-scheme: dark)').addEventListener('change', () => {
      updateThemeIcons();
    });
  }

  // Logout handler — clear caches and redirect to login
  async function logout() {
    try {
      await csrfFetch('/api/auth/logout', { method: 'POST' });
    } catch (error) {
      console.error('Logout error:', error);
    }

    // Clear Service Worker caches so cached pages don't persist after logout
    if ('caches' in window) {
      const cacheNames = await caches.keys();
      await Promise.all(cacheNames.map(name => caches.delete(name)));
    }

    window.location.href = '/login';
  }

  // Font Size Logic
  function initFontSize() {
    const html = document.documentElement;
    const savedSize = localStorage.getItem('fontSize') || '100';
    html.style.fontSize = savedSize + '%';

    const decreaseBtn = document.getElementById('font-decrease');
    const increaseBtn = document.getElementById('font-increase');

    decreaseBtn?.addEventListener('click', () => {
      const current = parseInt(localStorage.getItem('fontSize') || '100');
      const newSize = Math.max(80, current - 10); // Min 80%
      html.style.fontSize = newSize + '%';
      localStorage.setItem('fontSize', newSize.toString());
    });

    increaseBtn?.addEventListener('click', () => {
      const current = parseInt(localStorage.getItem('fontSize') || '100');
      const newSize = Math.min(130, current + 10); // Max 130%
      html.style.fontSize = newSize + '%';
      localStorage.setItem('fontSize', newSize.toString());
    });
  }

  // Load profile image from API
  async function loadProfileImage() {
    try {
      const response = await fetch('/api/auth/me');
      if (response.ok) {
        const user = await response.json();
        if (user.profileImage) {
          const avatarImage = document.getElementById('sidebar-avatar-image') as HTMLImageElement;
          const avatarInitials = document.getElementById('sidebar-avatar-initials');

          if (avatarImage && avatarInitials) {
            avatarImage.src = user.profileImage;
            avatarImage.alt = user.name;
            avatarImage.classList.remove('hidden');
            avatarInitials.classList.add('hidden');
          }
        }
      }
    } catch (error) {
      // Profilbild-Fehler ist nicht kritisch, Initialen bleiben sichtbar
    }
  }

  // Load pending Termine count for navigation badge
  async function loadPendingTermine() {
    try {
      const response = await fetch('/api/terminplanung/pending');
      if (response.ok) {
        const data = await response.json();
        const badge = document.getElementById('pending-termine-badge');
        if (badge) {
          if (data.count > 0) {
            badge.textContent = data.count.toString();
            badge.classList.remove('hidden');
          } else {
            badge.classList.add('hidden');
          }
        }
      }
    } catch (error) {
      // Badge-Fehler ist nicht kritisch
    }
  }

  // CSRF-geschützter Fetch - nutze diese Funktion für alle state-ändernden Requests
  function getCsrfToken(): string {
    const meta = document.querySelector('meta[name="csrf-token"]');
    return meta?.getAttribute('content') || '';
  }

  // Globale Fetch-Funktion mit CSRF-Token für POST/PUT/DELETE
  async function csrfFetch(url: string, options: RequestInit = {}): Promise<Response> {
    const method = options.method?.toUpperCase() || 'GET';

    // CSRF-Token nur für state-ändernde Requests hinzufügen
    if (['POST', 'PUT', 'DELETE', 'PATCH'].includes(method)) {
      const headers = new Headers(options.headers);
      headers.set('X-CSRF-Token', getCsrfToken());
      // Content-Type nur setzen wenn kein FormData (Browser setzt boundary automatisch)
      if (!headers.has('Content-Type') && options.body && !(options.body instanceof FormData)) {
        headers.set('Content-Type', 'application/json');
      }
      options.headers = headers;
    }

    return fetch(url, options);
  }

  // Global verfügbar machen
  (window as any).csrfFetch = csrfFetch;
  (window as any).getCsrfToken = getCsrfToken;

  // Service Worker registrieren (für PWA + Push Notifications) - nur in Production
  async function registerServiceWorker() {
    if ('serviceWorker' in navigator && location.hostname !== 'localhost') {
      try {
        const registration = await navigator.serviceWorker.register('/sw.js', { scope: '/' });
        console.log('Service Worker registriert:', registration.scope);
      } catch (error) {
        console.error('Service Worker Registrierung fehlgeschlagen:', error);
      }
    }
  }

  // Initialize on load
  document.addEventListener('DOMContentLoaded', () => {
    initTheme();
    initFontSize();
    loadProfileImage();
    loadPendingTermine();
    registerServiceWorker();

    // Logout button handler
    const logoutBtn = document.getElementById('logout-btn');
    logoutBtn?.addEventListener('click', logout);

    // Listen for pending termine changes (from Terminplanung page)
    window.addEventListener('pending-termine-changed', () => {
      loadPendingTermine();
    });
  });
</script>
