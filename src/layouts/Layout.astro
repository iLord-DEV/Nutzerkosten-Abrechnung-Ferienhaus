---
export interface Props {
  title: string;
  description?: string;
}

const { title, description = "Nutzerkosten-Abrechnung für Wohngemeinschaften" } = Astro.props;
---

<!DOCTYPE html>
<html lang="de">
  <head>
    <meta charset="UTF-8" />
    <meta name="description" content={description} />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <title>{title}</title>
    <!-- Load theme immediately to prevent flash -->
    <script is:inline>
      (function() {
        const theme = localStorage.getItem('theme') || 'light';
        document.documentElement.setAttribute('data-theme', theme);
      })();
    </script>
  </head>
  <body class="min-h-screen bg-base-200 drawer lg:drawer-open">
    <!-- Mobile Drawer -->
    <input id="main-drawer" type="checkbox" class="drawer-toggle" />

    <!-- Navigation -->
    <div class="drawer-content flex flex-col">
      <!-- Navbar -->
      <div class="navbar bg-base-100 shadow-md sticky top-0 z-50">
        <!-- Mobile Menu Button -->
        <div class="flex-none lg:hidden">
          <label for="main-drawer" aria-label="open sidebar" class="btn btn-square btn-ghost">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" class="inline-block w-5 h-5 stroke-current">
              <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"></path>
            </svg>
          </label>
        </div>

        <!-- Logo -->
        <div class="flex-1">
          <a href="/" class="btn btn-ghost normal-case text-xl gap-2">
            <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-6 h-6">
              <path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" />
            </svg>
            <span class="hidden sm:inline">Nutzerkosten</span>
          </a>
        </div>

        <!-- Right Side Actions -->
        <div class="flex-none gap-2">
          <!-- Theme Switcher -->
          <label class="swap swap-rotate btn btn-ghost btn-circle">
            <input type="checkbox" id="theme-toggle" class="theme-controller" />
            <!-- Sun Icon -->
            <svg class="swap-off fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path d="M5.64,17l-.71.71a1,1,0,0,0,0,1.41,1,1,0,0,0,1.41,0l.71-.71A1,1,0,0,0,5.64,17ZM5,12a1,1,0,0,0-1-1H3a1,1,0,0,0,0,2H4A1,1,0,0,0,5,12Zm7-7a1,1,0,0,0,1-1V3a1,1,0,0,0-2,0V4A1,1,0,0,0,12,5ZM5.64,7.05a1,1,0,0,0,.7.29,1,1,0,0,0,.71-.29,1,1,0,0,0,0-1.41l-.71-.71A1,1,0,0,0,4.93,6.34Zm12,.29a1,1,0,0,0,.7-.29l.71-.71a1,1,0,1,0-1.41-1.41L17,5.64a1,1,0,0,0,0,1.41A1,1,0,0,0,17.66,7.34ZM21,11H20a1,1,0,0,0,0,2h1a1,1,0,0,0,0-2Zm-9,8a1,1,0,0,0-1,1v1a1,1,0,0,0,2,0V20A1,1,0,0,0,12,19ZM18.36,17A1,1,0,0,0,17,18.36l.71.71a1,1,0,0,0,1.41,0,1,1,0,0,0,0-1.41ZM12,6.5A5.5,5.5,0,1,0,17.5,12,5.51,5.51,0,0,0,12,6.5Zm0,9A3.5,3.5,0,1,1,15.5,12,3.5,3.5,0,0,1,12,15.5Z"/>
            </svg>
            <!-- Moon Icon -->
            <svg class="swap-on fill-current w-5 h-5" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24">
              <path d="M21.64,13a1,1,0,0,0-1.05-.14,8.05,8.05,0,0,1-3.37.73A8.15,8.15,0,0,1,9.08,5.49a8.59,8.59,0,0,1,.25-2A1,1,0,0,0,8,2.36,10.14,10.14,0,1,0,22,14.05,1,1,0,0,0,21.64,13Zm-9.5,6.69A8.14,8.14,0,0,1,7.08,5.22v.27A10.15,10.15,0,0,0,17.22,15.63a9.79,9.79,0,0,0,2.1-.22A8.11,8.11,0,0,1,12.14,19.73Z"/>
            </svg>
          </label>

          <!-- User Menu (Desktop) -->
          <div id="desktop-auth" class="hidden lg:flex items-center gap-2">
            <a href="/login" id="login-link" class="btn btn-primary btn-sm">
              Anmelden
            </a>
          </div>
        </div>
      </div>

      <!-- Main Content -->
      <main class="flex-1 p-4 lg:p-6">
        <div class="max-w-7xl mx-auto">
          <slot />
        </div>
      </main>

      <!-- Footer -->
      <footer class="footer footer-center p-4 bg-base-100 text-base-content border-t">
        <aside>
          <p class="text-sm opacity-70">© {new Date().getFullYear()} Nutzerkosten-Abrechnung. Alle Rechte vorbehalten.</p>
        </aside>
      </footer>
    </div>

    <!-- Sidebar (Desktop) + Drawer (Mobile) -->
    <div class="drawer-side z-40">
      <label for="main-drawer" aria-label="close sidebar" class="drawer-overlay"></label>
      <aside class="bg-base-100 w-64 min-h-full">
        <div class="p-4 border-b">
          <h2 class="text-lg font-bold">Navigation</h2>
        </div>
        <ul id="nav-menu" class="menu p-4 space-y-2">
          <!-- Navigation wird hier dynamisch eingefügt -->
          <li class="disabled">
            <span class="text-base-content/50">Melden Sie sich an, um auf die Navigation zuzugreifen</span>
          </li>
        </ul>

        <!-- Mobile Auth Buttons -->
        <div id="mobile-auth" class="p-4 border-t lg:hidden">
          <a href="/login" id="mobile-login-link" class="btn btn-primary btn-block btn-sm">
            Anmelden
          </a>
        </div>
      </aside>
    </div>
  </body>
</html>

<script>
  // Theme Switcher Logic
  let themeInitialized = false;

  function initTheme() {
    if (themeInitialized) return; // Prevent multiple initializations

    const toggle = document.getElementById('theme-toggle') as HTMLInputElement;
    if (!toggle) return;

    const html = document.documentElement;

    // Get current theme from data-theme attribute (already set by inline script)
    const currentTheme = html.getAttribute('data-theme') || 'light';
    const isDark = currentTheme === 'dark';

    // Set toggle state based on current theme
    toggle.checked = isDark;

    // Theme toggle handler
    toggle.addEventListener('change', () => {
      const newTheme = toggle.checked ? 'dark' : 'light';
      html.setAttribute('data-theme', newTheme);
      localStorage.setItem('theme', newTheme);
    });

    themeInitialized = true;
  }

  // Navigation Menu Icons
  const icons = {
    home: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M2.25 12l8.954-8.955c.44-.439 1.152-.439 1.591 0L21.75 12M4.5 9.75v10.125c0 .621.504 1.125 1.125 1.125H9.75v-4.875c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125V21h4.125c.621 0 1.125-.504 1.125-1.125V9.75M8.25 21h8.25" /></svg>',
    calendar: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5" /></svg>',
    chart: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3 13.125C3 12.504 3.504 12 4.125 12h2.25c.621 0 1.125.504 1.125 1.125v6.75C7.5 20.496 6.996 21 6.375 21h-2.25A1.125 1.125 0 013 19.875v-6.75zM9.75 8.625c0-.621.504-1.125 1.125-1.125h2.25c.621 0 1.125.504 1.125 1.125v11.25c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V8.625zM16.5 4.125c0-.621.504-1.125 1.125-1.125h2.25C20.496 3 21 3.504 21 4.125v15.75c0 .621-.504 1.125-1.125 1.125h-2.25a1.125 1.125 0 01-1.125-1.125V4.125z" /></svg>',
    calendar2: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M6.75 3v2.25M17.25 3v2.25M3 18.75V7.5a2.25 2.25 0 012.25-2.25h13.5A2.25 2.25 0 0121 7.5v11.25m-18 0A2.25 2.25 0 005.25 21h13.5A2.25 2.25 0 0021 18.75m-18 0v-7.5A2.25 2.25 0 015.25 9h13.5A2.25 2.25 0 0121 11.25v7.5m-9-6h.008v.008H12v-.008zM12 15h.008v.008H12V15zm0 2.25h.008v.008H12v-.008zM9.75 15h.008v.008H9.75V15zm0 2.25h.008v.008H9.75v-.008zM7.5 15h.008v.008H7.5V15zm0 2.25h.008v.008H7.5v-.008zm6.75-4.5h.008v.008h-.008v-.008zm0 2.25h.008v.008h-.008V15zm0 2.25h.008v.008h-.008v-.008zm2.25-4.5h.008v.008H16.5v-.008zm0 2.25h.008v.008H16.5V15z" /></svg>',
    fire: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M15.362 5.214A8.252 8.252 0 0112 21 8.25 8.25 0 016.038 7.048 8.287 8.287 0 009 9.6a8.983 8.983 0 013.361-6.867 8.21 8.21 0 003 2.48z" /><path stroke-linecap="round" stroke-linejoin="round" d="M12 18a3.75 3.75 0 00.495-7.467 5.99 5.99 0 00-1.925 3.546 5.974 5.974 0 01-2.133-1A3.75 3.75 0 0012 18z" /></svg>',
    bug: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M12 12.75c1.148 0 2.278.08 3.383.237 1.037.146 1.866.966 1.866 2.013 0 3.728-2.35 6.75-5.25 6.75S6.75 18.728 6.75 15c0-1.046.83-1.867 1.866-2.013A24.204 24.204 0 0112 12.75zm0 0c2.883 0 5.647.508 8.207 1.44a23.91 23.91 0 01-1.152 6.06M12 12.75c-2.883 0-5.647.508-8.208 1.44.125 2.104.52 4.136 1.153 6.06M12 12.75a2.25 2.25 0 002.248-2.354M12 12.75a2.25 2.25 0 01-2.248-2.354M12 8.25c.995 0 1.971-.08 2.922-.236.403-.066.74-.358.795-.762a3.778 3.778 0 00-.399-2.25M12 8.25c-.995 0-1.97-.08-2.922-.236-.402-.066-.74-.358-.795-.762a3.734 3.734 0 01.4-2.253M12 8.25a2.25 2.25 0 00-2.248 2.146M12 8.25a2.25 2.25 0 012.248 2.146M8.683 5a6.032 6.032 0 01-1.155-1.002c.07-.63.27-1.222.574-1.747m.581 2.749A3.75 3.75 0 0115.318 5m0 0c.427-.283.815-.62 1.155-.999a4.471 4.471 0 00-.575-1.752M4.921 6a24.048 24.048 0 00-.392 3.314c1.668.546 3.416.914 5.223 1.082M19.08 6c.205 1.08.337 2.187.392 3.314a23.882 23.882 0 01-5.223 1.082" /></svg>',
    dashboard: '<svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-5 h-5"><path stroke-linecap="round" stroke-linejoin="round" d="M3.75 6A2.25 2.25 0 016 3.75h2.25A2.25 2.25 0 0110.5 6v2.25a2.25 2.25 0 01-2.25 2.25H6a2.25 2.25 0 01-2.25-2.25V6zM3.75 15.75A2.25 2.25 0 016 13.5h2.25a2.25 2.25 0 012.25 2.25V18a2.25 2.25 0 01-2.25 2.25H6A2.25 2.25 0 013.75 18v-2.25zM13.5 6a2.25 2.25 0 012.25-2.25H18A2.25 2.25 0 0120.25 6v2.25A2.25 2.25 0 0118 10.5h-2.25a2.25 2.25 0 01-2.25-2.25V6zM13.5 15.75a2.25 2.25 0 012.25-2.25H18a2.25 2.25 0 012.25 2.25V18A2.25 2.25 0 0118 20.25h-2.25A2.25 2.25 0 0113.5 18v-2.25z" /></svg>',
  };

  // Navigation update logic
  async function updateNavigation() {
    try {
      const response = await fetch('/api/auth/me');
      if (response.ok) {
        const user = await response.json();
        const navMenu = document.getElementById('nav-menu');
        const desktopAuth = document.getElementById('desktop-auth');
        const mobileAuth = document.getElementById('mobile-auth');

        // Build navigation menu based on role
        let menuItems = '';
        if (user.role === 'ADMIN') {
          menuItems = `
            <li><a href="/dashboard">${icons.dashboard} Dashboard</a></li>
            <li><a href="/aufenthalte">${icons.home} Aufenthalte</a></li>
            <li><a href="/terminplanung">${icons.calendar2} Terminplanung</a></li>
            <li><a href="/tankfuellungen">${icons.fire} Tankfüllungen</a></li>
            <li><a href="/statistiken">${icons.chart} Statistiken</a></li>
            <li><a href="/debug">${icons.bug} Debug</a></li>
          `;
        } else {
          menuItems = `
            <li><a href="/dashboard">${icons.dashboard} Dashboard</a></li>
            <li><a href="/aufenthalte">${icons.home} Aufenthalte</a></li>
            <li><a href="/terminplanung">${icons.calendar2} Terminplanung</a></li>
            <li><a href="/statistiken">${icons.chart} Statistiken</a></li>
          `;
        }

        if (navMenu) {
          navMenu.innerHTML = menuItems;
        }

        // Update desktop auth
        if (desktopAuth) {
          if (user.role === 'ADMIN') {
            desktopAuth.innerHTML = `
              <a href="/admin/dashboard" class="btn btn-ghost btn-sm">Admin</a>
              <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar placeholder">
                  <div class="bg-neutral text-neutral-content rounded-full w-10 flex items-center justify-center">
                    <span class="text-sm">${user.name.substring(0, 2).toUpperCase()}</span>
                  </div>
                </div>
                <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-52">
                  <li><a href="/profil">Profil</a></li>
                  <li><button id="logout-btn-desktop" class="text-error">Abmelden</button></li>
                </ul>
              </div>
            `;
          } else {
            desktopAuth.innerHTML = `
              <div class="dropdown dropdown-end">
                <div tabindex="0" role="button" class="btn btn-ghost btn-circle avatar placeholder">
                  <div class="bg-neutral text-neutral-content rounded-full w-10 flex items-center justify-center">
                    <span class="text-sm">${user.name.substring(0, 2).toUpperCase()}</span>
                  </div>
                </div>
                <ul tabindex="0" class="menu menu-sm dropdown-content mt-3 z-[1] p-2 shadow bg-base-100 rounded-box w-52">
                  <li class="menu-title">${user.name}</li>
                  <li><a href="/profil">Profil</a></li>
                  <li><button id="logout-btn-desktop" class="text-error">Abmelden</button></li>
                </ul>
              </div>
            `;
          }
        }

        // Update mobile auth
        if (mobileAuth) {
          mobileAuth.innerHTML = `
            <div class="text-sm mb-2">Angemeldet als: <strong>${user.name}</strong></div>
            <button id="logout-btn-mobile" class="btn btn-error btn-block btn-sm">Abmelden</button>
          `;
        }
      }
    } catch (error) {
      // Not logged in - keep default state
      console.log('User not authenticated');
    }
  }

  // Logout handler
  async function logout() {
    try {
      const response = await fetch('/api/auth/logout', { method: 'POST' });
      if (response.ok) {
        window.location.href = '/';
      }
    } catch (error) {
      console.error('Logout error:', error);
    }
  }

  // Initialize on load
  document.addEventListener('DOMContentLoaded', () => {
    initTheme();
    updateNavigation();

    // Logout button handlers
    document.addEventListener('click', (e) => {
      const target = e.target as HTMLElement;
      if (target.id === 'logout-btn-desktop' || target.id === 'logout-btn-mobile') {
        logout();
      }
    });
  });
</script>

<style>
  @import '../styles/global.css';
</style>
