generator client {
  provider      = "prisma-client-js"
  binaryTargets = ["native", "linux-arm64-openssl-3.0.x", "debian-openssl-3.0.x"]
}

datasource db {
  provider = "mysql"
  url      = env("DATABASE_URL")
}

model User {
  id                 Int                    @id @default(autoincrement())
  email              String                 @unique
  username           String?                @unique
  name               String
  profileImage       String?
  role               Role                   @default(USER)
  beguenstigt        Boolean                @default(false)
  notifyOnComments   Boolean                @default(false)
  notifyOnTermine    Boolean                @default(false)
  createdAt          DateTime               @default(now())
  aufenthalte        Aufenthalt[]
  BlogComment        BlogComment[]
  BlogPost           BlogPost[]
  PollVote           PollVote[]
  terminAbstimmungen TerminAbstimmung[]
  terminAenderungen  TerminAenderung[]
  terminKommentare   TerminKommentar[]
  terminPlanungen    TerminPlanung[]
  jahresabschluesse  UserJahresabschluss[]
  magicLinkTokens    MagicLinkToken[]
  pushSubscriptions  PushSubscription[]
}

model Aufenthalt {
  id                        Int      @id @default(autoincrement())
  userId                    Int
  ankunft                   DateTime
  abreise                   DateTime
  zaehlerAnkunft            Float
  zaehlerAbreise            Float
  uebernachtungenMitglieder Int      @default(0)
  uebernachtungenGaeste     Int      @default(0)
  naechteBerechnen          Boolean?
  jahr                      Int
  zaehlerId                 Int?
  zaehlerAbreiseId          Int?
  createdAt                 DateTime @default(now())
  updatedAt                 DateTime @updatedAt
  user                      User     @relation(fields: [userId], references: [id])
  zaehlerAbreiseRef         Zaehler? @relation("AufenthaltAbreise", fields: [zaehlerAbreiseId], references: [id])
  zaehler                   Zaehler? @relation("AufenthaltAnkunft", fields: [zaehlerId], references: [id])

  @@index([userId], map: "Aufenthalt_userId_fkey")
  @@index([zaehlerAbreiseId], map: "Aufenthalt_zaehlerAbreiseId_fkey")
  @@index([zaehlerId], map: "Aufenthalt_zaehlerId_fkey")
}

model Tankfuellung {
  id            Int      @id @default(autoincrement())
  datum         DateTime
  liter         Float
  preisProLiter Float
  zaehlerstand  Float
  zaehlerId     Int?
  notizen       String?
  createdAt     DateTime @default(now())
  zaehler       Zaehler? @relation(fields: [zaehlerId], references: [id])

  @@index([zaehlerId], map: "Tankfuellung_zaehlerId_fkey")
}

model Zaehler {
  id                 Int            @id @default(autoincrement())
  einbauDatum        DateTime
  ausbauDatum        DateTime?
  letzterStand       Float
  istAktiv           Boolean        @default(true)
  notizen            String?
  createdAt          DateTime       @default(now())
  updatedAt          DateTime       @updatedAt
  aufenthalteAbreise Aufenthalt[]   @relation("AufenthaltAbreise")
  aufenthalteAnkunft Aufenthalt[]   @relation("AufenthaltAnkunft")
  tankfuellungen     Tankfuellung[]
}

model Preise {
  jahr                  Int       @id
  oelpreisProLiter      Float
  uebernachtungMitglied Float
  uebernachtungGast     Float
  verbrauchProStunde    Float     @default(5.5)
  istBerechnet          Boolean   @default(false)
  gueltigAb             DateTime?
  createdAt             DateTime  @default(now())
  updatedAt             DateTime  @updatedAt
}

model JahresAbschluss {
  jahr               Int   @id
  zaehlerstand       Float
  gesamtKosten       Float
  anzahlAufenthalte  Int
  verbrauchProStunde Float
}

model UserJahresabschluss {
  id        Int      @id @default(autoincrement())
  userId    Int
  jahr      Int
  bezahlt   Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id])

  @@unique([userId, jahr])
  @@index([userId], map: "UserJahresabschluss_userId_fkey")
}

model TerminPlanung {
  id           Int                @id @default(autoincrement())
  userId       Int
  titel        String
  startDatum   DateTime
  endDatum     DateTime
  beschreibung String?
  status       TerminStatus       @default(PENDING)
  version      Int                @default(1)
  createdAt    DateTime           @default(now())
  updatedAt    DateTime           @updatedAt
  abstimmungen TerminAbstimmung[]
  aenderungen  TerminAenderung[]
  kommentare   TerminKommentar[]
  user         User               @relation(fields: [userId], references: [id])

  @@index([userId], map: "TerminPlanung_userId_fkey")
}

model TerminAbstimmung {
  id              Int            @id @default(autoincrement())
  terminPlanungId Int
  userId          Int
  stimme          AbstimmungsTyp
  kommentar       String?
  version         Int
  createdAt       DateTime       @default(now())
  updatedAt       DateTime       @updatedAt
  terminPlanung   TerminPlanung  @relation(fields: [terminPlanungId], references: [id])
  user            User           @relation(fields: [userId], references: [id])

  @@index([terminPlanungId], map: "TerminAbstimmung_terminPlanungId_fkey")
  @@index([userId], map: "TerminAbstimmung_userId_fkey")
}

model TerminKommentar {
  id              Int               @id @default(autoincrement())
  terminPlanungId Int
  userId          Int
  inhalt          String
  version         Int
  createdAt       DateTime          @default(now())
  parentId        Int?
  parent          TerminKommentar?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies         TerminKommentar[] @relation("CommentReplies")
  terminPlanung   TerminPlanung     @relation(fields: [terminPlanungId], references: [id])
  user            User              @relation(fields: [userId], references: [id])

  @@index([parentId], map: "TerminKommentar_parentId_fkey")
  @@index([terminPlanungId], map: "TerminKommentar_terminPlanungId_fkey")
  @@index([userId], map: "TerminKommentar_userId_fkey")
}

model TerminAenderung {
  id              Int           @id @default(autoincrement())
  terminPlanungId Int
  userId          Int
  alteStartDatum  DateTime
  alteEndDatum    DateTime
  neueStartDatum  DateTime
  neueEndDatum    DateTime
  grund           String?
  version         Int
  createdAt       DateTime      @default(now())
  terminPlanung   TerminPlanung @relation(fields: [terminPlanungId], references: [id])
  user            User          @relation(fields: [userId], references: [id])

  @@index([terminPlanungId], map: "TerminAenderung_terminPlanungId_fkey")
  @@index([userId], map: "TerminAenderung_userId_fkey")
}

model BlogComment {
  id                Int           @id @default(autoincrement())
  postId            Int
  authorId          Int
  content           String        @db.Text
  createdAt         DateTime      @default(now())
  updatedAt         DateTime
  parentId          Int?
  User              User          @relation(fields: [authorId], references: [id])
  BlogComment       BlogComment?  @relation("BlogCommentToBlogComment", fields: [parentId], references: [id])
  other_BlogComment BlogComment[] @relation("BlogCommentToBlogComment")
  BlogPost          BlogPost      @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([authorId], map: "BlogComment_authorId_fkey")
  @@index([parentId], map: "BlogComment_parentId_fkey")
  @@index([postId], map: "BlogComment_postId_fkey")
}

model BlogImage {
  id           Int      @id @default(autoincrement())
  postId       Int
  filename     String
  originalName String
  mimeType     String
  size         Int
  alt          String?
  caption      String?
  sortOrder    Int      @default(0)
  createdAt    DateTime @default(now())
  BlogPost     BlogPost @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId], map: "BlogImage_postId_fkey")
}

model BlogModule {
  id        Int             @id @default(autoincrement())
  postId    Int
  type      BlogModule_type
  content   String          @db.LongText
  position  Int
  createdAt DateTime        @default(now())
  BlogPost  BlogPost        @relation(fields: [postId], references: [id], onDelete: Cascade)

  @@index([postId], map: "BlogModule_postId_fkey")
}

model BlogPost {
  id          Int             @id @default(autoincrement())
  title       String
  slug        String          @unique
  content     String          @db.LongText
  excerpt     String?
  authorId    Int
  status      BlogPost_status @default(DRAFT)
  publishedAt DateTime?
  createdAt   DateTime        @default(now())
  updatedAt   DateTime
  BlogComment BlogComment[]
  BlogImage   BlogImage[]
  BlogModule  BlogModule[]
  User        User            @relation(fields: [authorId], references: [id])

  @@index([authorId], map: "BlogPost_authorId_fkey")
  @@index([publishedAt])
  @@index([status])
}

model Poll {
  id             Int          @id @default(autoincrement())
  title          String
  description    String?      @db.Text
  moduleId       Int          @unique
  multipleChoice Boolean      @default(false)
  allowAnonymous Boolean      @default(false)
  endDate        DateTime?
  createdAt      DateTime     @default(now())
  updatedAt      DateTime
  PollOption     PollOption[]
  PollVote       PollVote[]

  @@index([endDate])
}

model PollOption {
  id       Int        @id @default(autoincrement())
  pollId   Int
  text     String
  order    Int        @default(0)
  Poll     Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  PollVote PollVote[]

  @@index([pollId], map: "PollOption_pollId_fkey")
}

model PollVote {
  id         Int        @id @default(autoincrement())
  pollId     Int
  optionId   Int
  userId     Int?
  ipAddress  String?
  createdAt  DateTime   @default(now())
  PollOption PollOption @relation(fields: [optionId], references: [id], onDelete: Cascade)
  Poll       Poll       @relation(fields: [pollId], references: [id], onDelete: Cascade)
  User       User?      @relation(fields: [userId], references: [id])

  @@unique([pollId, userId])
  @@index([optionId], map: "PollVote_optionId_fkey")
  @@index([pollId], map: "PollVote_pollId_fkey")
  @@index([userId], map: "PollVote_userId_fkey")
}

model MagicLinkToken {
  id        Int      @id @default(autoincrement())
  userId    Int
  token     String   @unique
  expiresAt DateTime
  used      Boolean  @default(false)
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([token])
  @@index([userId], map: "MagicLinkToken_userId_fkey")
  @@index([expiresAt])
}

model PushSubscription {
  id        Int      @id @default(autoincrement())
  userId    Int
  endpoint  String   @db.VarChar(500)
  p256dh    String   @db.Text
  auth      String
  createdAt DateTime @default(now())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@unique([userId, endpoint])
  @@index([userId])
}

enum TerminStatus {
  PENDING
  APPROVED
  DISCUSSING
  CANCELLED
}

enum AbstimmungsTyp {
  APPROVE
  NEED_INFO
}

enum Role {
  ADMIN
  USER
}

enum BlogModule_type {
  SLIDER
  IMAGE_GALLERY
  POLL
}

enum BlogPost_status {
  DRAFT
  PUBLISHED
  ARCHIVED
}
